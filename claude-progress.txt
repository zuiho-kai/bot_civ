# 项目进展

> 细节进展 → `server/progress.md` / `web/progress.md`
> 历史变更 → `docs/changelog.md`

## 当前状态

- **阶段**: M6.2 补丁包全部完成（P1~P4）
- **技术栈**: FastAPI + WebSocket | React + Vite | SQLite + NumPy + 硅基流动 Embedding API
- **仓库**: https://github.com/zuiho-kai/bot_civ
- **测试**: UT+E2E 283 passed, 11 skipped 全绿

## 原型需求差距评估（2026-02-20 设计终端产出）

### 原型完成度：~93%（M6.2 补丁包后）

| 原型需求 | 完成度 | 缺口 |
|----------|--------|------|
| 多 Agent 聊天群 | 100% | — |
| 唤醒机制（@提及+定时+小模型选人） | 100% | — |
| 发言频率控制+额度 | 100% | — |
| 信用点经济系统 | 100% | — |
| 页游城市（打卡/商店/建造/交易） | 95% | — |
| Agent 独立人格 | 100% | ✅ SOUL.md 深度人格已实现（M6.2-P2） |
| 短期/长期记忆 | 95% | M6.2-P1 LLM 摘要提取已实现，缺短→长自动升级 |
| 公共记忆 | 95% | M6.2-P4 种子数据 10~15 条已填充，幂等+自愈 |
| 悬赏任务 | 90% | M6.2-P3 Agent 自主接取已实现，缺前端集成+自动验证 |
| 游戏币（第二货币） | 0% | 原型阶段信用点够用，可延后 |
| 模型切换消耗信用点 | 0% | 锦上添花 |
| 头像装饰/皮肤 | 0% | 纯装饰性 |

### 剩余缺口（M6.2 后）

| 缺口 | 来源 | 影响 | 优先级 |
|------|------|------|--------|
| 短期→长期记忆自动升级 | 记忆系统 95%→100% | 高频/重要记忆不会沉淀，7 天后丢失 | 高 |
| 悬赏前端展示 + 自动验证 | 悬赏 90%→100% | 用户看不到接取状态，完成无法自动结算 | 高 |
| 页游城市收尾（建筑升级/队列） | 城市 95%→100% | 建造深度不够 | 中 |
| F31 策略自动机重做 | M6 冻结项 | 需独立调度循环，当前架构不支持 | 低（等 M6.3） |
| F33 代码执行沙箱 | M6 未开始 | Agent 无法写代码执行 | 低 |
| F34 长任务编排 | M6 未开始 | 多步计划无法持久化+自动推进 | 低（等 M6.3） |
| 游戏币（第二货币） | 原型 0% | 信用点够用，可延后 | 延后 |
| 模型切换消耗信用点 | 原型 0% | 锦上添花 | 延后 |
| 头像装饰/皮肤 | 原型 0% | 纯装饰 | 延后 |

### M6 完成度：~50%（F31 冻结，F32+F35 完成，F33+F34 未开始）

| M6 功能点 | 状态 | 说明 |
|-----------|------|------|
| F31 策略自动机 | ⏸ 冻结 | 半成品，见遗留。代码在 main + m6-p1.1-p1.2 分支 |
| F32 上网工具 | ✅ 完成 | web_search + web_fetch，254 UT 全绿，四轮独立 CR 归零 |
| F33 代码执行沙箱 | ❌ | Python 沙箱 |
| F34 长任务编排 | ❌ | 多步计划持久化+自动推进 |
| F35 Agent 状态可视化 | ✅ 完成 | 4 态徽章+行动日志+WS 广播，ST 13/13 全绿 |

### 建议优先级（如果继续做 M6）

1. F32 上网工具 — 最直观的"Agent 变聪明"体验
2. F35 状态可视化 — 演示效果好
3. F34 长任务编排 — 真正自主性，复杂度最高
4. F33 代码沙箱 — 锦上添花

## 最近活动

### 2026-02-22
- M6.2-P3（悬赏 Agent 自主接取）完成
  - 后端：bounty_service.py 新建（claim_bounty CAS 原子校验）+ autonomy_service 世界快照第 11 板块 + tool_registry claim_bounty 工具 + bounties.py API 重构
  - 测试：test_autonomy_unit.py 单元测试
- M6.2-P4（公共记忆知识库填充）完成
  - 后端：main.py seed_public_memories()（幂等差集 + begin_nested 单条失败跳过）+ data/public_memories.json 种子数据
  - 测试：test_seed_public_memories.py + test_st_seed_public_memories.py
- M6.2-P2（SOUL 深度人格）完成：283 passed, 11 skipped 全绿
  - 后端：Agent 表新增 personality_json JSON 列 + SoulPersonality Pydantic 模型（lenient 截断校验）+ SOUL_PROMPT_TEMPLATE 注入 system prompt + RunnerPool 缓存刷新可变字段
  - 前端：AgentCard 只读渲染 SOUL 人格（7 字段）+ relationships 超 3 对换行展示
  - 测试：29 UT（test_soul_personality.py）+ 7 E2E（test_soul_e2e.py）
  - CR 修复：get_or_create 缓存过期 personality_json → 刷新可变字段
  - 美学审核修复：行间距 2→4px、word-break、relationships 换行
  - 流程落盘：DEV-4×17 CR 复核规则 + DEV-39×2 美学独立 gate + checklist 第 11 条门控顺序
- M6.2-P1（记忆提取质量优化）完成：276 passed 全绿
  - 后端：_extract_memory 重写为 LLM 摘要 + fire-and-forget + fallback 链（gemma-3-12b → qwen2.5-7b → 截断兜底）

### 2026-02-21
- M6.2 全量代码走读完成（P1-P4 四个子阶段）

  **P1 记忆提取 — 从截断变 LLM 摘要**
  - chat.py:58-60 保留截断兜底 `conversation[:200]`，主路径走 `_llm_summarize()`（chat.py:80-131）
  - 最近 5 轮对话 → gemma-3-12b 摘要（100 字以内），超时 15s 自动切备用 qwen2.5-7b，全挂走截断
  - 关键判断（chat.py:107-109）：LLM 返回"无有效记忆"时跳过保存，过滤"哈哈""嗯嗯"等垃圾记忆
  - fire-and-forget（chat.py:182-185）：`_extract_memory` 丢进 `_background_tasks` set，不阻塞响应

  **P2 SOUL 深度人格 — 从一句话到结构化 prompt**
  - agent_runner.py:98-107 分支：有 personality_json 走 SOUL_PROMPT_TEMPLATE，否则走原模板
  - `_build_soul_block()`（agent_runner.py:51-69）格式化 dict → 核心价值观/说话风格/擅长领域/情感倾向/口头禅/关系/行为禁区
  - relationships 字段让 Agent 对特定人调整语气（如"又赊账？行吧老规矩记着"）
  - 缓存刷新（agent_runner.py:285-288）：personality_json 变更时原地更新 runner，不用旧缓存（CR 修出来的）

  **P3 悬赏自主接取 — Agent 能自己看悬赏板并抢单**
  - autonomy_service.py:196-212 世界快照第 11 板块，每小时 tick 时 LLM 看到开放/进行中悬赏
  - SYSTEM_PROMPT（autonomy_service.py:52）约束：同时只能接一个，接取前考虑自身能力和竞争概率
  - bounty_service.py:42-55 CAS 实现：一条 UPDATE 同时检查悬赏 open + 无人抢 + Agent 无进行中悬赏
  - rowcount==0 时查原因区分"被抢了"vs"你已有悬赏"（bounty_service.py:58-71）

  **P4 公共记忆种子数据**
  - public_memories.json 13 条世界规则（经济/生产链/社区公约/属性系统）
  - main.py `seed_public_memories()` 启动时按 content 差集插入，begin_nested() 包裹每条，部分失败不影响其他
  - UT 9/9 + ST 3/3 + 全量 266/266 全绿
  - CR 二次通过 P0=0 P1=0（P1×3 修复：savepoint 替代 delete、差集替代 count>0）
  - 归因落盘：DEV-6 扩展（跨文件 grep 外部 API 事务模式）+ DEV-47 新增（批量幂等考虑部分成功）

  **缺口**
  - 种子数据第 8 条"短期记忆自动升级为长期记忆"实际未实现（只是世界观设定，代码无升级机制）
  - 悬赏自动验证未做（只有接取没有交付闭环）
- M6 Phase 3（F35 Agent 状态可视化）完成：ST 13/13 全绿 + pytest 239/239 全绿
  - 后端：AgentStatus 4 态枚举 + status_helper 广播 + agent_runner/autonomy_service 状态生命周期
  - 前端：AgentStatusPanel 徽章 + ActivityFeed 10 种 action + DiscordLayout WS 处理
  - Code Review 2 轮（独立 agent），P0/P1/P2 全量归零
- M6.1 建造系统完成：ST 9/9 全绿 + pytest 211/211 全绿
  - 后端：`city_service.py`（建造配方+construct）、`city.py`（construct/constructing 路由）、`autonomy_service.py`（建筑快照动态工期）、`tool_registry.py`（construct_building 工具）
  - 前端：`CityPanel.tsx`（建造 UI）、`types.ts`/`api.ts`（类型+API）
  - Code Review 1 轮，P0/P1 归零（P1: 建筑快照硬编码工期 → 动态计算）
  - 新增 dev API: `set-resource`（ST 环境资源准备）

### 2026-02-20
- M5.2 交易市场完成：ST 16/16 全绿 + pytest 211/211 全绿
  - 后端：`market_service.py`（挂单/接单/撤单）、`city.py`（5 个 REST 路由）、`tool_registry.py`（3 个交易工具）
  - 前端：`TradePage.tsx`（交易市场 UI）、`types.ts`/`api.ts`（类型+API）
  - Code Review 2 轮（后端+前端），P0/P1 归零
  - 修复：`await db.commit()` 补全、`_map_error_status` 覆盖"只能"、AgentUpdate 加 stamina
  - 错题本：DEV-27 二次复犯（错误映射不全）、DEV-30 新增（ST 环境假设脆弱）

### 2026-02-19
- M5.1 资源转赠 + Tool Use 完成：ST 8/8 全绿
  - 后端：`tool_registry.py`（Tool Use 框架）、`agent_runner.py`（LLM tool_call 循环）、`autonomy_service.py`（Agent 自主转赠）、`city_service.py`（转赠事件广播）
  - 前端：`TradePage.tsx`（交易面板）、React Router 引入、API 包装、类型扩展
  - ST-1~4: 转赠成功/资源不足/WS 广播/数量校验
  - ST-5: Tool Use 端到端（真实 LLM，Agent 回复确认）
  - 修复：e2e 脚本 Agent 模型从 gpt-4o-mini 改为 stepfun/step-3.5-flash（MODEL_REGISTRY 匹配）

### 2026-02-18
- M5 记忆系统 + 城市经济全功能实现 + 真实 E2E 验证
- M4 Agent 自主行为 — 后端引擎 + 前端展示 + E2E 验证
  - 修复：模型切换 + prompt 精简 + reasoning fallback
  - Gap Closure: 9 E2E + 10 单元测试

### 2026-02-17
- M3 城市经济闭环 — 工作/商店/前端 + Code Review 修复
- M3 体验问题修复 5 项（悬赏表单 UI、Agent dropdown 搜索、颜色主题变量化等）

### 2026-02-16
- M2 Phase 6 完成：E2E 端到端验证 14/14 全绿
  - REST 场景 8/8 + LLM 场景 6/6
- M2 Phase 3-5 完成：记忆注入、经济系统、悬赏、批量唤醒、前端 UI

## 里程碑

- M1 ✅: Agent CRUD + WebSocket 聊天 + 唤醒引擎 + LLM 集成
- M1.5 ✅: OpenClaw Plugin（TypeScript，openclaw-plugin/ 子目录）
- M2 ✅: 记忆与经济系统（Phase 1-6，14/14 E2E 全绿）
- M3 ✅: 城市经济闭环 + 体验修复
- M4 ✅: Agent 自主行为（E2E 验证通过）
- M5 ✅: 记忆系统 + 城市经济（全功能 + E2E 验证）
- M5.1 ✅: 资源转赠 + Tool Use（ST 8/8 全绿）
- M5.2 ✅: 交易市场（挂单/接单/撤单，ST 16/16 全绿）
- M6.1 ✅: 建造系统（建造/工期/建造中列表，ST 9/9 全绿）
- M6-P2 ✅: F32 上网工具（web_search + web_fetch，254 UT 全绿，四轮独立 CR 归零）
- M6-P3 ✅: F35 Agent 状态可视化（4 态徽章+行动日志+WS 广播，ST 13/13 全绿）
- M6.2-P1 ✅: 记忆提取质量优化（LLM 摘要 + fire-and-forget + fallback 链，276 passed）
- M6.2-P2 ✅: SOUL 深度人格（personality_json 7 字段 + prompt 注入 + 缓存刷新，283 passed）
- M6.2-P3 ✅: 悬赏 Agent 自主接取（bounty_service + 世界快照 + CAS 原子竞争 + tool_registry）
- M6.2-P4 ✅: 公共记忆知识库填充（种子数据 JSON + 幂等差集 + 单条失败自愈）
- M6 待定: Agent CLI 运行时（持久进程 + 上网 + 任意工具）

## 遗留

- [ ] CSS 硬编码清理 + stylelint 规则 + 设计 token 规划文档
- [ ] Cat Cafe 风格主题（浅绿/米色暖色调、圆角卡片）
- [ ] Radix UI 按需引入（复杂交互时试点）
- [ ] Tailwind CSS 评估（组件数涨到 50+ 时重新评估）
- [ ] SSE 改造（等 Redis Pub/Sub 一起做）
- [ ] **F31 策略系统重做**（当前半成品，冻结中）
  - 现状：4 种策略（keep_working/opportunistic_buy/price_target/stockpile）+ priority/TTL，代码在 main 上
  - 问题：策略执行绑在每小时 LLM tick 里，两层架构退化成一层，ROI 为负（DEV-40）
  - 缺失：独立调度（策略需要秒级/分钟级执行，当前只有小时级 tick）、持久化（内存存储重启丢失）、事件驱动（price_target/opportunistic_buy 需要响应市场事件）
  - 失败原因：功能设计脱离基础设施现实 — 设计了高频操盘/囤货策略，但跑在每小时一次的轮询上
  - 重做前提：先有独立调度循环或事件驱动架构，再重新设计策略类型
  - 参考：postmortem-dev-40.md、两份 PM 评审意见（独立 PM + 人类替身 PM 均建议先改调度再做策略）
