# 项目进展

> 细节进展 → `server/progress.md` / `web/progress.md`
> 历史变更 → `docs/changelog.md`

## 当前状态

- **阶段**: M6 Phase 1.1 完成（策略系统半成品，已冻结，见遗留）
- **技术栈**: FastAPI + WebSocket | React + Vite | SQLite + NumPy + 硅基流动 Embedding API
- **仓库**: https://github.com/zuiho-kai/bot_civ
- **测试**: UT 254/254 全绿 + M6 ST 15/15 不回归

## 原型需求差距评估（2026-02-20 设计终端产出）

### 原型完成度：~85%

| 原型需求 | 完成度 | 缺口 |
|----------|--------|------|
| 多 Agent 聊天群 | 100% | — |
| 唤醒机制（@提及+定时+小模型选人） | 100% | — |
| 发言频率控制+额度 | 100% | — |
| 信用点经济系统 | 100% | — |
| 页游城市（打卡/商店/建造/交易） | 95% | — |
| Agent 独立人格 | 90% | 缺 SOUL.md 级深度人格 |
| 短期/长期记忆 | 90% | 缺短→长自动升级 |
| 公共记忆 | 80% | 框架有，知识库内容空 |
| 悬赏任务 | 70% | 后端有，缺前端集成+自动验证 |
| 游戏币（第二货币） | 0% | 原型阶段信用点够用，可延后 |
| 模型切换消耗信用点 | 0% | 锦上添花 |
| 头像装饰/皮肤 | 0% | 纯装饰性 |

### M6 完成度：~20%（F31 策略系统冻结，其余未开始）

| M6 功能点 | 状态 | 说明 |
|-----------|------|------|
| F31 策略自动机 | ⏸ 冻结 | 半成品，见遗留。代码在 main + m6-p1.1-p1.2 分支 |
| F32 上网工具 | 📋 SR 已写 | SR-M6-Phase2.md（设计终端产出） |
| F33 代码执行沙箱 | ❌ | Python 沙箱 |
| F34 长任务编排 | ❌ | 多步计划持久化+自动推进 |
| F35 Agent 状态可视化 | ❌ | 前端状态徽章+行动日志 |

### 建议优先级（如果继续做 M6）

1. F32 上网工具 — 最直观的"Agent 变聪明"体验
2. F35 状态可视化 — 演示效果好
3. F34 长任务编排 — 真正自主性，复杂度最高
4. F33 代码沙箱 — 锦上添花

## 最近活动

### 2026-02-21
- M6.1 建造系统完成：ST 9/9 全绿 + pytest 211/211 全绿
  - 后端：`city_service.py`（建造配方+construct）、`city.py`（construct/constructing 路由）、`autonomy_service.py`（建筑快照动态工期）、`tool_registry.py`（construct_building 工具）
  - 前端：`CityPanel.tsx`（建造 UI）、`types.ts`/`api.ts`（类型+API）
  - Code Review 1 轮，P0/P1 归零（P1: 建筑快照硬编码工期 → 动态计算）
  - 新增 dev API: `set-resource`（ST 环境资源准备）

### 2026-02-20
- M5.2 交易市场完成：ST 16/16 全绿 + pytest 211/211 全绿
  - 后端：`market_service.py`（挂单/接单/撤单）、`city.py`（5 个 REST 路由）、`tool_registry.py`（3 个交易工具）
  - 前端：`TradePage.tsx`（交易市场 UI）、`types.ts`/`api.ts`（类型+API）
  - Code Review 2 轮（后端+前端），P0/P1 归零
  - 修复：`await db.commit()` 补全、`_map_error_status` 覆盖"只能"、AgentUpdate 加 stamina
  - 错题本：DEV-27 二次复犯（错误映射不全）、DEV-30 新增（ST 环境假设脆弱）

### 2026-02-19
- M5.1 资源转赠 + Tool Use 完成：ST 8/8 全绿
  - 后端：`tool_registry.py`（Tool Use 框架）、`agent_runner.py`（LLM tool_call 循环）、`autonomy_service.py`（Agent 自主转赠）、`city_service.py`（转赠事件广播）
  - 前端：`TradePage.tsx`（交易面板）、React Router 引入、API 包装、类型扩展
  - ST-1~4: 转赠成功/资源不足/WS 广播/数量校验
  - ST-5: Tool Use 端到端（真实 LLM，Agent 回复确认）
  - 修复：e2e 脚本 Agent 模型从 gpt-4o-mini 改为 stepfun/step-3.5-flash（MODEL_REGISTRY 匹配）

### 2026-02-18
- M5 记忆系统 + 城市经济全功能实现 + 真实 E2E 验证
- M4 Agent 自主行为 — 后端引擎 + 前端展示 + E2E 验证
  - 修复：模型切换 + prompt 精简 + reasoning fallback
  - Gap Closure: 9 E2E + 10 单元测试

### 2026-02-17
- M3 城市经济闭环 — 工作/商店/前端 + Code Review 修复
- M3 体验问题修复 5 项（悬赏表单 UI、Agent dropdown 搜索、颜色主题变量化等）

### 2026-02-16
- M2 Phase 6 完成：E2E 端到端验证 14/14 全绿
  - REST 场景 8/8 + LLM 场景 6/6
- M2 Phase 3-5 完成：记忆注入、经济系统、悬赏、批量唤醒、前端 UI

## 里程碑

- M1 ✅: Agent CRUD + WebSocket 聊天 + 唤醒引擎 + LLM 集成
- M1.5 ✅: OpenClaw Plugin（TypeScript，openclaw-plugin/ 子目录）
- M2 ✅: 记忆与经济系统（Phase 1-6，14/14 E2E 全绿）
- M3 ✅: 城市经济闭环 + 体验修复
- M4 ✅: Agent 自主行为（E2E 验证通过）
- M5 ✅: 记忆系统 + 城市经济（全功能 + E2E 验证）
- M5.1 ✅: 资源转赠 + Tool Use（ST 8/8 全绿）
- M5.2 ✅: 交易市场（挂单/接单/撤单，ST 16/16 全绿）
- M6.1 ✅: 建造系统（建造/工期/建造中列表，ST 9/9 全绿）
- M6 待定: Agent CLI 运行时（持久进程 + 上网 + 任意工具）

## 遗留

- [ ] CSS 硬编码清理 + stylelint 规则 + 设计 token 规划文档
- [ ] Cat Cafe 风格主题（浅绿/米色暖色调、圆角卡片）
- [ ] Radix UI 按需引入（复杂交互时试点）
- [ ] Tailwind CSS 评估（组件数涨到 50+ 时重新评估）
- [ ] SSE 改造（等 Redis Pub/Sub 一起做）
- [ ] **F31 策略系统重做**（当前半成品，冻结中）
  - 现状：4 种策略（keep_working/opportunistic_buy/price_target/stockpile）+ priority/TTL，代码在 main 上
  - 问题：策略执行绑在每小时 LLM tick 里，两层架构退化成一层，ROI 为负（DEV-40）
  - 缺失：独立调度（策略需要秒级/分钟级执行，当前只有小时级 tick）、持久化（内存存储重启丢失）、事件驱动（price_target/opportunistic_buy 需要响应市场事件）
  - 失败原因：功能设计脱离基础设施现实 — 设计了高频操盘/囤货策略，但跑在每小时一次的轮询上
  - 重做前提：先有独立调度循环或事件驱动架构，再重新设计策略类型
  - 参考：postmortem-dev-40.md、两份 PM 评审意见（独立 PM + 人类替身 PM 均建议先改调度再做策略）
