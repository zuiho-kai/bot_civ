# 文档防丢失机制 — 规则制定详细记录

**日期**：2025-02-14
**议题**：如何防止重要信息只存在对话中，确保知识持久化
**参与者**：用户、架构师、记录员
**流程**：用户发现问题 → 制定防丢失规则 → 执行补救措施

---

## 背景和需求

用户在回顾项目时，发现一个严重问题：

**问题**：原始项目需求、设计思路、技术决策只存在对话中，没有持久化到文件

**风险**：
1. 对话历史可能丢失（终端关闭、断电、会话过期）
2. 新成员无法快速了解项目背景
3. 无法回溯为什么做出某个决策
4. 重要信息散落在多次对话中，难以查找

**核心问题**：如何确保重要信息持久化到文件？

---

## 核心原则

### 对话是临时的，文件是持久的

**对话的特点**：
- 临时性：会话结束后可能丢失
- 分散性：信息散落在多次对话中
- 难以检索：无法快速查找特定信息

**文件的特点**：
- 持久性：存储在磁盘上，不会丢失
- 集中性：相关信息集中在一个文件中
- 易于检索：可以用搜索工具快速查找

**结论**：任何重要信息都必须落盘到文件

---

## 防丢失规则

### 规则1：用户的原始需求、设计思路必须写入 `docs/PRD.md`

**必须记录的内容**：
1. 项目愿景和目标
2. 核心概念和术语
3. 功能需求列表
4. 非功能需求（性能、安全、可用性等）
5. 用户故事和使用场景
6. 设计思路和理念

**记录时机**：
- 用户提出新需求时，立即记录
- 需求变更时，及时更新
- 不能拖延到下次会话

---

### 规则2：每个技术决策必须同时记录到 `claude-progress.txt` 和 `docs/PRD.md`

**技术决策包括**：
- 技术栈选型（框架、语言、数据库等）
- 架构设计决策
- 重要的实现方案选择
- 被否决的方案和原因

**记录位置**：
- `claude-progress.txt`：简要记录决策和原因（项目经理视角）
- `docs/PRD.md`：详细记录决策背景、考量因素、最终选择（产品视角）
- `docs/discussions/`：完整记录辩论过程（归档视角）

**为什么要同时记录？**
- `claude-progress.txt`：快速查看项目进展
- `docs/PRD.md`：完整了解产品设计
- `docs/discussions/`：深入了解决策过程

---

### 规则3：新的设计讨论结论必须及时持久化到文件

**讨论类型**：
- 辩论（三方辩论）
- 协作讨论（多方协作）
- 用户直接决策

**记录要求**：
- 讨论结束后立即记录
- 不能只记录结论，必须记录过程
- 使用标准模板（见 `docs/discussions.md`）

---

## 执行的补救措施

### 1. 创建 `docs/PRD.md`

**内容**：
- 项目愿景：AI驱动的数字生命体城市模拟
- 核心概念：Agent、记忆系统、经济系统、社交系统
- 功能需求：Agent创建、群聊、记忆检索、经济系统等
- 技术决策：FastAPI + React、SQLite + LanceDB、双货币体系等

**目的**：
- 集中记录所有产品相关信息
- 新成员可以通过阅读PRD快速了解项目

---

### 2. 更新 `CLAUDE.md`

**新增内容**：
- 防丢失规则（三条规则）
- 文件管理约定（明确各文件的用途和更新频率）

**目的**：
- 确保所有Agent都遵守防丢失规则
- 明确文件管理职责

---

### 3. 补充历史讨论记录

**任务**：
- 为所有历史辩论创建详细记录文件
- 更新 `docs/discussions.md` 索引

**目的**：
- 补救之前的记录缺失
- 建立完整的决策历史

---

## 文件管理约定

| 文件 | 用途 | 更新频率 | 上下文负担 |
|------|------|----------|-----------|
| `CLAUDE.md` | 主索引（本文件） | 很少更新，仅当流程变更时 | 低（已精简） |
| `claude-progress.txt` | **项目总进展**（只记录大里程碑） | 大里程碑完成时更新 | 低（项目经理级别） |
| `server/progress.md` | **后端详细进展**（API、数据库、WebSocket 等） | 后端每完成功能时更新 | 中（后端开发者视角） |
| `web/progress.md` | **前端详细进展**（组件、UI、路由等） | 前端每完成功能时更新 | 中（前端开发者视角） |
| `docs/discussions.md` | **讨论摘要索引**（简短摘要 + 链接） | 每次讨论后更新 | 低（仅摘要） |
| `docs/discussions/YYYY-MM-DD-*.md` | **详细讨论记录**（完整过程归档） | 每次讨论后创建 | 高（按需加载） |
| `docs/PRD.md` | 产品需求文档（原始需求 + 设计思路 + 技术决策） | 需求变更时更新 | 中 |

---

## 为什么这些规则有效？

### 1. 分层管理，减少上下文负担

**问题**：如果所有信息都记录在一个文件中，文件会变得非常长，增加上下文负担

**解决方案**：
- 摘要索引（`discussions.md`）：快速浏览
- 详细记录（`discussions/YYYY-MM-DD-*.md`）：按需加载
- 进展记录（`claude-progress.txt`）：只记录大里程碑

---

### 2. 强制记录，避免遗忘

**问题**：讨论结束后，容易忘记记录

**解决方案**：
- 明确记录时机（讨论结束后立即记录）
- 明确记录责任（记录员负责）
- 明确记录模板（标准化格式）

---

### 3. 多处记录，不同视角

**问题**：不同角色需要不同粒度的信息

**解决方案**：
- 项目经理：看 `claude-progress.txt`（大里程碑）
- 产品经理：看 `docs/PRD.md`（产品设计）
- 开发者：看 `server/progress.md` 或 `web/progress.md`（实现细节）
- 决策者：看 `docs/discussions/`（决策过程）

---

## 下一步行动

1. ✅ 创建 `docs/PRD.md`
2. ✅ 更新 `CLAUDE.md`（新增防丢失规则）
3. ✅ 为所有历史讨论创建详细记录文件
4. ✅ 更新 `docs/discussions.md` 索引
5. 在后续工作中严格执行防丢失规则

---

## 关键决策点

- ✅ 确立"对话是临时的，文件是持久的"原则
- ✅ 用户需求必须写入 `docs/PRD.md`
- ✅ 技术决策必须同时记录到 `claude-progress.txt` 和 `docs/PRD.md`
- ✅ 讨论结论必须及时持久化
- ✅ 分层管理文件，减少上下文负担
