# 常见错误案例合集

> 本文件包含两部分：跨角色的通用错误 + 各角色错题本索引。

### 记录规则

- **COMMON 条目只写核心规则**（❌/✅/一句话解释），控制在 5 行以内
- **实际案例**最多附 2-3 行摘要，不展开完整时间线或方案清单
- **详细复盘**放独立 postmortem 文件或对应角色错题本，这里只放链接
- **目的**：所有角色加载通用错误时控制在 ~150 行，有新条目可适当放宽，但每条仍须遵守上面的精简规则

---

## 角色错题本索引

| 角色 | 错题本 | 覆盖范围 |
|------|--------|---------|
| 💻 开发者 | [error-book-dev.md](error-book-dev.md) | 前后端协作、代码实施、环境踩坑 |
| 📋 项目经理 | [error-book-pm.md](error-book-pm.md) | 进度记录、里程碑同步、上下文管理 |
| 🏗️ 架构师 / ⚖️ 讨论专家 | [error-book-debate.md](error-book-debate.md) | 讨论流程、方案设计、决策记录 |
| 🧪 QA Lead | [error-book-qa.md](error-book-qa.md) | 测试设计、测试执行、Bug 报告 |
| 📝 记录员 | [error-book-recorder.md](error-book-recorder.md) | 讨论落盘、索引维护、信息去重 |

---

## 通用错误（所有角色适用）

### COMMON-1 对话是临时的，文件是持久的

❌ 讨论完直接告诉用户结论，没有写文件
✅ 任何重要讨论/决策/进展，必须落盘到对应文件
> 对话丢了就没了，文件才是持久记忆。

### COMMON-2 多个文件记录同一信息

❌ 文档结构在 CLAUDE.md 写一遍，claude-progress.txt 又写一遍
✅ 只在一个地方维护，其他地方放链接
> 信息只有一个 source of truth，重复 = 不一致风险。

### COMMON-3 详细内容放在索引文件里

❌ discussions.md 里放完整的讨论过程（几百行）
✅ 索引文件只放表格/链接，详细内容在独立文件里
> 索引文件要轻，详细内容按需加载。

### COMMON-4 改了内容没更新索引

❌ 新建了文件，但 CLAUDE.md / discussions.md 等索引没加条目
✅ 新建文件的同时，更新所有相关索引
> 没索引 = 找不到 = 不存在。

### COMMON-5 角色越界操作

❌ 后端终端改前端文件、记录员做架构决策、PM 直接改代码
✅ 每个角色只做自己职责范围内的事，需要跨界时通知对应角色
> 职责分离是多 Agent 协作的基础。

### COMMON-6 跨模块语义假设不一致

❌ 模块A改变了核心概念的含义（如"Agent在线"从"有WebSocket连接"变成"服务端驱动"），但依赖该概念的模块B没有同步更新
✅ 当架构决策改变了某个概念的语义时，必须回溯所有依赖该概念的模块，更新其前提假设
> 典型案例：方案G改变了Agent存在方式，但唤醒服务的"在线"定义没跟着更新（DEV-BUG-5）。TDD中应明确列出跨模块依赖假设。

### COMMON-7 主 Agent 直接做低复杂度任务

❌ 索引同步、链接更新、进度记录等简单任务，主 Agent（Opus/Sonnet）亲自逐个文件读+改
✅ 派子 Agent 处理：`Task(model="haiku")` 做文档编辑/索引同步/链接更新/进度记录，`Task(model="sonnet")` 做需要理解上下文的简单修改
> 主 Agent 是调度器，不是执行器。格式化任务（添加索引、更新链接、记录进度）必须用 haiku 子 agent，省 token 省成本。参考 [模型选择策略](model-selection.md)。

**实际案例**：主 Agent（Sonnet）亲自做索引编辑，应派 `Task(model="haiku")` 处理，成本差 3-5 倍。

### COMMON-8 技术选型的隐含约束全链路漏检

❌ 选择技术栈（如 SQLite）时只评估功能匹配度，没有列出该技术在项目场景下的隐含约束（如并发写入必须 BEGIN IMMEDIATE），导致从需求→架构→TDD→Code Review→测试全链路无人看护
✅ 技术选型时必须产出**约束清单**，写入架构文档，并在 TDD、Code Review checklist、测试用例中逐层体现
> 隐含约束不会在单连接/happy path 中暴露，只在真实并发场景才爆炸。如果选型时不主动挖掘，后续每个环节都会默认"没问题"。

**全链路看护**：各角色具体检查项见 DEBATE-5、QA-5、PM-5、REC-6。

**实际案例**（DEV-BUG-7，耗时 2h+，200 刀）：SQLite 需要 BEGIN IMMEDIATE 才能安全并发，五个环节全部漏检，直到 e2e 才暴露。

### COMMON-9 "我觉得我懂"陷阱 — 连续猜方案不搜索

❌ 看到熟悉的错误信息（如 "database is locked"），凭已有知识连续尝试多个方案，每次失败后换下一个"我知道的"方案
✅ **两次失败后必须停下来搜索根因**，不要继续猜
> "知道一点"比"完全不知道"更危险。如果完全不懂会去搜索，但"觉得自己懂"会跳过搜索直接动手，在表面原因上反复打转。

**三步止血规则（遇到不熟悉的技术问题时）**:
1. **先搜索，不要猜**（5 分钟上限）: 遇到明确错误信息，第一步搜索 "[技术栈] + [错误信息]"，大多数常见问题都有现成答案
2. **最小脚本验证，不要跑完整流程**（省 80% token）: 写 10 行脚本复现问题并验证方案，不要每次都启动完整服务 + 跑 e2e
3. **两次失败后停下来重新思考**（硬性规则）: 连续两个方案失败 = 对问题的理解有误，必须重新分析根因

**实际案例**（DEV-BUG-7，200 刀）：连续 9 个方案失败，第 10 次才搜索，5 分钟找到答案。第 2 次就搜可省 180 刀。

### COMMON-10 修复引入新问题 — 局部修复思维

❌ 改 bug 时只盯着 bug 点，不检查改动对周围代码的影响，导致修复本身引入新的 P1 问题，review 循环 4 轮才归零
✅ 每次修复前做影响面分析：grep 所有引用点、追踪下游消费者、做涟漪推演，目标 review ≤2 轮
> 改变一个变量的赋值语义，就改变了所有依赖它的代码的行为。不做影响面分析 = 盲改。

### COMMON-11 新增内容不查文档存放规则，直接塞索引文件

❌ 把具体内容（如"前端 Gemini UI 设计流程"）直接加到 CLAUDE.md 主干，没有查文档速查确认归属位置
✅ 新增内容前先对照 CLAUDE.md 文档速查 + 核心规则，确认该放哪个文件再动手
> CLAUDE.md 是索引和规则，不是内容垃圾桶。角色相关放 `docs/personas/`，功能相关放 `docs/specs/`，讨论放 `docs/discussions/`。

**防范 checklist**:
1. 拿到"记录/存放"类任务时，先读 CLAUDE.md 文档速查段落
2. 确认内容归属：角色？功能？讨论？进度？
3. 找到对应文件，读一遍现有结构，再追加

**检查清单**：grep 引用点 → 追踪下游消费者 → 确认语义仍成立 → 用显式代码结构保安全 → 自问"哪些下游行为会变？"

**实际案例**（M2-3/4，4 轮 review）：`self.context` 从增量改覆盖导致 append 变死代码，`broadcast` 用无条件 `pop` 靠隐式假设保安全。本应 2 轮完成。

### COMMON-12 教训口头说而不是直接落盘

❌ 发现流程改进点后口头说"以后会这样做"，等用户提醒才去写文件
✅ 任何教训/流程改进，发现的当下直接写入对应文件（CLAUDE.md / 错题本 / common-mistakes），不做口头承诺
> 口头承诺 = 重启后丢失 = 不存在。这是 COMMON-1 的特例：不只是讨论结论要落盘，流程改进本身也要落盘。

### COMMON-13 ST 测试调试循环低效 — 缺少 dev 快捷通道

❌ ST 测试时反复加 print → 重启 → 看不到输出 → 改返回值 → 等 reload → 改阈值，一个验证点耗费 10+ 轮
✅ dev endpoint 内建 `?debug=1` 返回中间状态；阈值可通过 dev API 覆盖；统一尾部斜杠约定
> 调试基础设施的时间 > 验证时间 = 流程有问题。详见 [postmortem-common-13.md](../postmortems/postmortem-common-13.md)

### COMMON-14 写错题本时不回读记录规则，反复超标被打回

❌ 觉得自己记得格式，直接写一大段到错题本，被指出后才精简——已重复犯 2 次
✅ 写错题本前先读文件顶部的"记录规则"段落，确认行数上限，再动手写
> COMMON-9 变体："我觉得我懂格式" = 不去确认 = 每次超标。

### COMMON-15 Phase 实现后跳过 Code Review 直接进入下一步

❌ Phase 写完 → 直接更新进度 → 准备下一步，被用户提醒才回头做 Review
✅ Phase 写完 → Code Review → 修复循环至 P0/P1 归零 → 才能更新进度或进入下一步
> 已写入 CLAUDE.md 工作流强制门禁。Code Review 不是可选步骤，是出口条件。

### COMMON-16 静默失败链路 — 关键分支只 log 不报错，调试时无从定位

❌ `resolve_model` 返回 None → 调用方 `return None, None` → 外层也不报错 → 整条链路静默，E2E 只看到"没回复"
✅ 关键分支失败时日志带上下文（谁、查什么、为什么失败），dev endpoint 加 `?debug=1` 返回中间状态
> 静默失败是调试时间的最大放大器。案例：DEV-BUG-12，详见 [postmortem](../postmortems/postmortem-dev-bug-12.md)

---
角色专属错误追加到对应角色的错题本，格式：

```markdown
### [角色前缀]-[编号] 简短标题

❌ 错误做法
✅ 正确做法
> 一句话解释为什么。
```

实际 Bug 踩坑：

```markdown
### [角色前缀]-BUG-[编号] 简短标题

- **场景**: 什么情况下触发
- **现象**: 看到了什么
- **原因**: 根因是什么
- **修复**: 怎么解决的
```
