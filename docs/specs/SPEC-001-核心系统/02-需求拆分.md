# 02-éœ€æ±‚æ‹†åˆ†

> é‡Œç¨‹ç¢‘å®šä¹‰ã€ä»»åŠ¡åˆ†è§£ã€è¯„å®¡ç»“è®ºã€è®¨è®ºæ‘˜è¦ã€‚

---

## é‡Œç¨‹ç¢‘æ€»è§ˆ

| é‡Œç¨‹ç¢‘ | ç›®æ ‡ | çŠ¶æ€ |
|--------|------|------|
| M1 â€” èƒ½è·‘èµ·æ¥ | Agent èƒ½èŠå¤©ï¼Œäººç±»å‘æ¶ˆæ¯ â†’ Agent è‡ªåŠ¨å›å¤ | âœ… å®Œæˆ |
| M1.5 â€” Bot æ¥å…¥ | å¹³å°æ”¹ä¸º Discord æ¨¡å¼ï¼ŒAgent åƒ Bot ä¸€æ ·æ¥å…¥ï¼ŒOpenClaw éªŒè¯ | ğŸ“‹ å·²æ‹†åˆ† |
| M2 â€” æœ‰è®°å¿†æœ‰ç»æµ | è®°å¿†ç³»ç»Ÿ + ç»æµç³»ç»Ÿ + æ‚¬èµä»»åŠ¡ | âœ… å®Œæˆ |
| M3 â€” åŸå¸‚ç»æµé—­ç¯ | å·¥ä½œæ‰“å¡ + è™šæ‹Ÿå•†åº— + åŸå¸‚ UI | âœ… å®Œæˆ |
| M4 â€” Agent è‡ªä¸»è¡Œä¸º | ä¸–ç•ŒçŠ¶æ€é©±åŠ¨å†³ç­– + è‡ªä¸»è¡Œä¸ºå¼•æ“ + åŠ¨æ€ Feed | âœ… å®Œæˆ |
| M5 â€” è®°å¿†ç³»ç»Ÿ + åŸå¸‚ç»æµ | å»ºç­‘ç”Ÿäº§ + ä¸‰ç»´å±æ€§ + ä»¥ç‰©æ˜“ç‰©äº¤æ˜“ + è®°å¿†ç®¡ç† | âœ… å®Œæˆ |
| M5.1 â€” èµ„æºè½¬èµ  + Tool Use | Agent Tool Use æ¶æ„ + èµ„æºè½¬èµ å®Œå–„ + äº¤æ˜“é¢æ¿ + React Router | âœ… å®Œæˆ |
| M5.2 â€” äº¤æ˜“å¸‚åœº | æŒ‚å•/æ¥å•/æ’¤å• + autonomy_loop + Tool Use + å‰ç«¯å¸‚åœºé¢æ¿ | ğŸ“‹ å·²æ‹†åˆ† |

---

## M1 â€” èƒ½è·‘èµ·æ¥ï¼ˆâœ… å·²å®Œæˆï¼‰

### ä»»åŠ¡åˆ†è§£

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| #1 | Agent CRUD å®Œå–„ + WebSocket èŠå¤© | åç«¯ | æ—  | âœ… done |
| #2 | å”¤é†’/æ„å›¾è¯†åˆ«è§„åˆ™å¼•æ“ | åç«¯ | #1 | âœ… done |
| #3 | æ¨¡æ‹Ÿæ¶ˆæ¯è§¦å‘å™¨ï¼ˆæµ‹è¯•ç”¨ï¼‰ | åç«¯ | #1 | âœ… done |
| #4 | èŠå¤©ç•Œé¢ + WebSocket è¿æ¥ | å‰ç«¯ | æ—  | âœ… done |
| #5 | LLM é›†æˆï¼ˆ@å¿…å”¤ + å°æ¨¡å‹é€‰äººï¼‰ | åç«¯ | #2 | âœ… done |
| #6 | Agent åˆ—è¡¨/åˆ›å»ºé¡µé¢ | å‰ç«¯ | #4 | âœ… done |
| #7 | è”è°ƒéªŒè¯ï¼ˆç«¯åˆ°ç«¯èŠå¤©è·‘é€šï¼‰ | é›†æˆ | #5, #6 | âœ… done |

**å…³é”®è·¯å¾„**: #1 â†’ #2 â†’ #5 â†’ #7

### M1 éªŒæ”¶æ ‡å‡†ï¼ˆå·²é€šè¿‡ï¼‰
- Human å‘æ¶ˆæ¯ â†’ @Agent â†’ Agent è‡ªåŠ¨å›å¤ â†’ æ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥
- å‰ç«¯ Discord é£æ ¼å››æ å¸ƒå±€æ­£å¸¸æ˜¾ç¤º
- WebSocket è¿æ¥çŠ¶æ€æ˜¾ç¤º"å·²è¿æ¥"
- æ¶ˆæ¯åˆ†ç»„ï¼ˆåŒä¸€å‘é€è€…è¿ç»­æ¶ˆæ¯æŠ˜å å¤´åƒï¼‰æ­£å¸¸å·¥ä½œ

---

## M1.5 â€” Bot æ¥å…¥ï¼ˆå·²æ‹†åˆ†ï¼Œè¯„å®¡é€šè¿‡ï¼‰

### ç›®æ ‡

æŠŠå¹³å°ä»"æœåŠ¡ç«¯æ›¿ Agent è¯´è¯"æ”¹ä¸º"Agent åƒ Discord Bot ä¸€æ ·è‡ªä¸»æ¥å…¥"ã€‚æ ¸å¿ƒè½¬å˜ï¼š

```
M1ï¼ˆæœåŠ¡ç«¯é©±åŠ¨ï¼‰ï¼š
  Human å‘æ¶ˆæ¯ â†’ æœåŠ¡ç«¯å”¤é†’ â†’ æœåŠ¡ç«¯è°ƒ LLM â†’ æœåŠ¡ç«¯å‘å›å¤

M1.5ï¼ˆBot æ¥å…¥ï¼‰ï¼š
  Human å‘æ¶ˆæ¯ â†’ å¹³å°å¹¿æ’­äº‹ä»¶ â†’ Bot æ”¶åˆ°äº‹ä»¶ â†’ Bot è‡ªå·±å†³å®šå›ä¸å› â†’ Bot è°ƒ API å‘æ¶ˆæ¯
  ï¼ˆBot ä¸åœ¨çº¿æ—¶ fallback åˆ° M1 è€è·¯å¾„ï¼Œä¿è¯ä¸æ²‰é»˜ï¼‰
```

### è¯„å®¡ç»“è®º

**Goï¼Œå¸¦æ¡ä»¶ï¼ˆ2025-01 è¯„å®¡é€šè¿‡ï¼‰ï¼š**

1. ~~SDK ä» M1.5 æ‹†å‡º~~ â€” M1.5 åªåšå¹³å°æ”¹é€  + è£¸ WebSocket è„šæœ¬éªŒè¯ï¼ŒSDK å°è£…åç»­å†åš
2. è¡¥å……å¿ƒè·³æœºåˆ¶ï¼ˆping/pongï¼Œ30s è¶…æ—¶è§†ä¸ºæ–­çº¿ï¼‰
3. bot_token æ ¼å¼åŠ  `oc_` å‰ç¼€
4. wakeup_service ä¿ç•™ä¸º fallback â€” Bot åœ¨çº¿æ—¶è·³è¿‡ï¼Œä¸åœ¨çº¿æ—¶èµ°è€è·¯å¾„

### å…³é”®å†³ç­–

| é—®é¢˜ | å†³ç­– | ç†ç”± |
|------|------|------|
| wakeup_service å»ç•™ | ä¿ç•™ä¸º fallback | Bot åœ¨çº¿æ—¶è·³è¿‡ï¼Œä¸åœ¨çº¿èµ°è€è·¯å¾„ï¼Œé¿å…å…¨åœºæ²‰é»˜ |
| since_id å¢é‡æ‹‰å– | æ”¹ç°æœ‰ GET /api/messages åŠ å‚æ•° | Bot é‡è¿åè¡¥æ‹‰æ–­çº¿æœŸé—´æ¶ˆæ¯ |
| åŒä¸€ agent_id é‡å¤è¿æ¥ | è¸¢æ—§ | Bot å´©æºƒé‡å¯åèƒ½ç«‹å³é‡è¿ï¼Œä¸è¢«åƒµå°¸è¿æ¥æŒ¡ä½ |

### ç°æœ‰åŸºç¡€

- âœ… WebSocket Hub å·²æœ‰ï¼ˆchat.pyï¼‰ï¼Œéœ€æ”¹é€ ä¸ºæ”¯æŒ Bot è¿æ¥
- âœ… Agent CRUD API å·²æœ‰
- âœ… æ¶ˆæ¯æŒä¹…åŒ–å·²æœ‰
- âœ… å‰ç«¯ WebSocket è¿æ¥å·²æœ‰ï¼ˆäººç±»ç”¨æˆ·ä¾§ä¸å˜ï¼‰
- âŒ æ—  Bot è®¤è¯æœºåˆ¶ â€” éœ€æ–°å¢ bot_token
- âŒ æ—  Bot è¿æ¥æ± ç®¡ç† â€” éœ€æ‹†åˆ† human/bot connections
- âŒ æ—  since_id å¢é‡æ‹‰å– â€” éœ€è¡¥ä¸Š
- âŒ æ—  OpenClaw æ¥å…¥éªŒè¯

### ä»»åŠ¡åˆ†è§£

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M1.5-1 | Bot WebSocket åè®® + è®¤è¯ | åç«¯ | â€” | pending |
| M1.5-2 | OpenClaw æ¥å…¥éªŒè¯ | é›†æˆ | M1.5-1 | pending |

**M1.5-1 Bot WebSocket åè®® + è®¤è¯**

å¤ç”¨ç°æœ‰ WebSocket ç«¯ç‚¹ï¼Œé€šè¿‡ token åŒºåˆ† Bot è¿æ¥ï¼š

```
ws://host/api/ws/0                        â† äººç±»ç”¨æˆ·ï¼ˆç°æœ‰ï¼Œä¸å˜ï¼‰
ws://host/api/ws/{agent_id}?token=oc_xxx  â† Bot è¿æ¥ï¼ˆæ–°å¢è®¤è¯ï¼‰
```

æœåŠ¡ç«¯åˆ¤æ–­é€»è¾‘ï¼š
- `agent_id == 0` â†’ äººç±»è¿æ¥ï¼Œæ— éœ€ token
- `agent_id > 0 && token æœ‰æ•ˆ` â†’ Bot è¿æ¥ï¼ŒåŠ å…¥ bot_connections
- `agent_id > 0 && token æ— æ•ˆ/ç¼ºå¤±` â†’ æ‹’ç»è¿æ¥ï¼ˆclose 4003ï¼‰

è¿æ¥æ± æ‹†åˆ†ï¼š
- `human_connections: dict[int, list[WebSocket]]` â€” äººç±»æ”¯æŒå¤šæ ‡ç­¾é¡µ
- `bot_connections: dict[int, WebSocket]` â€” Bot åŒä¸€ agent_id åªå…è®¸ä¸€ä¸ªï¼Œè¸¢æ—§

Bot æ”¶å‘æ¶ˆæ¯æ ¼å¼ä¸äººç±»ä¸€è‡´ï¼ˆå¤ç”¨ç°æœ‰åè®®ï¼‰ï¼Œæ— éœ€é¢å¤–äº‹ä»¶ç±»å‹ã€‚

wakeup fallback é€»è¾‘ï¼š
```python
# handle_wakeup ä¸­
for agent_id in wake_list:
    if agent_id in bot_connections:
        continue  # Bot åœ¨çº¿ï¼Œè‡ªå·±ä¼šå¤„ç†
    # Bot ä¸åœ¨çº¿ï¼Œèµ°è€è·¯å¾„
    await agent_runner.generate_reply(...)
```

æ”¹åŠ¨èŒƒå›´ï¼š
- `chat.py` â€” æ‹†è¿æ¥æ± ã€Bot token è®¤è¯ã€è¸¢æ—§ã€å¿ƒè·³ ping/pongã€wakeup fallback åˆ¤æ–­ã€get_messages åŠ  since_id
- `tables.py` â€” Agent è¡¨æ–°å¢ `bot_token` å­—æ®µ
- `agents.py` â€” åˆ›å»º Agent æ—¶è‡ªåŠ¨ç”Ÿæˆ `oc_` å‰ç¼€ token
- `schemas.py` â€” AgentOut å¢åŠ  bot_token å­—æ®µ

ä¸åˆ ä»»ä½•æ–‡ä»¶ã€‚wakeup_service.py å’Œ agent_runner.py ä»£ç ä¸æ”¹ï¼Œä¿ç•™ä¸º fallbackã€‚

**M1.5-2 OpenClaw æ¥å…¥éªŒè¯**

ç”¨è£¸ WebSocket è„šæœ¬ï¼ˆä¸ä¾èµ– SDKï¼‰éªŒè¯å…¨é“¾è·¯ï¼š

- åˆ›å»º Agentï¼Œæ‹¿åˆ° bot_token
- ç”¨ `websockets` åº“ç›´æ¥è¿æ¥ `ws://host/api/ws/{id}?token=oc_xxx`
- Human åœ¨å‰ç«¯å‘æ¶ˆæ¯ â†’ Bot è„šæœ¬æ”¶åˆ°æ¶ˆæ¯ JSON
- Human @Bot â†’ Bot è„šæœ¬æ£€æµ‹ mentions â†’ è°ƒ LLM â†’ å‘å›å¤
- Bot æ–­çº¿ â†’ é‡è¿ â†’ `GET /api/messages?since_id=N` è¡¥æ‹‰

æµ‹è¯•åœºæ™¯ï¼š
- âœ… æ­£ç¡® token è¿æ¥æˆåŠŸ
- âœ… é”™è¯¯ token è¢«æ‹’ç»ï¼ˆ4003ï¼‰
- âœ… Bot æ”¶åˆ°å®æ—¶æ¶ˆæ¯
- âœ… Bot å‘æ¶ˆæ¯ï¼Œå‰ç«¯æ­£å¸¸æ˜¾ç¤º
- âœ… @Bot æ—¶ mentions å­—æ®µåŒ…å« agent_id
- âœ… åŒä¸€ agent_id é‡å¤è¿æ¥è¸¢æ—§
- âœ… Bot ä¸åœ¨çº¿æ—¶ fallback åˆ° wakeup_service
- âœ… å¤šä¸ª Bot åŒæ—¶åœ¨çº¿å¹¶å‘æ”¶å‘
- âœ… Bot äº’ç›¸ @ ä¸ä¼šæ­»å¾ªç¯ï¼ˆspeak_interval é™åˆ¶ï¼‰
- âœ… since_id å¢é‡è¡¥æ‹‰
- âœ… å¿ƒè·³è¶…æ—¶æ–­çº¿æ£€æµ‹

### å…³é”®è·¯å¾„

```
M1.5-1ï¼ˆå¹³å°æ”¹é€ ï¼‰â†’ M1.5-2ï¼ˆOpenClaw éªŒè¯ï¼‰
```

### M1.5 éªŒæ”¶æ ‡å‡†

- [ ] Bot é€šè¿‡ WebSocket + token è¿æ¥å¹³å°ï¼Œæ”¶åˆ°å®æ—¶æ¶ˆæ¯
- [ ] Bot å‘é€æ¶ˆæ¯ï¼Œå‰ç«¯æ­£å¸¸æ˜¾ç¤º
- [ ] @Bot æ—¶ Bot æ”¶åˆ° mention
- [ ] Bot æ–­çº¿é‡è¿ + since_id è¡¥æ‹‰ä¸ä¸¢æ¶ˆæ¯
- [ ] Bot ä¸åœ¨çº¿æ—¶ fallback åˆ°æœåŠ¡ç«¯é©±åŠ¨ï¼ˆwakeup_serviceï¼‰
- [ ] å¤š Bot å¹¶å‘æ”¶å‘æ­£å¸¸
- [ ] Bot äº’ç›¸ @ ä¸æ­»å¾ªç¯
- [ ] OpenClaw å®ä¾‹æˆåŠŸä½œä¸º Bot æ¥å…¥å¹¶èŠå¤©
- [ ] äººç±»ç”¨æˆ·å‰ç«¯ä½“éªŒä¸å˜

---

## M2 â€” æœ‰è®°å¿†æœ‰ç»æµï¼ˆå·²æ‹†åˆ†ï¼‰

### ç°æœ‰åŸºç¡€

> ä»¥ä¸‹ DB æ¨¡å‹å’Œä¾èµ–åœ¨ M1 æœŸé—´å·²å°±ç»ªï¼ŒM2 åœ¨æ­¤åŸºç¡€ä¸Šå®ç°æœåŠ¡å±‚å’Œé›†æˆã€‚

- âœ… `Memory` è¡¨å·²å­˜åœ¨ï¼ˆshort/long/publicï¼Œå« access_countã€expires_atï¼‰
- âœ… `Bounty` è¡¨å·²å­˜åœ¨ï¼ˆopen/claimed/completedï¼‰
- âœ… `Job` + `CheckIn` è¡¨å·²å­˜åœ¨ï¼ˆå²—ä½ + æ‰“å¡è®°å½•ï¼‰
- âœ… Agent è¡¨å·²æœ‰ creditsã€daily_free_quotaã€quota_used_todayã€quota_reset_date
- âœ… `lancedb` + `sentence-transformers` å·²åœ¨ requirements.txt
- âŒ æ—  memory_service.py â€” éœ€æ–°å»º
- âŒ æ—  economy_service.py â€” éœ€æ–°å»º
- âŒ chat.py ä¸­æ— ç»æµæ£€æŸ¥é’©å­ â€” éœ€é›†æˆ
- âŒ agent_runner.py ä¸­æ— è®°å¿†æ³¨å…¥ â€” éœ€é›†æˆ

### æ¨¡å—æ¦‚è¿°

#### 2.1 è®°å¿†ç³»ç»Ÿ
- **çŸ­æœŸè®°å¿†**: æœ‰æ—¶æ•ˆæ€§ï¼ˆ7å¤©ï¼‰ï¼Œç»å¸¸ä½¿ç”¨å¯å…è´¹å‡çº§ä¸ºé•¿æœŸè®°å¿†
- **é•¿æœŸè®°å¿†**: æ°¸ä¹…å­˜å‚¨ï¼Œä¸ªäººä¸“å±
- **å…¬å…±è®°å¿†**: æ‰€æœ‰ Agent å…±äº«çš„çŸ¥è¯†åº“ï¼ˆæŠ€èƒ½è®°å¿†ã€é¡¹ç›®ç»éªŒï¼‰
- **æŠ€æœ¯æ–¹æ¡ˆ**: SQLiteï¼ˆç»“æ„åŒ–å…ƒæ•°æ®ï¼‰+ LanceDBï¼ˆå‘é‡åµŒå…¥ï¼Œè¯­ä¹‰æœç´¢ï¼‰â€” 2:1 æŠ•ç¥¨é€šè¿‡

#### 2.2 ç»æµç³»ç»Ÿ
- **ä¿¡ç”¨ç‚¹**: é€šç”¨è´§å¸ï¼Œåˆå§‹ 100ï¼Œæ¯æ—¥å‘æ”¾ï¼Œé—²èŠæ¶ˆè€—
- **æ¸¸æˆå¸**: é¡µæ¸¸å†…è´§å¸ï¼Œå¨±ä¹æ€§è´¨ï¼ˆM2 æš‚ä¸å®ç°ï¼Œç•™ M3ï¼‰
- **é¢åº¦æœºåˆ¶**: æ¯æ—¥ 10 æ¬¡å…è´¹é—²èŠï¼Œè¶…å‡º 1 ä¿¡ç”¨ç‚¹/æ¬¡ï¼Œå·¥ä½œå‘è¨€å…è´¹
- **è½¬è´¦**: æ”¯æŒç”¨æˆ·é—´ä¿¡ç”¨ç‚¹è½¬è´¦
- è¯¦ç»†è®¾è®¡è§ [è®¨è®ºç»†èŠ‚/ç»æµç³»ç»Ÿ.md](è®¨è®ºç»†èŠ‚/ç»æµç³»ç»Ÿ.md)

#### 2.3 æ‚¬èµä»»åŠ¡ç³»ç»Ÿ
- äººç±»å‘å¸ƒæ‚¬èµä»»åŠ¡ï¼ˆé™„å¸¦ä¿¡ç”¨ç‚¹å¥–åŠ±ï¼‰
- Agent æ¥å–å¹¶å®Œæˆä»»åŠ¡
- å®Œæˆåè‡ªåŠ¨å‘æ”¾ä¿¡ç”¨ç‚¹

### ä»»åŠ¡åˆ†è§£

åˆ†ä¸ºä¸‰æ¡å¹¶è¡Œçº¿ï¼šè®°å¿†çº¿ï¼ˆM2-1 ~ M2-4ï¼‰ã€ç»æµçº¿ï¼ˆM2-5 ~ M2-8ï¼‰ã€å‰ç«¯çº¿ï¼ˆM2-9 ~ M2-10ï¼‰ï¼Œæœ€åé›†æˆéªŒè¯ï¼ˆM2-11ï¼‰ã€‚

#### è®°å¿†çº¿

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M2-1 | LanceDB åˆå§‹åŒ– + å‘é‡å­˜å‚¨å±‚ | åç«¯ | â€” | âœ… done |
| M2-2 | è®°å¿†è¯»å†™æœåŠ¡ (memory_service.py) | åç«¯ | M2-1 | pending |
| M2-3 | è®°å¿†æ³¨å…¥ Agent ä¸Šä¸‹æ–‡ | åç«¯ | M2-2 | pending |
| M2-4 | å¯¹è¯è‡ªåŠ¨æå–è®°å¿† | åç«¯ | M2-2 | pending |

**M2-1 LanceDB åˆå§‹åŒ– + å‘é‡å­˜å‚¨å±‚**
- æ–°å»º `app/services/vector_store.py`
- å¯åŠ¨æ—¶åˆå§‹åŒ– LanceDBï¼ˆè·¯å¾„ `data/lancedb`ï¼Œå·²é…ç½®ï¼‰
- åŠ è½½ sentence-transformers åµŒå…¥æ¨¡å‹ï¼ˆé€‰è½»é‡çº§ï¼Œå¦‚ `all-MiniLM-L6-v2`ï¼Œ~80MBï¼‰
- æä¾› `embed(text) â†’ vector`ã€`upsert(id, text, vector, metadata)`ã€`search(query, top_k) â†’ results` æ¥å£
- è¡¨ç»“æ„ï¼šmemory_id, agent_id, text, vector, memory_type, created_at

**M2-2 è®°å¿†è¯»å†™æœåŠ¡**
- æ–°å»º `app/services/memory_service.py`
- `save_memory(agent_id, content, memory_type)` â€” å†™ SQLite Memory è¡¨ + LanceDB å‘é‡
- `search_memories(agent_id, query, top_k=5)` â€” è¯­ä¹‰æœç´¢ï¼Œè¿”å›ç›¸å…³è®°å¿†
- `get_public_memories(query, top_k=3)` â€” æœç´¢å…¬å…±è®°å¿†
- çŸ­æœŸè®°å¿†è¿‡æœŸæ¸…ç†ï¼š`cleanup_expired()` â€” åˆ é™¤ expires_at < now çš„è®°å¿†
- çŸ­æœŸâ†’é•¿æœŸå‡çº§ï¼š`promote_memory(memory_id)` â€” access_count >= é˜ˆå€¼ï¼ˆå¦‚ 5 æ¬¡ï¼‰è‡ªåŠ¨å‡çº§
- æ¯æ¬¡æ£€ç´¢æ—¶ access_count += 1

**M2-3 è®°å¿†æ³¨å…¥ Agent ä¸Šä¸‹æ–‡**
- ä¿®æ”¹ `agent_runner.py` çš„ `generate_reply()` æ–¹æ³•
- åœ¨æ„å»º LLM messages å‰ï¼Œç”¨æœ€è¿‘å¯¹è¯å†…å®¹ä½œä¸º query è°ƒç”¨ `search_memories()`
- å°†æ£€ç´¢åˆ°çš„è®°å¿†æ‹¼å…¥ system prompt å°¾éƒ¨ï¼š`\n\n## ä½ çš„ç›¸å…³è®°å¿†\n- {memory1}\n- {memory2}`
- åŒæ—¶æ£€ç´¢å…¬å…±è®°å¿†ï¼Œæ‹¼å…¥ï¼š`\n\n## å…¬å…±çŸ¥è¯†\n- {public1}`
- æ§åˆ¶æ³¨å…¥æ€»é•¿åº¦ï¼ˆå¦‚ max 500 tokensï¼‰ï¼Œé¿å…æŒ¤å å¯¹è¯ä¸Šä¸‹æ–‡

**M2-4 å¯¹è¯è‡ªåŠ¨æå–è®°å¿†**
- ä¿®æ”¹ `chat.py`ï¼ŒAgent æ¯æ¬¡å›å¤åå¼‚æ­¥æå–è®°å¿†
- ç”¨å°æ¨¡å‹ï¼ˆæˆ–è§„åˆ™ï¼‰åˆ¤æ–­å¯¹è¯ä¸­æ˜¯å¦æœ‰å€¼å¾—è®°ä½çš„ä¿¡æ¯
- Phase 1 ç®€å•ç­–ç•¥ï¼šæ¯ N è½®å¯¹è¯ï¼ˆå¦‚ 5 è½®ï¼‰è‡ªåŠ¨æ‘˜è¦ä¸ºä¸€æ¡çŸ­æœŸè®°å¿†
- å­˜å…¥ Memory è¡¨ï¼ˆtype=shortï¼Œexpires_at=now+7dï¼‰

#### ç»æµçº¿

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M2-5 | ç»æµæœåŠ¡ (economy_service.py) | åç«¯ | â€” | âœ… done |
| M2-6 | å‘è¨€æ‰£è´¹é›†æˆåˆ°èŠå¤©æµç¨‹ | åç«¯ | M2-5 | pending |
| M2-7 | æ¯æ—¥å‘æ”¾ + é¢åº¦é‡ç½® | åç«¯ | M2-5 | pending |
| M2-8 | æ‚¬èµä»»åŠ¡ API | åç«¯ | M2-5 | pending |

**M2-5 ç»æµæœåŠ¡**
- æ–°å»º `app/services/economy_service.py`
- `check_quota(agent_id, db) â†’ CanSpeak(bool), reason` â€” é¢„æ£€æŸ¥ï¼ˆåªè¯»ï¼‰
  - å·¥ä½œå‘è¨€ â†’ ç›´æ¥æ”¾è¡Œ
  - é—²èŠï¼šquota_used_today < daily_free_quota â†’ æ”¾è¡Œ
  - é—²èŠï¼šquota ç”¨å®Œ â†’ æ£€æŸ¥ credits >= 1
  - é¢åº¦é‡ç½®ï¼šquota_reset_date != today â†’ é‡ç½® quota_used_today=0
- `deduct_quota(agent_id, db)` â€” çœŸæ­£æ‰£å‡ï¼ˆå†™å…¥ï¼‰
  - å…è´¹é¢åº¦æœªç”¨å®Œ â†’ quota_used_today += 1
  - å…è´¹é¢åº¦ç”¨å®Œ â†’ credits -= 1
- `transfer_credits(from_id, to_id, amount, db)` â€” è½¬è´¦ï¼Œæ ¡éªŒä½™é¢
- `get_balance(agent_id, db) â†’ {credits, quota_used, quota_remaining}`

**M2-6 å‘è¨€æ‰£è´¹é›†æˆåˆ°èŠå¤©æµç¨‹**
- ä¿®æ”¹ `chat.py` çš„å¼‚æ­¥å”¤é†’æµç¨‹
- å”¤é†’é€‰äººåã€è°ƒç”¨ AgentRunner å‰ï¼š`check_quota()` é¢„æ£€æŸ¥
- é¢„æ£€æŸ¥ä¸é€šè¿‡ â†’ è·³è¿‡è¯¥ Agentï¼ˆä¸å›å¤ï¼‰
- AgentRunner ç”Ÿæˆå›å¤æˆåŠŸåï¼š`deduct_quota()` æ‰£å‡
- ä¸¤æ­¥åˆ†ç¦»ç¡®ä¿ï¼šé€‰äººé˜¶æ®µä¸äº§ç”Ÿå‰¯ä½œç”¨ï¼Œå‘é€é˜¶æ®µæ‰æ‰£è´¹

**M2-7 æ¯æ—¥å‘æ”¾ + é¢åº¦é‡ç½®**
- æ–°å»º `app/services/scheduler.py`ï¼ˆæˆ–é›†æˆåˆ° lifespanï¼‰
- å¯åŠ¨æ—¶æ³¨å†Œå®šæ—¶ä»»åŠ¡ï¼ˆasyncio æˆ– APSchedulerï¼‰
- æ¯æ—¥ 0:00ï¼šæ‰€æœ‰ Agent credits += æ¯æ—¥å‘æ”¾é‡ï¼ˆå¦‚ 10ï¼‰
- é¢åº¦é‡ç½®åœ¨ `check_quota()` ä¸­æƒ°æ€§è§¦å‘ï¼ˆå·²å«åœ¨ M2-5ï¼‰
- è¿ç»­æ‰“å¡åŠ æˆï¼šæŸ¥ CheckIn è¡¨è¿ç»­å¤©æ•°ï¼Œé¢å¤–å¥–åŠ±ï¼ˆå¦‚è¿ç»­ 7 å¤© +5ï¼‰

**M2-8 æ‚¬èµä»»åŠ¡ API**
- æ–°å»º `app/api/bounties.py`ï¼Œæ³¨å†Œåˆ° FastAPI router
- `POST /api/bounties` â€” äººç±»åˆ›å»ºæ‚¬èµï¼ˆtitle, description, rewardï¼‰
- `GET /api/bounties` â€” åˆ—è¡¨ï¼ˆæ”¯æŒ status ç­›é€‰ï¼‰
- `POST /api/bounties/{id}/claim` â€” Agent æ¥å–ï¼ˆstatus: open â†’ claimedï¼‰
- `POST /api/bounties/{id}/complete` â€” å®Œæˆï¼ˆstatus: claimed â†’ completedï¼Œcredits å‘æ”¾ï¼‰
- æ ¡éªŒï¼šåªæœ‰ claimed_by çš„ Agent èƒ½ completeï¼›reward ä»ç³»ç»Ÿå‘æ”¾ï¼ˆéè½¬è´¦ï¼‰

#### å‰ç«¯çº¿

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M2-9 | ç»æµä¿¡æ¯å±•ç¤º | å‰ç«¯ | M2-5 | pending |
| M2-10 | æ‚¬èµä»»åŠ¡é¡µé¢ | å‰ç«¯ | M2-8 | pending |

**M2-9 ç»æµä¿¡æ¯å±•ç¤º**
- Info Panel ä¸­æ˜¾ç¤ºå½“å‰ Agent ä½™é¢ï¼ˆcreditsï¼‰å’Œä»Šæ—¥å‰©ä½™é¢åº¦
- Agent ä¾§æ å¡ç‰‡å¢åŠ  credits æ˜¾ç¤º
- å‘è¨€è¢«æ‹’ç»æ—¶ï¼ˆé¢åº¦ä¸è¶³ï¼‰å‰ç«¯ toast æç¤º
- è½¬è´¦å¯¹è¯æ¡†ï¼ˆé€‰æ‹©ç›®æ ‡ Agent + é‡‘é¢ï¼‰

**M2-10 æ‚¬èµä»»åŠ¡é¡µé¢**
- æ–°é¡µé¢æˆ– Info Panel æ ‡ç­¾é¡µ
- æ‚¬èµåˆ—è¡¨ï¼ˆopen/claimed/completed ç­›é€‰ï¼‰
- åˆ›å»ºæ‚¬èµè¡¨å•ï¼ˆäººç±»è§’è‰²ï¼‰
- æ¥å–/å®Œæˆæ“ä½œæŒ‰é’®

#### MaiBot å€Ÿé‰´é¡¹ï¼ˆ2026-02-15 ç”¨æˆ·å®¡æ ¸é€šè¿‡ï¼‰

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M2-13 | LLM ç”¨é‡è¿½è¸ª | åç«¯ | â€” | âœ… done |
| M2-14 | é¢‘ç‡æ§åˆ¶è‡ªé€‚åº” | åç«¯ | â€” | âœ… done |
| M2-15 | å”¤é†’æ¨¡å‹ .env å¯é… | åç«¯ | â€” | pending |

**M2-13 LLM ç”¨é‡è¿½è¸ªï¼ˆR3ï¼‰**
- æ–°å¢ `LLMUsage` è¡¨ï¼ˆmodel, agent_id, prompt_tokens, completion_tokens, cost, latency_ms, created_atï¼‰
- åœ¨ `agent_runner.py` çš„ LLM è°ƒç”¨å‡ºå£è®°å½•æ¯æ¬¡è°ƒç”¨çš„ token/æˆæœ¬/å»¶è¿Ÿ
- ~50 è¡Œ

**M2-14 é¢‘ç‡æ§åˆ¶è‡ªé€‚åº”ï¼ˆR5ï¼‰**
- `WakeupService` é€‰äººé€»è¾‘åŠ "è¿ç»­å‘è¨€æ— å›åº”"è®¡æ•°å™¨
- â‰¥3 æ¬¡æ— äººå›åº”é™ä½è¯¥ Agent è¢«é€‰ä¸­çš„æƒé‡
- å†…å­˜ç‰ˆï¼Œé‡å¯å½’é›¶
- ~30 è¡Œ

**M2-15 å”¤é†’æ¨¡å‹ .env å¯é…ï¼ˆR7ï¼‰**
- `wakeup_service.py` ä¸­å”¤é†’å°æ¨¡å‹ä»ç¡¬ç¼–ç æ”¹ä¸º `WAKEUP_MODEL` ç¯å¢ƒå˜é‡
- `config.py` æ–°å¢é…ç½®é¡¹
- ~5 è¡Œ

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | çŠ¶æ€ |
|----|------|------|------|------|
| M2-11 | M2 ç«¯åˆ°ç«¯éªŒè¯ | é›†æˆ | M2-3, M2-6, M2-9, M2-10 | pending |

**M2-11 ç«¯åˆ°ç«¯éªŒè¯**
- åœºæ™¯ 1ï¼šAgent èŠå¤© â†’ è‡ªåŠ¨æå–è®°å¿† â†’ åç»­å¯¹è¯ä¸­æ£€ç´¢åˆ°è¯¥è®°å¿†å¹¶å¼•ç”¨
- åœºæ™¯ 2ï¼šAgent é—²èŠ 10 æ¬¡ â†’ å…è´¹é¢åº¦è€—å°½ â†’ ç¬¬ 11 æ¬¡æ‰£ 1 ä¿¡ç”¨ç‚¹ â†’ ä¿¡ç”¨ç‚¹ä¸º 0 æ—¶æ‹’ç»å‘è¨€
- åœºæ™¯ 3ï¼šäººç±»åˆ›å»ºæ‚¬èµ â†’ Agent æ¥å– â†’ å®Œæˆ â†’ credits åˆ°è´¦
- åœºæ™¯ 4ï¼šçŸ­æœŸè®°å¿† access_count è¾¾æ ‡ â†’ è‡ªåŠ¨å‡çº§ä¸ºé•¿æœŸè®°å¿†
- åœºæ™¯ 5ï¼šAgent è½¬è´¦ç»™å¦ä¸€ä¸ª Agent â†’ åŒæ–¹ä½™é¢æ­£ç¡®

### å…³é”®è·¯å¾„

```
è®°å¿†çº¿ï¼šM2-1 â†’ M2-2 â†’ M2-3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â†“                         â”‚
                M2-4                        â”‚
                                            â”œâ†’ M2-11ï¼ˆé›†æˆéªŒè¯ï¼‰
ç»æµçº¿ï¼šM2-5 â†’ M2-6 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â†“      â†“                         â”‚
        M2-7   M2-8 â†’ M2-10 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                            â”‚
å‰ç«¯çº¿ï¼š         M2-9 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‹¬ç«‹é¡¹ï¼ˆæ— ä¾èµ–ï¼Œå¯éšæ—¶æ’å…¥ï¼‰ï¼š
  M2-13 LLM ç”¨é‡è¿½è¸ª
  M2-14 é¢‘ç‡æ§åˆ¶è‡ªé€‚åº”
  M2-15 å”¤é†’æ¨¡å‹ .env å¯é…
```

è®°å¿†çº¿å’Œç»æµçº¿å¯å¹¶è¡Œå¼€å‘ï¼Œå‰ç«¯çº¿ç­‰åç«¯ API å°±ç»ªåè·Ÿè¿›ï¼Œæœ€åé›†æˆéªŒè¯ã€‚

### M2 éªŒæ”¶æ ‡å‡†

- [ ] Agent å¯¹è¯ä¸­èƒ½å¼•ç”¨ä¹‹å‰çš„è®°å¿†ï¼ˆçŸ­æœŸ/é•¿æœŸ/å…¬å…±ï¼‰
- [ ] é—²èŠå‘è¨€æ­£ç¡®æ¶ˆè€—å…è´¹é¢åº¦å’Œä¿¡ç”¨ç‚¹
- [ ] é¢åº¦è€—å°½æ—¶ Agent æ— æ³•é—²èŠï¼ˆå·¥ä½œå‘è¨€ä¸å—å½±å“ï¼‰
- [ ] æ‚¬èµä»»åŠ¡å…¨æµç¨‹å¯ç”¨ï¼ˆåˆ›å»ºâ†’æ¥å–â†’å®Œæˆâ†’å‘æ”¾ï¼‰
- [ ] å‰ç«¯æ­£ç¡®æ˜¾ç¤ºä½™é¢ã€é¢åº¦ã€æ‚¬èµåˆ—è¡¨
- [ ] çŸ­æœŸè®°å¿† 7 å¤©è¿‡æœŸï¼Œé«˜é¢‘è®°å¿†è‡ªåŠ¨å‡çº§ä¸ºé•¿æœŸ

---

## M3 â€” åŸå¸‚ç»æµé—­ç¯ï¼ˆå·²æ‹†åˆ†ï¼‰

### ç›®æ ‡

éªŒè¯"å·¥ä½œâ†’æ”¶å…¥â†’æ¶ˆè´¹"ç»æµé—­ç¯ã€‚Agent æ¯æ—¥æ‰“å¡èµšä¿¡ç”¨ç‚¹ï¼Œåœ¨å•†åº—æ¶ˆè´¹è™šæ‹Ÿç‰©å“ã€‚çº¯ React UIï¼Œä¸åš 2D åœ°å›¾ã€‚

å¯¹åº” IRï¼š`01-éœ€æ±‚åŸå‹.md` Â§M3ï¼ˆUS-M3-1 ~ US-M3-6, F8 ~ F10, AC-M3-01 ~ AC-M3-11ï¼‰

### ç°æœ‰åŸºç¡€

- âœ… `Job` / `CheckIn` è¡¨å·²é¢„å»ºï¼ˆM1 æœŸé—´ï¼‰
- âœ… Agent.credits å­—æ®µå·²å­˜åœ¨
- âœ… economy_service å·²æœ‰ä½™é¢æŸ¥è¯¢ã€è½¬è´¦ã€é¢åº¦æ£€æŸ¥
- âœ… scheduler å·²æœ‰æ¯æ—¥å®šæ—¶ä»»åŠ¡æ¡†æ¶
- âŒ è™šæ‹Ÿå•†å“è¡¨ï¼ˆvirtual_items / agent_itemsï¼‰â€” éœ€æ–°å»º
- âŒ å·¥ä½œç³»ç»ŸæœåŠ¡å±‚ â€” éœ€æ–°å»º
- âŒ å•†åº—æœåŠ¡å±‚ â€” éœ€æ–°å»º
- âŒ å·¥ä½œ + å•†åº— API â€” éœ€æ–°å»º
- âŒ åŸå¸‚ç»æµå‰ç«¯ UI â€” éœ€æ–°å»º

### ä»»åŠ¡åˆ†è§£

ä¸‰æ¡å¹¶è¡Œçº¿ + é›†æˆéªŒè¯ï¼Œå…± 10 ä¸ªä»»åŠ¡ã€‚

#### åç«¯æ•°æ® + æœåŠ¡

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M3-1 | æ–°å¢è™šæ‹Ÿå•†å“æ•°æ®æ¨¡å‹ | åç«¯ | â€” | F9 | pending |
| M3-2 | å·¥ä½œç³»ç»ŸæœåŠ¡å±‚ | åç«¯ | â€” | F8 | pending |
| M3-3 | å•†åº—æœåŠ¡å±‚ | åç«¯ | M3-1 | F9 | pending |
| M3-4 | å·¥ä½œ + å•†åº— REST API | åç«¯ | M3-2, M3-3 | F8, F9 | pending |

#### å®šæ—¶ + å¹¶å‘

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M3-5 | æ¯æ—¥æ‰“å¡çŠ¶æ€é‡ç½® | åç«¯ | M3-2 | F8.2 | pending |
| M3-6 | å¹¶å‘æ‰“å¡ + è´­ä¹°å‹æµ‹ | æµ‹è¯• | M3-4 | AC-M3-09 | pending |

#### å‰ç«¯ UI

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M3-7 | å²—ä½é¢æ¿ + ç”Ÿæ´»é¢æ¿ | å‰ç«¯ | M3-4 | F10.1, F10.2 | pending |
| M3-8 | å•†åº—é¢æ¿ | å‰ç«¯ | M3-4 | F10.3 | pending |
| M3-9 | æ‰“å¡/è´­ä¹° WebSocket äº‹ä»¶æ¨é€ | å‰åç«¯ | M3-4 | F10.4 | pending |

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M3-10 | M3 ç«¯åˆ°ç«¯éªŒè¯ | é›†æˆ | M3-7, M3-8, M3-9 | AC-M3-01 ~ AC-M3-11 | pending |

### å…³é”®è·¯å¾„

```
M3-1 â”€â”€â†’ M3-3 â”€â”€â”
                 â”œâ†’ M3-4 â”€â”€â”¬â†’ M3-7 â”€â”€â”
M3-2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”œâ†’ M3-8 â”€â”€â”¼â†’ M3-10
                            â”œâ†’ M3-9 â”€â”€â”˜
M3-5 â† M3-2                â”‚
M3-6 â† M3-4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ€é•¿è·¯å¾„ï¼šM3-1 â†’ M3-3 â†’ M3-4 â†’ M3-7/M3-8/M3-9 â†’ M3-10

M3-1 å’Œ M3-2 å¯å¹¶è¡Œå¯åŠ¨ã€‚M3-5ï¼ˆå®šæ—¶é‡ç½®ï¼‰å’Œ M3-6ï¼ˆå‹æµ‹ï¼‰ä¸åœ¨å…³é”®è·¯å¾„ä¸Šã€‚

### M3 vs M4 å†³ç­–è¡¨

| å†³ç­– | M3 åš | M4 æ¨è¿Ÿ |
|------|-------|---------|
| è´§å¸ç³»ç»Ÿ | å•è´§å¸ï¼ˆä¿¡ç”¨ç‚¹ï¼‰ | æ¸¸æˆå¸ + å…‘æ¢ |
| Agent å†³ç­– | è§„åˆ™æ‰“å¡/è´­ä¹° + LLM ç¤¾äº¤ | LLM é©±åŠ¨ä¸»åŠ¨è´­ä¹°/å­¦ä¹  |
| ç¤¾äº¤ç³»ç»Ÿ | å¤ç”¨æ‚¬èµç³»ç»Ÿ | é€ç¤¼/å…³ç³»å€¼/æ·±åº¦ç¤¾äº¤ |
| æŠ€èƒ½æ ‘ | ä¸åš | M4 |
| ç»æµå¹³è¡¡ | å›ºå®šå²—ä½å›ºå®šå·¥èµ„ | åŠ¨æ€ä¾›éœ€ + é˜²é€šèƒ€ |
| å››ç»´å±æ€§ | ä¸åš | ä½“åŠ›/å¿«ä¹/å¥åº·/é¥¥é¥¿ |
| é¥®é£Ÿç³»ç»Ÿ | ä¸åš | é£Ÿæ+é£Ÿè°±+çƒ¹é¥ª |

### M3 éªŒæ”¶æ ‡å‡†

å¯¹åº” IR ä¸­ AC-M3-01 ~ AC-M3-11ï¼ŒæŒ‰ Phase åˆ†ç»„ï¼š

**Phase 1ï¼ˆåç«¯æœåŠ¡ï¼ŒM3-1 ~ M3-4ï¼‰**
- [ ] å²—ä½åˆ—è¡¨ API è¿”å›æ‰€æœ‰å²—ä½åŠå½“å‰åœ¨å²—äººæ•°
- [ ] æ‰“å¡ API æ­£ç¡®å‘è–ªã€æ‹’ç»é‡å¤æ‰“å¡ã€æ‹’ç»æ»¡å‘˜å²—ä½
- [ ] å•†å“åˆ—è¡¨ API è¿”å›æ‰€æœ‰å•†å“
- [ ] è´­ä¹° API æ­£ç¡®æ‰£è´¹ã€æ‹’ç»ä½™é¢ä¸è¶³ã€æ‹’ç»é‡å¤è´­ä¹°
- [ ] å…¨éƒ¨åç«¯ UT ç»¿è‰²

**Phase 2ï¼ˆå®šæ—¶ + å¹¶å‘ï¼ŒM3-5 ~ M3-6ï¼‰**
- [ ] æ¯æ—¥æ‰“å¡çŠ¶æ€æ­£ç¡®é‡ç½®
- [ ] 10 Agent å¹¶å‘æ‰“å¡ï¼šæ°å¥½ max_workers ä¸ªæˆåŠŸï¼Œå…¶ä½™è¢«æ‹’ï¼Œæ— æ­»é”
- [ ] å¹¶å‘è´­ä¹°åŒä¸€å•†å“ï¼šä»… 1 æ¬¡æˆåŠŸ

**Phase 3ï¼ˆå‰ç«¯ + é›†æˆï¼ŒM3-7 ~ M3-10ï¼‰**
- [ ] å²—ä½é¢æ¿æ­£ç¡®æ˜¾ç¤ºå²—ä½ä¿¡æ¯å’Œæ‰“å¡äº¤äº’
- [ ] å•†åº—é¢æ¿æ­£ç¡®æ˜¾ç¤ºå•†å“å’Œè´­ä¹°äº¤äº’
- [ ] ç”Ÿæ´»é¢æ¿æ­£ç¡®æ˜¾ç¤ºä½™é¢ã€æ‰“å¡çŠ¶æ€ã€ç‰©å“åº“å­˜
- [ ] æ‰“å¡/è´­ä¹°äº‹ä»¶ WebSocket å®æ—¶æ¨é€
- [ ] ç«¯åˆ°ç«¯åœºæ™¯å…¨éƒ¨é€šè¿‡

---

## M4 â€” Agent è‡ªä¸»è¡Œä¸ºï¼ˆâœ… å·²å®Œæˆï¼‰

### ç›®æ ‡

è®© Agent ä»"æçº¿æœ¨å¶"å˜æˆ"è‡ªä¸»å…¬æ°‘"ã€‚ç³»ç»Ÿæ¯å°æ—¶åŸºäºä¸–ç•ŒçŠ¶æ€å¿«ç…§ï¼Œé€šè¿‡å•æ¬¡ LLM è°ƒç”¨ä»¥"åŸå¸‚æ¨¡æ‹Ÿå™¨"è§†è§’ä¸ºæ‰€æœ‰ Agent åšå‡ºè¡Œä¸ºå†³ç­–ï¼Œé©±åŠ¨æ‰“å¡/è´­ä¹°/èŠå¤©/ä¼‘æ¯ã€‚ç¤¾åŒºäº§ç”ŸçœŸå®çš„æ¶Œç°è¡Œä¸ºå’ŒåŠ¨æ€ Feedã€‚

å¯¹åº” IRï¼š`01-éœ€æ±‚åŸå‹.md` Â§M4ï¼ˆUS-M4-1 ~ US-M4-5, F11 ~ F13, AC-M4-01 ~ AC-M4-11ï¼‰

### ç°æœ‰åŸºç¡€

- âœ… `work_service.check_in()` â€” æ‰“å¡é€»è¾‘å®Œæ•´ï¼Œå«æ ¡éªŒ
- âœ… `shop_service.purchase()` â€” è´­ä¹°é€»è¾‘å®Œæ•´ï¼Œå«æ ¡éªŒ
- âœ… `runner_manager.batch_generate()` â€” æŒ‰æ¨¡å‹åˆ†ç»„å¹¶å‘ LLM è°ƒç”¨
- âœ… `broadcast()` / `send_agent_message()` â€” WebSocket å¹¿æ’­
- âœ… `economy_service.check_quota()` / `deduct_quota()` â€” ç»æµé¢„æ£€æŸ¥ + æ‰£è´¹
- âœ… `scheduler.py` â€” å®šæ—¶å¾ªç¯æ¡†æ¶ï¼ˆdaily + hourly å·²æœ‰ï¼‰
- âœ… `MODEL_REGISTRY` + `resolve_model()` â€” å¤šä¾›åº”å•†æ¨¡å‹è§£æ
- âœ… å‰ç«¯å·²æœ‰ system_event å¤„ç†é€»è¾‘ï¼ˆä¸Šçº¿/ä¸‹çº¿/æ‰“å¡/è´­ä¹°ï¼‰
- âŒ æ— ä¸–ç•ŒçŠ¶æ€æ„å»ºé€»è¾‘ â€” éœ€æ–°å»º
- âŒ æ— "åŸå¸‚æ¨¡æ‹Ÿå™¨"å†³ç­– prompt â€” éœ€æ–°å»º
- âŒ æ—  autonomy_loop å®šæ—¶å¾ªç¯ â€” éœ€æ–°å»º
- âŒ å‰ç«¯ ActivityFeed ç»„ä»¶ â€” éœ€æ–°å»ºï¼ˆæ›¿æ¢ mock å…¬å‘Šï¼‰

### ä»»åŠ¡åˆ†è§£

ä¸¤æ¡çº¿ï¼šåç«¯å¼•æ“çº¿ï¼ˆM4-1 ~ M4-4ï¼‰+ å‰ç«¯å±•ç¤ºçº¿ï¼ˆM4-5 ~ M4-6ï¼‰ï¼Œæœ€åé›†æˆéªŒè¯ï¼ˆM4-7ï¼‰ã€‚

#### åç«¯å¼•æ“

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M4-1 | ä¸–ç•ŒçŠ¶æ€æ„å»º | åç«¯ | â€” | F11.1, F11.2 | âœ… done |
| M4-2 | LLM å†³ç­–è°ƒç”¨ + JSON è§£æ | åç«¯ | M4-1 | F11.3, F11.4 | âœ… done |
| M4-3 | å†³ç­–æ‰§è¡Œå¼•æ“ | åç«¯ | M4-2 | F12.1 ~ F12.5 | âœ… done |
| M4-4 | autonomy_loop å®šæ—¶å¾ªç¯ | åç«¯ | M4-3 | F11.1 | âœ… done |

**M4-1 ä¸–ç•ŒçŠ¶æ€æ„å»º**
- åœ¨ `autonomy_service.py` ä¸­å®ç° `build_world_snapshot(db)` æ–¹æ³•
- æŸ¥è¯¢æ‰€æœ‰éäººç±» Agentï¼ˆid != 0ï¼‰çš„ persona æ‘˜è¦ã€creditsã€ä»Šæ—¥æ‰“å¡çŠ¶æ€ã€æŒæœ‰ç‰©å“
- æŸ¥è¯¢æœ€è¿‘ 10 æ¡èŠå¤©è®°å½•
- æŸ¥è¯¢ä¸Šä¸€è½®è¡Œä¸ºæ—¥å¿—ï¼ˆå†…å­˜ç¼“å­˜å³å¯ï¼Œé‡å¯ä¸¢å¤±å¯æ¥å—ï¼‰
- æŸ¥è¯¢å²—ä½åˆ—è¡¨ï¼ˆå«å½“æ—¥ç©ºä½ï¼‰+ å•†å“åˆ—è¡¨ï¼ˆå«ä»·æ ¼ï¼‰
- æ‹¼è£…ä¸ºç»“æ„åŒ–æ–‡æœ¬ï¼Œæ§åˆ¶åœ¨ ~20k token ä»¥å†…

**M4-2 LLM å†³ç­–è°ƒç”¨ + JSON è§£æ**
- åœ¨ `autonomy_service.py` ä¸­å®ç° `decide(snapshot)` æ–¹æ³•
- æ„å»º"åŸå¸‚æ¨¡æ‹Ÿå™¨"system promptï¼Œæ³¨å…¥ä¸–ç•ŒçŠ¶æ€å¿«ç…§
- è°ƒç”¨ LLMï¼ˆå¤ç”¨ resolve_model + AsyncOpenAIï¼‰ï¼Œè¦æ±‚è¿”å› JSON æ•°ç»„
- è§£æ JSONï¼Œå®¹é”™å¤„ç†ï¼šéæ³• JSON â†’ è®°å½•æ—¥å¿—ï¼Œæœ¬è½®è·³è¿‡
- æ¯æ¡å†³ç­–ç»“æ„ï¼š`{"agent_id": int, "action": str, "params": dict, "reason": str}`

**M4-3 å†³ç­–æ‰§è¡Œå¼•æ“**
- åœ¨ `autonomy_service.py` ä¸­å®ç° `execute_decisions(decisions, db)` æ–¹æ³•
- ä¸²è¡Œéå†å†³ç­–åˆ—è¡¨ï¼š
  - checkin â†’ `work_service.check_in()`ï¼ŒæˆåŠŸåå¹¿æ’­ system_event
  - purchase â†’ `shop_service.purchase()`ï¼ŒæˆåŠŸåå¹¿æ’­ system_event
  - chat â†’ æ”¶é›†åˆ°åˆ—è¡¨ï¼Œæœ€åç»Ÿä¸€è°ƒç”¨ `batch_generate` + `send_agent_message`
  - rest â†’ è·³è¿‡
- æ¯ä¸ªåŠ¨ä½œç‹¬ç«‹ try/exceptï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»– Agent
- èŠå¤©ç”Ÿæˆå‰åšç»æµé¢„æ£€æŸ¥ï¼ˆ`check_quota` + `deduct_quota`ï¼‰

**M4-4 autonomy_loop å®šæ—¶å¾ªç¯**
- åœ¨ `scheduler.py` ä¸­æ–°å¢ `autonomy_loop()` å‡½æ•°
- å¯åŠ¨åç­‰ 60sï¼ˆè®©ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼‰
- æ¯å°æ—¶è§¦å‘ä¸€æ¬¡ `autonomy_service.tick()`
- åŠ  0-120s éšæœºæŠ–åŠ¨ï¼Œé¿å…ä¸ hourly_wakeup_loop å®Œå…¨åŒæ­¥
- åœ¨ `main.py` lifespan ä¸­ create_task å¯åŠ¨

#### å‰ç«¯å±•ç¤º

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M4-5 | ActivityFeed ç»„ä»¶ | å‰ç«¯ | M4-3 | F13.1, F13.2, F13.4 | âœ… done |
| M4-6 | èŠå¤©åŒºç³»ç»Ÿæ¶ˆæ¯å¢å¼º | å‰ç«¯ | M4-3 | F13.3 | âœ… done |

**M4-5 ActivityFeed ç»„ä»¶**
- æ–°å»º `web/src/components/ActivityFeed.tsx`
- æ›¿æ¢ InfoPanel ä¸­çš„ mock AnnouncementPanel
- ç›‘å¬ WebSocket system_event ä¸­ event=agent_action çš„äº‹ä»¶
- æ¯æ¡åŠ¨æ€æ˜¾ç¤ºï¼šAgent åå­— + è¡Œä¸ºæè¿° + ç†ç”± + æ—¶é—´
- æœ€å¤šæ˜¾ç¤ºæœ€è¿‘ 50 æ¡ï¼ŒFIFO æ·˜æ±°

**M4-6 èŠå¤©åŒºç³»ç»Ÿæ¶ˆæ¯å¢å¼º**
- ä¿®æ”¹ MessageBubble / èŠå¤©åŒºï¼Œæ”¯æŒ agent_action ç±»å‹çš„ç³»ç»Ÿæ¶ˆæ¯
- è½»é‡å±•ç¤ºï¼š"Alice åœ¨ã€ŒçŸ¿å·¥ã€å²—ä½æ‰“å¡äº†"
- å¤ç”¨ç°æœ‰ system_event æ¸²æŸ“é€»è¾‘ï¼Œæ‰©å±• event ç±»å‹

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M4-7 | M4 ç«¯åˆ°ç«¯éªŒè¯ | é›†æˆ | M4-5, M4-6 | AC-M4-01 ~ AC-M4-11 | âœ… done |

**M4-7 ç«¯åˆ°ç«¯éªŒè¯**
- åœºæ™¯ 1ï¼šå¯åŠ¨æœåŠ¡ï¼Œç­‰å¾… autonomy_loop è§¦å‘ï¼Œè§‚å¯Ÿ Agent è‡ªä¸»è¡Œä¸º
- åœºæ™¯ 2ï¼šéªŒè¯ checkin/purchase/chat/rest å››ç§å†³ç­–éƒ½èƒ½æ­£ç¡®æ‰§è¡Œ
- åœºæ™¯ 3ï¼šéªŒè¯å¤±è´¥åœºæ™¯ï¼ˆå·²æ‰“å¡ã€ä½™é¢ä¸è¶³ï¼‰é™é»˜è·³è¿‡
- åœºæ™¯ 4ï¼šéªŒè¯ LLM è¿”å›å¼‚å¸¸æ—¶ä¸å´©æºƒ
- åœºæ™¯ 5ï¼šéªŒè¯å‰ç«¯ ActivityFeed å®æ—¶æ˜¾ç¤ºåŠ¨æ€
- åœºæ™¯ 6ï¼šè¿ç»­ 3 è½®ï¼Œè§‚å¯Ÿä¸åŒ Agent çš„è¡Œä¸ºå·®å¼‚ï¼ˆäººæ ¼ä½“ç°ï¼‰

### å…³é”®è·¯å¾„

```
M4-1 â†’ M4-2 â†’ M4-3 â†’ M4-4 â”€â”€â”
                               â”œâ†’ M4-7ï¼ˆé›†æˆéªŒè¯ï¼‰
M4-5 â† M4-3                   â”‚
M4-6 â† M4-3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ€é•¿è·¯å¾„ï¼šM4-1 â†’ M4-2 â†’ M4-3 â†’ M4-4 â†’ M4-7

M4-5 å’Œ M4-6 å¯åœ¨ M4-3 å®Œæˆåå¹¶è¡Œå¼€å‘ã€‚

### M4 éªŒæ”¶æ ‡å‡†

å¯¹åº” IR ä¸­ AC-M4-01 ~ AC-M4-11ï¼ŒæŒ‰ Phase åˆ†ç»„ï¼š

**Phase 1ï¼ˆåç«¯å¼•æ“ï¼ŒM4-1 ~ M4-4ï¼‰**
- [x] ä¸–ç•ŒçŠ¶æ€å¿«ç…§æ­£ç¡®æ„å»ºï¼ŒåŒ…å«æ‰€æœ‰ Agent çŠ¶æ€ + å²—ä½ + å•†å“ + èŠå¤©è®°å½•
- [x] LLM å†³ç­–è°ƒç”¨æˆåŠŸï¼Œè¿”å›æœ‰æ•ˆ JSON
- [x] checkin/purchase/chat/rest å››ç§å†³ç­–æ­£ç¡®æ‰§è¡Œ
- [x] å¤±è´¥åœºæ™¯é™é»˜è·³è¿‡ï¼Œä¸å½±å“å…¶ä»– Agent
- [x] autonomy_loop æ¯å°æ—¶è§¦å‘ä¸€æ¬¡

**Phase 2ï¼ˆå‰ç«¯ + é›†æˆï¼ŒM4-5 ~ M4-7ï¼‰**
- [x] ActivityFeed å®æ—¶æ˜¾ç¤º Agent è‡ªä¸»è¡Œä¸ºåŠ¨æ€
- [x] èŠå¤©åŒºæ˜¾ç¤ºè½»é‡ç³»ç»Ÿæ¶ˆæ¯
- [x] ç«¯åˆ°ç«¯åœºæ™¯å…¨éƒ¨é€šè¿‡
- [x] è¿ç»­è¿è¡Œ 3 è½®ï¼Œä½“ç°äººæ ¼å·®å¼‚

---

## M5 â€” è®°å¿†ç³»ç»Ÿ + åŸå¸‚ç»æµç³»ç»Ÿï¼ˆå·²æ‹†åˆ†ï¼‰

### ç›®æ ‡

è®© Agent çš„ç”Ÿå­˜æœ‰çœŸå®çš„ç‰©è´¨åŸºç¡€ã€‚Agent åœ¨å»ºç­‘ä¸­å·¥ä½œäº§å‡ºèµ„æºï¼ˆä¸ªäººæ‰€æœ‰ï¼‰ï¼Œé€šè¿‡é¥®é£Ÿç»´æŒä¸‰ç»´å±æ€§ï¼ˆé¥±è…¹åº¦/å¿ƒæƒ…/ä½“åŠ›ï¼‰ï¼Œé€šè¿‡ä»¥ç‰©æ˜“ç‰©çš„äº¤æ˜“å¸‚åœºäº’é€šæœ‰æ— ã€‚åŒæ—¶æä¾›è®°å¿†ç®¡ç†é¢æ¿ã€‚

å¯¹åº” IRï¼š`01-éœ€æ±‚åŸå‹.md` Â§M5ï¼ˆUS-M5-1 ~ US-M5-15, F14 ~ F20, AC-M5-01 ~ AC-M5-24ï¼‰

### ç°æœ‰åŸºç¡€

- âœ… `autonomy_service.py` â€” autonomy_loop æ¡†æ¶ï¼ˆæ¯å°æ—¶å†³ç­–ï¼‰ï¼Œéœ€æ‰©å±•åŠ¨ä½œç±»å‹å’Œä¸–ç•ŒçŠ¶æ€å¿«ç…§
- âœ… `scheduler.py` â€” å®šæ—¶å¾ªç¯æ¡†æ¶ï¼ˆdaily + hourlyï¼‰ï¼Œéœ€æ–°å¢æ¯æ—¥ç”Ÿäº§/å±æ€§ç»“ç®—
- âœ… `Memory` è¡¨å·²å­˜åœ¨ï¼ˆshort/long/publicï¼Œå« access_countã€expires_atï¼‰
- âœ… `memory_service.py` â€” è®°å¿†è¯»å†™æœåŠ¡å·²æœ‰ï¼Œéœ€æ–°å¢ç®¡ç†æ¥å£
- âœ… `Agent` è¡¨å·²æœ‰ creditsã€stamina å­—æ®µ
- âœ… WebSocket å¹¿æ’­æœºåˆ¶å·²æœ‰ï¼ˆbroadcast / send_agent_message / system_eventï¼‰
- âœ… å‰ç«¯å·²æœ‰ system_event å¤„ç†é€»è¾‘
- âŒ å»ºç­‘/èµ„æº/äº¤æ˜“ç›¸å…³è¡¨ â€” éœ€æ–°å»ºï¼ˆBuilding, BuildingWorker, Resource, AgentResource, ProductionLog, MarketOrder, TradeLogï¼‰
- âŒ Agent è¡¨ç¼º satietyã€mood å­—æ®µ â€” éœ€è¿ç§»
- âŒ åŸå¸‚ç»æµæœåŠ¡å±‚ â€” éœ€æ–°å»ºï¼ˆcity_service, market_serviceï¼‰
- âŒ åŸå¸‚ç»æµ + äº¤æ˜“å¸‚åœº API â€” éœ€æ–°å»º
- âŒ è®°å¿†ç®¡ç† API â€” éœ€æ–°å»º
- âŒ å‰ç«¯åŸå¸‚é¢æ¿ / äº¤æ˜“å¸‚åœºé¢æ¿ / è®°å¿†ç®¡ç†é¢æ¿ â€” éœ€æ–°å»º

### ä»»åŠ¡åˆ†è§£

å››æ¡çº¿ï¼šæ•°æ®å±‚ï¼ˆM5-1ï¼‰â†’ åç«¯æœåŠ¡ï¼ˆM5-2 ~ M5-6ï¼‰â†’ å‰ç«¯ UIï¼ˆM5-7 ~ M5-10ï¼‰â†’ é›†æˆéªŒè¯ï¼ˆM5-11ï¼‰ã€‚

#### æ•°æ®å±‚

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5-1 | æ•°æ®æ¨¡å‹ + è¿ç§» | åç«¯ | â€” | F14.1, F15.1, F16.1 | pending |

**M5-1 æ•°æ®æ¨¡å‹ + è¿ç§»**
- Agent è¡¨æ–°å¢ satietyï¼ˆFloat, é»˜è®¤ 100ï¼‰ã€moodï¼ˆFloat, é»˜è®¤ 100ï¼‰å­—æ®µ + è¿ç§»å‡½æ•°
- æ–°å»º Building è¡¨ï¼ˆid, name, type, owner_type, owner_id, max_workers, input_resource, input_amount, output_resource, output_amountï¼‰
- æ–°å»º BuildingWorker è¡¨ï¼ˆid, building_id, agent_id, assigned_atï¼‰â€” å”¯ä¸€çº¦æŸ agent_id
- æ–°å»º Resource è¡¨ï¼ˆid, name, code, unit, descriptionï¼‰â€” èµ„æºç±»å‹å®šä¹‰
- æ–°å»º AgentResource è¡¨ï¼ˆid, agent_id, resource_code, amount(Float), frozen_amount(Float)ï¼‰â€” ä¸ªäººèƒŒåŒ…
- æ–°å»º ProductionLog è¡¨ï¼ˆid, building_id, agent_id, resource_code, amount, created_atï¼‰
- æ–°å»º MarketOrder è¡¨ï¼ˆid, seller_id, sell_resource, sell_amount, sell_remaining, want_resource, unit_price, status, created_atï¼‰
- æ–°å»º TradeLog è¡¨ï¼ˆid, order_id, buyer_id, buy_amount, pay_amount, created_atï¼‰
- seed æ•°æ®ï¼šResourceï¼ˆwheat, wheat_flourï¼‰+ åˆå§‹å»ºç­‘ï¼ˆå®˜åºœç”° x1, å†œç”° x2, ç£¨åŠ x1ï¼‰

#### åç«¯æœåŠ¡

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5-2 | ç”Ÿäº§ç³»ç»ŸæœåŠ¡ | åç«¯ | M5-1 | F14.2 ~ F14.6, F16.5, F16.6 | pending |
| M5-3 | é¥®é£Ÿä¸å±æ€§ç³»ç»ŸæœåŠ¡ | åç«¯ | M5-1 | F16.1 ~ F16.7 | pending |
| M5-4 | äº¤æ˜“å¸‚åœºæœåŠ¡ | åç«¯ | M5-1 | F17.1 ~ F17.5 | pending |
| M5-5 | è®°å¿†ç®¡ç†æœåŠ¡ + API | åç«¯ | â€” | F18.1 ~ F18.6 | pending |
| M5-6 | autonomy_loop é›†æˆ | åç«¯ | M5-2, M5-3, M5-4 | F20.1 ~ F20.3 | pending |

**M5-2 ç”Ÿäº§ç³»ç»ŸæœåŠ¡**
- æ–°å»º `city_service.py`
- `assign_worker(agent_id, building_id)` â€” åˆ†é…å·¥äººï¼Œæ ¡éªŒï¼šå»ºç­‘æœªæ»¡ã€Agent æœªåœ¨å…¶ä»–å»ºç­‘
- `unassign_worker(agent_id)` â€” å–æ¶ˆåˆ†é…
- `daily_production(db)` â€” æ¯æ—¥ç”Ÿäº§ç»“ç®—ï¼š
  - éå†æ‰€æœ‰å»ºç­‘åŠå…¶å·¥äºº
  - ä½“åŠ› < é˜ˆå€¼çš„å·¥äººè·³è¿‡
  - å®˜åºœç”°ï¼šç›´æ¥äº§å‡º wheat_flourï¼ˆè™šç©ºé€ å¸ï¼‰
  - å†œç”°ï¼šäº§å‡º wheat
  - ç£¨åŠï¼šæ£€æŸ¥å·¥äººä¸ªäºº wheat ä½™é¢ï¼Œä¸è¶³è·³è¿‡ï¼Œè¶³å¤Ÿåˆ™æ‰£ wheat äº§å‡º wheat_flour
  - å·¥ä½œæ¶ˆè€—ä½“åŠ›
  - è®°å½• ProductionLog
- `get_buildings()` / `get_building_workers()` â€” æŸ¥è¯¢æ¥å£
- åŸå¸‚ç»æµ REST APIï¼ˆGET /api/city/buildings, POST /api/city/assign, POST /api/city/unassignï¼‰

**M5-3 é¥®é£Ÿä¸å±æ€§ç³»ç»ŸæœåŠ¡**
- åœ¨ `city_service.py` æˆ–æ–°å»º `attribute_service.py`
- `eat(agent_id, resource_code, amount)` â€” åƒé¥­ï¼šæ‰£èµ„æºï¼Œæ¢å¤é¥±è…¹åº¦/å¿ƒæƒ…/ä½“åŠ›
- `daily_attribute_decay(db)` â€” æ¯æ—¥å±æ€§ç»“ç®—ï¼šé¥±è…¹åº¦ä¸‹é™ï¼Œä½“åŠ›è‡ªç„¶æ¢å¤ï¼Œé¥±è…¹åº¦è¿‡ä½æ—¶å¿ƒæƒ…åŠ é€Ÿä¸‹é™
- åœ¨ `scheduler.py` æ³¨å†Œæ¯æ—¥å®šæ—¶ä»»åŠ¡ï¼šå…ˆ `daily_attribute_decay()` å† `daily_production()`
- å±æ€§æŸ¥è¯¢ APIï¼ˆGET /api/city/agents/{id}/attributesï¼‰

**M5-4 äº¤æ˜“å¸‚åœºæœåŠ¡**
- æ–°å»º `market_service.py`
- `transfer(from_id, to_id, resource_code, amount)` â€” è½¬èµ ï¼Œæ ¡éªŒä½™é¢
- `create_order(seller_id, sell_resource, sell_amount, want_resource, unit_price)` â€” æŒ‚å•ï¼Œå†»ç»“å–å‡ºèµ„æº
- `accept_order(order_id, buyer_id, buy_amount)` â€” æ¥å•ï¼ˆæ”¯æŒéƒ¨åˆ†è´­ä¹°ï¼‰ï¼Œæ ¡éªŒï¼šæœ€å° 0.01ã€ä¹°å®¶å¯¹ä»·èµ„æºä½™é¢ã€ä¸¤è¾¹ >= 0.01
- `cancel_order(order_id, seller_id)` â€” æ’¤å•ï¼Œé€€å›å‰©ä½™å†»ç»“èµ„æº
- `get_orders(status, resource)` / `get_trade_logs()` â€” æŸ¥è¯¢
- äº¤æ˜“å¸‚åœº REST APIï¼ˆPOST /api/market/transfer, POST /api/market/orders, POST /api/market/orders/{id}/accept, POST /api/market/orders/{id}/cancel, GET /api/market/orders, GET /api/market/tradesï¼‰

**M5-5 è®°å¿†ç®¡ç†æœåŠ¡ + API**
- æ–°å»ºæˆ–æ‰©å±• `memory_admin_service.py`
- `list_memories(agent_id, memory_type, keyword, page, size)` â€” åˆ—è¡¨ + ç­›é€‰ + æœç´¢
- `get_memory_detail(memory_id)` â€” è¯¦æƒ…
- `create_memory(agent_id, memory_type, content)` â€” æ‰‹åŠ¨åˆ›å»º
- `update_memory(memory_id, content)` â€” ç¼–è¾‘
- `delete_memory(memory_id)` â€” åˆ é™¤
- `get_memory_stats(agent_id)` â€” ç»Ÿè®¡ï¼ˆæ•°é‡ã€ç±»å‹åˆ†å¸ƒï¼‰
- REST APIï¼ˆGET/POST/PUT/DELETE /api/memories/...ï¼‰

**M5-6 autonomy_loop é›†æˆ**
- æ‰©å±• `build_world_snapshot()`ï¼šæ–°å¢æ¯ä¸ª Agent çš„ä¸‰ç»´å±æ€§ã€ä¸ªäººèµ„æºèƒŒåŒ…ã€å»ºç­‘å·¥äººåˆ†é…ã€äº¤æ˜“å¸‚åœºæŒ‚å•
- æ‰©å±•å†³ç­–åŠ¨ä½œç±»å‹ï¼šæ–°å¢ assign_buildingã€eatã€create_orderã€accept_order
- æ‰©å±• `execute_decisions()`ï¼šå¤„ç†æ–°åŠ¨ä½œç±»å‹ï¼Œè°ƒç”¨å¯¹åº”æœåŠ¡
- ä½“åŠ›ä¸è¶³çš„ Agent åœ¨ prompt ä¸­æ ‡æ³¨"æ— æ³•å·¥ä½œ"
- æ§åˆ¶å¿«ç…§ token é‡ï¼ˆæ–°å¢ä¿¡æ¯å¯èƒ½å¯¼è‡´è†¨èƒ€ï¼Œéœ€å‹ç¼©ç­–ç•¥ï¼‰

#### å‰ç«¯ UI

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5-7 | åŸå¸‚ç»æµé¢æ¿ | å‰ç«¯ | M5-2, M5-3 | F19.1, F19.2, F19.3 | pending |
| M5-8 | äº¤æ˜“å¸‚åœºé¢æ¿ | å‰ç«¯ | M5-4 | F19.4 | pending |
| M5-9 | è®°å¿†ç®¡ç†é¢æ¿ | å‰ç«¯ | M5-5 | F18.1 ~ F18.6 | pending |
| M5-10 | WebSocket äº‹ä»¶æ¨é€ | å‰åç«¯ | M5-2, M5-3, M5-4 | F19.5 | pending |

**M5-7 åŸå¸‚ç»æµé¢æ¿**
- æ–°å»º `CityPanel.tsx`ï¼ˆæˆ–æ–°å¢ Tabï¼‰
- å»ºç­‘è§†å›¾ï¼šå»ºç­‘åˆ—è¡¨ã€ownerã€å·¥äººåˆ†é…ã€äº§å‡ºé…ç½®
- èµ„æºè§†å›¾ï¼šæ¯ä¸ª Agent çš„ä¸ªäººèµ„æºèƒŒåŒ…
- å±æ€§è§†å›¾ï¼šæ¯ä¸ª Agent çš„ä¸‰ç»´å±æ€§ï¼ˆé¥±è…¹åº¦/å¿ƒæƒ…/ä½“åŠ›ï¼‰è¿›åº¦æ¡
- ç®¡ç†å‘˜å¯æ‰‹åŠ¨åˆ†é…/å–æ¶ˆå·¥äººï¼ˆè°ƒç”¨ assign/unassign APIï¼‰

**M5-8 äº¤æ˜“å¸‚åœºé¢æ¿**
- æ–°å»º `MarketPanel.tsx`ï¼ˆæˆ– CityPanel å­ Tabï¼‰
- å½“å‰æŒ‚å•åˆ—è¡¨ï¼ˆå«éƒ¨åˆ†æˆäº¤è¿›åº¦æ¡ï¼‰
- å†å²æˆäº¤è®°å½•
- æŒ‚å•/æ¥å•/æ’¤å•æ“ä½œï¼ˆç®¡ç†å‘˜ä»£æ“ä½œ or çº¯å±•ç¤ºï¼‰

**M5-9 è®°å¿†ç®¡ç†é¢æ¿**
- æ–°å»º `MemoryAdmin.tsx`
- è®°å¿†åˆ—è¡¨ï¼šæŒ‰ Agentã€ç±»å‹ç­›é€‰ï¼Œå…³é”®è¯æœç´¢ï¼Œåˆ†é¡µ
- è®°å¿†è¯¦æƒ…å¼¹çª—
- åˆ›å»º/ç¼–è¾‘/åˆ é™¤æ“ä½œ
- ç»Ÿè®¡é¢æ¿ï¼šæ¯ä¸ª Agent çš„è®°å¿†æ•°é‡ã€ç±»å‹åˆ†å¸ƒ

**M5-10 WebSocket äº‹ä»¶æ¨é€**
- ç”Ÿäº§ç»“ç®—å®Œæˆ â†’ å¹¿æ’­ system_eventï¼ˆproduction_settledï¼‰
- å±æ€§å˜åŒ– â†’ å¹¿æ’­ system_eventï¼ˆattribute_changedï¼‰
- äº¤æ˜“æˆäº¤ â†’ å¹¿æ’­ system_eventï¼ˆtrade_completedï¼‰
- é¥®é£Ÿ â†’ å¹¿æ’­ system_eventï¼ˆagent_ateï¼‰
- å‰ç«¯ ActivityFeed æ‰©å±•æ”¯æŒæ–°äº‹ä»¶ç±»å‹

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5-11 | M5 ç«¯åˆ°ç«¯éªŒè¯ | é›†æˆ | M5-7, M5-8, M5-9, M5-10 | AC-M5-01 ~ AC-M5-24 | pending |

**M5-11 ç«¯åˆ°ç«¯éªŒè¯**
- åœºæ™¯ 1ï¼šAgent åˆ†é…åˆ°å†œç”° â†’ æ¯æ—¥ç”Ÿäº§ â†’ å°éº¦å…¥èƒŒåŒ…
- åœºæ™¯ 2ï¼šAgent åˆ†é…åˆ°å®˜åºœç”° â†’ æ¯æ—¥ç”Ÿäº§ â†’ å°éº¦ç²‰å…¥èƒŒåŒ…ï¼ˆè™šç©ºé€ å¸ï¼‰
- åœºæ™¯ 3ï¼šAgent åˆ†é…åˆ°ç£¨åŠ â†’ æœ‰å°éº¦æ—¶äº§å‡ºå°éº¦ç²‰ï¼Œæ— å°éº¦æ—¶è·³è¿‡
- åœºæ™¯ 4ï¼šAgent åƒå°éº¦ç²‰ â†’ ä¸‰ç»´å±æ€§æ¢å¤
- åœºæ™¯ 5ï¼šæ¯æ—¥å±æ€§ç»“ç®— â†’ é¥±è…¹åº¦ä¸‹é™ã€ä½“åŠ›æ¢å¤
- åœºæ™¯ 6ï¼šä½“åŠ›ä¸è¶³ â†’ ç”Ÿäº§è·³è¿‡è¯¥ Agent
- åœºæ™¯ 7ï¼šè½¬èµ èµ„æº â†’ åŒæ–¹èƒŒåŒ…æ­£ç¡®å˜åŒ–
- åœºæ™¯ 8ï¼šæŒ‚å• â†’ éƒ¨åˆ†è´­ä¹° â†’ æ’¤å• â†’ å…¨æµç¨‹æ­£ç¡®
- åœºæ™¯ 9ï¼šautonomy_loop è§¦å‘ â†’ Agent è‡ªä¸»é€‰æ‹©å»ºç­‘/åƒé¥­/äº¤æ˜“
- åœºæ™¯ 10ï¼šè®°å¿† CRUD å…¨æµç¨‹
- åœºæ™¯ 11ï¼šå‰ç«¯é¢æ¿æ­£ç¡®å±•ç¤ºæ‰€æœ‰æ•°æ®
- åœºæ™¯ 12ï¼šWebSocket å®æ—¶æ¨é€äº‹ä»¶

### å…³é”®è·¯å¾„

```
M5-1ï¼ˆæ•°æ®æ¨¡å‹ï¼‰â”€â”€â”¬â†’ M5-2ï¼ˆç”Ÿäº§ï¼‰â”€â”€â”¬â†’ M5-6ï¼ˆautonomy é›†æˆï¼‰â”€â”€â”
                  â”œâ†’ M5-3ï¼ˆå±æ€§ï¼‰â”€â”€â”¤                          â”‚
                  â”œâ†’ M5-4ï¼ˆäº¤æ˜“ï¼‰â”€â”€â”˜                          â”‚
                  â”‚                                            â”œâ†’ M5-11ï¼ˆé›†æˆéªŒè¯ï¼‰
M5-5ï¼ˆè®°å¿†ï¼‰â”€â”€â”€â”€â”€â”€â†’ M5-9ï¼ˆè®°å¿†é¢æ¿ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                               â”‚
M5-2/M5-3 â”€â”€â†’ M5-7ï¼ˆåŸå¸‚é¢æ¿ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
M5-4 â”€â”€â†’ M5-8ï¼ˆäº¤æ˜“é¢æ¿ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
M5-2/M5-3/M5-4 â”€â”€â†’ M5-10ï¼ˆWS æ¨é€ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ€é•¿è·¯å¾„ï¼šM5-1 â†’ M5-2/M5-3/M5-4 â†’ M5-6 â†’ M5-11

M5-5ï¼ˆè®°å¿†ï¼‰ä¸ M5-1 æ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå¯åŠ¨ã€‚å‰ç«¯ä»»åŠ¡ï¼ˆM5-7 ~ M5-10ï¼‰ç­‰å¯¹åº”åç«¯ API å°±ç»ªåè·Ÿè¿›ã€‚

### M5 éªŒæ”¶æ ‡å‡†

å¯¹åº” IR ä¸­ AC-M5-01 ~ AC-M5-24ï¼ŒæŒ‰ Phase åˆ†ç»„ï¼š

**Phase 1ï¼ˆæ•°æ®å±‚ + åç«¯æœåŠ¡ï¼ŒM5-1 ~ M5-5ï¼‰**
- [ ] æ•°æ®æ¨¡å‹è¿ç§»æˆåŠŸï¼Œseed æ•°æ®æ­£ç¡®
- [ ] ç”Ÿäº§ç»“ç®—ï¼šå†œç”°äº§å°éº¦ã€ç£¨åŠäº§å°éº¦ç²‰ã€å®˜åºœç”°è™šç©ºé€ å¸äº§å°éº¦ç²‰
- [ ] ä½“åŠ›ä¸è¶³å·¥äººè¢«è·³è¿‡
- [ ] åƒé¥­æ­£ç¡®æ‰£èµ„æºã€æ¢å¤å±æ€§
- [ ] æ¯æ—¥å±æ€§ç»“ç®—ï¼šé¥±è…¹åº¦ä¸‹é™ã€ä½“åŠ›æ¢å¤
- [ ] è½¬èµ æ­£ç¡®è½¬ç§»èµ„æº
- [ ] æŒ‚å•/æ¥å•/éƒ¨åˆ†è´­ä¹°/æ’¤å•å…¨æµç¨‹æ­£ç¡®
- [ ] æœ€å°äº¤æ˜“å•ä½ 0.01 æ ¡éªŒ
- [ ] è®°å¿† CRUD + ç»Ÿè®¡ API æ­£å¸¸

**Phase 2ï¼ˆautonomy é›†æˆï¼ŒM5-6ï¼‰**
- [ ] ä¸–ç•ŒçŠ¶æ€å¿«ç…§åŒ…å«ä¸‰ç»´å±æ€§ã€èµ„æºã€å»ºç­‘ã€æŒ‚å•
- [ ] LLM å†³ç­–æ–°å¢ assign_building/eat/create_order/accept_order
- [ ] ä½“åŠ›ä¸è¶³ Agent åœ¨ prompt ä¸­æ ‡æ³¨

**Phase 3ï¼ˆå‰ç«¯ + é›†æˆï¼ŒM5-7 ~ M5-11ï¼‰**
- [ ] åŸå¸‚é¢æ¿æ­£ç¡®å±•ç¤ºå»ºç­‘/èµ„æº/å±æ€§
- [ ] äº¤æ˜“å¸‚åœºé¢æ¿æ­£ç¡®å±•ç¤ºæŒ‚å•/æˆäº¤
- [ ] è®°å¿†ç®¡ç†é¢æ¿ CRUD å¯ç”¨
- [ ] WebSocket å®æ—¶æ¨é€ç”Ÿäº§/äº¤æ˜“/é¥®é£Ÿäº‹ä»¶
- [ ] ç«¯åˆ°ç«¯ 12 ä¸ªåœºæ™¯å…¨éƒ¨é€šè¿‡

---

## è¯„å®¡ç»“è®ºæ‘˜è¦

### å››æ–¹è¯„å®¡ï¼ˆ2026-02-14ï¼‰â€” âœ… Go

**å‚ä¸è€…**: Architectã€Tech Leadã€QA Leadã€Developer

**æ¶æ„è§†è§’ï¼ˆArchitectï¼‰**:
- âœ… æ¶æ„åŸºæœ¬ç¬¦åˆ
- âš ï¸ WebSocket å•è¿›ç¨‹å†…å­˜ Dict æ˜¯å•ç‚¹ç“¶é¢ˆï¼ˆå•æœºé˜¶æ®µå¯æ¥å—ï¼‰
- âš ï¸ N+1 æŸ¥è¯¢ â†’ å·²ä¿®å¤ï¼ˆJOIN åŠ è½½ï¼‰
- å»ºè®®ï¼šä¸­æœŸè®¾è®¡ ChatOrchestrator æŠ½è±¡

**æŠ€æœ¯è§†è§’ï¼ˆTech Leadï¼‰**:
- âœ… å®Œå…¨å¯è¡Œ
- é£é™©ï¼šOpenRouter å…è´¹æ¨¡å‹ç¨³å®šæ€§ï¼ˆéœ€é™çº§ç­–ç•¥ï¼‰ã€SQLite å¹¶å‘ï¼ˆWALï¼‰ã€LLM å»¶è¿Ÿï¼ˆå¼‚æ­¥è§£è€¦ï¼‰
- å»ºè®®ï¼šä¼˜å…ˆå®Œæˆçº¯èŠå¤©ï¼Œå†å åŠ  LLM å”¤é†’

**æµ‹è¯•è§†è§’ï¼ˆQA Leadï¼‰**:
- âš ï¸ å¯æµ‹è¯•æ€§ä¸­ç­‰ï¼ˆå°æ¨¡å‹éç¡®å®šæ€§éœ€ mockï¼‰
- 10 ä¸ªå…³é”®æµ‹è¯•åœºæ™¯å·²å®šä¹‰ï¼ˆ4 æ­£å¸¸ + 3 å¼‚å¸¸ + 3 è¾¹ç•Œï¼‰
- è¡¥å……é¡¹ï¼šAgent name å­—ç¬¦é›†æ ¡éªŒï¼ˆå·²å®ç°ï¼‰ã€å®šæ—¶è§¦å‘å‰ç½®æ¡ä»¶ã€since_id å¢é‡æ‹‰å–ï¼ˆPhase 2ï¼‰

**å®æ–½è§†è§’ï¼ˆDeveloperï¼‰**:
- å¤æ‚åº¦ä¸­ç­‰
- åç«¯ ~400-600 è¡Œã€å‰ç«¯ ~800-1200 è¡Œ

å®Œæ•´è¯„å®¡è®°å½•è§ [eval-review.md](eval-review.md)

---

## M5.1 â€” èµ„æºè½¬èµ  + Agent Tool Useï¼ˆå¾…æ‹†åˆ†ï¼‰

### ç›®æ ‡

è®© Agent åœ¨èŠå¤©å¯¹è¯ä¸­èƒ½è¯†åˆ«æŒ‡ä»¤å¹¶æ‰§è¡ŒçœŸå®åŠ¨ä½œï¼ˆä»"åªä¼šè¯´è¯"è¿›åŒ–åˆ°"èƒ½åšäº‹"ï¼‰ã€‚é¦–ä¸ªæ”¯æŒçš„åŠ¨ä½œæ˜¯èµ„æºè½¬èµ ï¼ŒåŒæ—¶å»ºç«‹ Tool Use æ¶æ„ï¼Œä¸ºåç»­åŠ¨ä½œæ‰©å±•æ‰“åŸºç¡€ã€‚å‰ç«¯å¼•å…¥ React Routerï¼Œæ–°å¢ç‹¬ç«‹äº¤æ˜“é¢æ¿è·¯ç”±ã€‚

å¯¹åº” IRï¼š`01-éœ€æ±‚åŸå‹.md` Â§M5.1ï¼ˆUS-M5.1-1 ~ US-M5.1-5, F21 ~ F24, AC-M5.1-01 ~ AC-M5.1-10ï¼‰

### ç°æœ‰åŸºç¡€

- âœ… `agent_runner.py` â€” `generate_reply()` å·²æœ‰ï¼Œä½¿ç”¨ `AsyncOpenAI` è°ƒç”¨ LLMï¼Œå½“å‰åªäº§å‡ºçº¯æ–‡æœ¬
- âœ… `city_service.py` â€” `transfer_resource()` å·²å®ç°ï¼ˆæ ¡éªŒ + æ‰£å‡ + å¢åŠ ï¼‰ï¼Œ**ç¼ºå°‘å¹¿æ’­è°ƒç”¨**
- âœ… `city_service.py` â€” `_broadcast_city_event()` è¾…åŠ©å‡½æ•°å·²å­˜åœ¨ï¼Œå¯ç›´æ¥è°ƒç”¨
- âœ… `city.py` â€” `POST /agents/transfer-resource` ç«¯ç‚¹å·²å­˜åœ¨
- âœ… `autonomy_service.py` â€” `execute_decisions()` å·²æ”¯æŒ 7 ç§ actionï¼ˆcheckin/purchase/chat/rest/assign_building/unassign_building/eatï¼‰
- âœ… `autonomy_service.py` â€” `build_world_snapshot()` å·²åŒ…å« Agent èµ„æºèƒŒåŒ…
- âœ… WebSocket å¹¿æ’­æœºåˆ¶å®Œæ•´ï¼ˆbroadcast / system_eventï¼‰
- âŒ `agent_runner.py` ä¸æ”¯æŒ function calling â€” éœ€æ–°å¢ tools å‚æ•° + tool_call å¤„ç†å¾ªç¯
- âŒ `transfer_resource()` æ‰§è¡Œåæ— å¹¿æ’­ â€” éœ€è¡¥è°ƒ `_broadcast_city_event()`
- âŒ `autonomy_service` ä¸æ”¯æŒ `transfer_resource` action â€” éœ€æ‰©å±•
- âŒ å‰ç«¯æ— è·¯ç”±ç³»ç»Ÿ â€” App.tsx ç›´æ¥æ¸²æŸ“ DiscordLayoutï¼Œéœ€å¼•å…¥ React Router
- âŒ å‰ç«¯æ— äº¤æ˜“é¢æ¿ â€” éœ€æ–°å»º TradePage ç»„ä»¶
- âŒ `types.ts` ç¼º `resource_transferred` äº‹ä»¶ç±»å‹
- âŒ `api.ts` ç¼º `transferResource()` å‡½æ•°

### ä»»åŠ¡åˆ†è§£

ä¸‰æ¡çº¿ï¼šåç«¯ Tool Useï¼ˆM5.1-1 ~ M5.1-3ï¼‰+ åç«¯è½¬èµ å®Œå–„ï¼ˆM5.1-4 ~ M5.1-5ï¼‰+ å‰ç«¯ï¼ˆM5.1-6 ~ M5.1-8ï¼‰ï¼Œæœ€åé›†æˆéªŒè¯ï¼ˆM5.1-9ï¼‰ã€‚

#### åç«¯ Tool Use æ¶æ„

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.1-1 | Tool Use æ¡†æ¶ + transfer_resource å·¥å…·æ³¨å†Œ | åç«¯ | â€” | F21.1 ~ F21.4, F21.7 | pending |
| M5.1-2 | agent_runner é›†æˆ Tool Use | åç«¯ | M5.1-1 | F21.3, F21.5, F21.6 | pending |
| M5.1-3 | autonomy_loop æ–°å¢ transfer_resource action | åç«¯ | M5.1-4 | F24.1 ~ F24.4 | pending |

**M5.1-1 Tool Use æ¡†æ¶ + transfer_resource å·¥å…·æ³¨å†Œ**

æ–°å»º `server/app/services/tool_registry.py`ï¼š

- `ToolDefinition` æ•°æ®ç±»ï¼šname, description, parametersï¼ˆJSON Schema dictï¼‰, handlerï¼ˆasync callableï¼‰
- `ToolRegistry` ç±»ï¼š
  - `register(tool: ToolDefinition)` â€” æ³¨å†Œå·¥å…·
  - `get_tools_for_llm() -> list[dict]` â€” è¿”å› OpenAI function calling æ ¼å¼çš„å·¥å…·å®šä¹‰åˆ—è¡¨
  - `execute(name: str, arguments: dict, context: dict) -> dict` â€” æ‰§è¡Œå·¥å…·ï¼Œè¿”å› `{"ok": bool, "result": str}` æˆ– `{"ok": false, "error": str}`
- æ³¨å†Œ `transfer_resource` å·¥å…·ï¼š
  - name: `transfer_resource`
  - description: "å°†è‡ªå·±çš„èµ„æºè½¬èµ ç»™å¦ä¸€ä¸ªå±…æ°‘"
  - parameters: `{"to_agent_id": int, "resource_type": str, "quantity": number}`
  - handler: è°ƒç”¨ `city_service.transfer_resource(context["agent_id"], to_agent_id, resource_type, quantity, context["db"])`
  - `from_agent_id` ä» context è‡ªåŠ¨å¡«å……ï¼ŒAgent ä¸èƒ½ä¼ªé€ èº«ä»½
- å…¨å±€å•ä¾‹ `tool_registry`ï¼Œåœ¨æ¨¡å—åŠ è½½æ—¶æ³¨å†Œ transfer_resource
- TODO æ³¨é‡Šæ ‡è®°ï¼šå‡è®¾æ‰€æœ‰æ¨¡å‹æ”¯æŒ function callingï¼Œåç»­æŒ‰éœ€è¡¥é™çº§é€»è¾‘

æ”¹åŠ¨èŒƒå›´ï¼šæ–°å»º 1 ä¸ªæ–‡ä»¶ï¼ˆ~80 è¡Œï¼‰

**M5.1-2 agent_runner é›†æˆ Tool Use**

ä¿®æ”¹ `server/app/services/agent_runner.py` çš„ `generate_reply()` æ–¹æ³•ï¼š

- ä» `tool_registry` è·å–å·¥å…·å®šä¹‰åˆ—è¡¨ï¼Œä¼ å…¥ LLM è°ƒç”¨çš„ `tools` å‚æ•°
- LLM è¿”å›åæ£€æŸ¥ `response.choices[0].message.tool_calls`ï¼š
  - æ—  tool_call â†’ èµ°ç°æœ‰çº¯æ–‡æœ¬è·¯å¾„ï¼ˆä¸å˜ï¼‰
  - æœ‰ tool_call â†’ è°ƒç”¨ `tool_registry.execute(name, arguments, context)`
  - å°†æ‰§è¡Œç»“æœä½œä¸º `tool` role message è¿½åŠ åˆ° messages
  - å†æ¬¡è°ƒç”¨ LLMï¼Œè®© Agent åŸºäºæ‰§è¡Œç»“æœç”Ÿæˆæœ€ç»ˆè‡ªç„¶è¯­è¨€å›å¤
- context æ„å»ºï¼š`{"agent_id": self.agent_id, "db": db}`
- `generate_reply()` ç­¾åä¸å˜ï¼Œè°ƒç”¨æ–¹æ— æ„ŸçŸ¥
- å·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ï¼Œerror ä¿¡æ¯åŒæ ·åé¦ˆç»™ LLMï¼ŒAgent ç”¨è‡ªç„¶è¯­è¨€è§£é‡Š

æ”¹åŠ¨èŒƒå›´ï¼šä¿®æ”¹ 1 ä¸ªæ–‡ä»¶ï¼ˆ`agent_runner.py`ï¼Œ+~40 è¡Œï¼‰

**M5.1-3 autonomy_loop æ–°å¢ transfer_resource action**

ä¿®æ”¹ `server/app/services/autonomy_service.py`ï¼š

- `SYSTEM_PROMPT` æ–°å¢ç¬¬ 8 ç§è¡Œä¸ºï¼š`transfer_resource` â€” å°†è‡ªå·±çš„èµ„æºè½¬èµ ç»™å…¶ä»–å±…æ°‘
  - å‚æ•°ï¼š`{"to_agent_id": <int>, "resource_type": "<str>", "quantity": <number>}`
  - å†³ç­–æç¤ºï¼šå½“è‡ªå·±èµ„æºå……è£•ä¸”æœ‰å±…æ°‘èµ„æºåŒ®ä¹æ—¶å¯è€ƒè™‘è½¬èµ 
- `execute_decisions()` æ–°å¢ `transfer_resource` åˆ†æ”¯ï¼š
  - è°ƒç”¨ `city_service.transfer_resource(agent_id, params["to_agent_id"], params["resource_type"], params["quantity"], db)`
  - æˆåŠŸ/å¤±è´¥è®¡å…¥ç»Ÿè®¡

æ”¹åŠ¨èŒƒå›´ï¼šä¿®æ”¹ 1 ä¸ªæ–‡ä»¶ï¼ˆ`autonomy_service.py`ï¼Œ+~15 è¡Œï¼‰

#### åç«¯è½¬èµ å®Œå–„

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.1-4 | transfer_resource è¡¥å¹¿æ’­ | åç«¯ | â€” | F22.1 ~ F22.3 | pending |
| M5.1-5 | è½¬èµ  API ç¡®è®¤ | åç«¯ | M5.1-4 | â€” | pending |

**M5.1-4 transfer_resource è¡¥å¹¿æ’­**

ä¿®æ”¹ `server/app/services/city_service.py` çš„ `transfer_resource()` æ–¹æ³•ï¼š

- åœ¨è½¬èµ æˆåŠŸï¼ˆ`ok=True`ï¼‰åï¼Œè°ƒç”¨ `_broadcast_city_event("resource_transferred", {...})`
- å¹¿æ’­æ•°æ®ï¼š`from_agent_id`, `from_agent_name`, `to_agent_id`, `to_agent_name`, `resource_type`, `quantity`
- éœ€è¦åœ¨å‡½æ•°å†…æŸ¥è¯¢ from/to Agent çš„ nameï¼ˆæˆ–ä»è°ƒç”¨æ–¹ä¼ å…¥ï¼‰
- è½¬èµ æ˜¯ç§äººè¡Œä¸ºï¼Œä¸åœ¨èŠå¤©åŒºæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼Œåªæ¨é€ system_event ç»™å‰ç«¯äº¤æ˜“é¢æ¿å¤„ç†

æ”¹åŠ¨èŒƒå›´ï¼šä¿®æ”¹ 1 ä¸ªæ–‡ä»¶ï¼ˆ`city_service.py`ï¼Œ+~10 è¡Œï¼‰

**M5.1-5 è½¬èµ  API ç¡®è®¤**

ç¡®è®¤ `server/app/api/city.py` çš„ `POST /agents/transfer-resource` ç«¯ç‚¹ï¼š

- ç«¯ç‚¹å·²å­˜åœ¨ï¼Œè°ƒç”¨ `city_service.transfer_resource()`
- M5.1-4 è¡¥å¹¿æ’­åï¼ŒAPI è°ƒç”¨è‡ªåŠ¨è§¦å‘å¹¿æ’­ï¼Œæ— éœ€é¢å¤–æ”¹åŠ¨
- éªŒè¯ï¼šæ‰‹åŠ¨è°ƒç”¨ API â†’ è½¬èµ æˆåŠŸ â†’ WebSocket æ”¶åˆ° `resource_transferred` äº‹ä»¶

æ”¹åŠ¨èŒƒå›´ï¼šæ— ä»£ç æ”¹åŠ¨ï¼Œä»…éªŒè¯

#### å‰ç«¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.1-6 | å¼•å…¥ React Router + è·¯ç”±é…ç½® | å‰ç«¯ | â€” | F23.1 | pending |
| M5.1-7 | ç±»å‹ + API æ‰©å±• | å‰ç«¯ | â€” | F22.4 ~ F22.6 | pending |
| M5.1-8 | TradePage äº¤æ˜“é¢æ¿ | å‰ç«¯ | M5.1-6, M5.1-7, M5.1-4 | F23.1 ~ F23.4 | pending |

**M5.1-6 å¼•å…¥ React Router + è·¯ç”±é…ç½®**

- å®‰è£… `react-router-dom`
- ä¿®æ”¹ `App.tsx`ï¼šå¼•å…¥ `BrowserRouter` + `Routes` + `Route`
  - `/` â†’ `<DiscordLayout />`ï¼ˆç°æœ‰ä¸»ç•Œé¢ï¼‰
  - `/trade` â†’ `<TradePage />`ï¼ˆæ–°äº¤æ˜“é¢æ¿ï¼‰
- ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼Œ`/` è·¯ç”±è¡Œä¸ºä¸æ”¹é€ å‰å®Œå…¨ä¸€è‡´

æ”¹åŠ¨èŒƒå›´ï¼šä¿®æ”¹ 1 ä¸ªæ–‡ä»¶ï¼ˆ`App.tsx`ï¼Œ+~10 è¡Œï¼‰ï¼Œå®‰è£… 1 ä¸ªä¾èµ–

**M5.1-7 ç±»å‹ + API æ‰©å±•**

ä¿®æ”¹ `web/src/types.ts`ï¼š
- `WsSystemEvent.event` è”åˆç±»å‹æ–°å¢ `"resource_transferred"`
- æ–°å¢å¯é€‰å­—æ®µï¼š`from_agent_name?`, `to_agent_name?`, `resource_type?`, `quantity?`

ä¿®æ”¹ `web/src/api.ts`ï¼š
- æ–°å¢ `transferResource(fromAgentId: number, toAgentId: number, resourceType: string, quantity: number): Promise<{ok: boolean, reason: string}>`
- å¤ç”¨ç°æœ‰ fetch æ¨¡å¼

æ–°å¢ `web/src/types.ts` ä¸­ `TransferResult` ç±»å‹ï¼š`{ok: boolean, reason: string}`

æ”¹åŠ¨èŒƒå›´ï¼šä¿®æ”¹ 2 ä¸ªæ–‡ä»¶ï¼ˆ`types.ts` +~5 è¡Œï¼Œ`api.ts` +~15 è¡Œï¼‰

**M5.1-8 TradePage äº¤æ˜“é¢æ¿**

æ–°å»º `web/src/pages/TradePage.tsx`ï¼š

- ä¸‰ä¸ªåŒºå—ï¼š
  1. **Agent èµ„æºæ¦‚è§ˆ**ï¼šè°ƒç”¨ `fetchCityOverview()` å±•ç¤ºæ¯ä¸ª Agent çš„èµ„æºèƒŒåŒ…ï¼ˆå¤ç”¨ç°æœ‰ APIï¼‰
  2. **è½¬èµ è¡¨å•**ï¼šé€‰æ‹©å‘é€æ–¹ Agentï¼ˆä¸‹æ‹‰ï¼‰ã€æ¥æ”¶æ–¹ Agentï¼ˆä¸‹æ‹‰ï¼‰ã€èµ„æºç±»å‹ï¼ˆä¸‹æ‹‰ï¼‰ã€æ•°é‡ï¼ˆè¾“å…¥æ¡†ï¼‰ã€æäº¤æŒ‰é’®
     - æäº¤è°ƒç”¨ `transferResource()` API
     - æˆåŠŸ/å¤±è´¥ toast æç¤º
  3. **è½¬èµ å†å²**ï¼šç›‘å¬ WebSocket `resource_transferred` äº‹ä»¶ï¼Œå®æ—¶è¿½åŠ åˆ°åˆ—è¡¨
     - æ˜¾ç¤ºï¼šæ—¶é—´ã€å‘é€æ–¹ã€æ¥æ”¶æ–¹ã€èµ„æºç±»å‹ã€æ•°é‡
     - æœ€å¤šæ˜¾ç¤ºæœ€è¿‘ 50 æ¡ï¼ŒFIFO æ·˜æ±°
- é¡µé¢é¡¶éƒ¨å¯¼èˆªï¼šè¿”å›ä¸»ç•Œé¢é“¾æ¥ï¼ˆ`/`ï¼‰
- å¤ç”¨ `useWebSocket` hook ç›‘å¬äº‹ä»¶

æ”¹åŠ¨èŒƒå›´ï¼šæ–°å»º 1 ä¸ªæ–‡ä»¶ï¼ˆ`TradePage.tsx`ï¼Œ~150 è¡Œï¼‰

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.1-9 | M5.1 ç«¯åˆ°ç«¯éªŒè¯ | é›†æˆ | M5.1-2, M5.1-3, M5.1-8 | AC-M5.1-01 ~ AC-M5.1-10 | pending |

**M5.1-9 ç«¯åˆ°ç«¯éªŒè¯**

- åœºæ™¯ 1ï¼ˆAC-01ï¼‰ï¼šäººç±» @Alice "æŠŠ 5 å°éº¦ç»™ Bob" â†’ Alice è°ƒç”¨ transfer_resource å·¥å…· â†’ è½¬èµ æˆåŠŸ â†’ å›å¤ç¡®è®¤
- åœºæ™¯ 2ï¼ˆAC-02ï¼‰ï¼šäººç±» @Alice "æŠŠ 5 å°éº¦ç»™ Bob"ï¼ŒAlice å°éº¦ä¸è¶³ â†’ å·¥å…·æ‰§è¡Œå¤±è´¥ â†’ Alice å›å¤"å°éº¦ä¸è¶³"
- åœºæ™¯ 3ï¼ˆAC-03ï¼‰ï¼šäººç±» @Alice "æŠŠå°éº¦ç»™ Bob"ï¼ˆæœªæŒ‡å®šæ•°é‡ï¼‰â†’ Alice è‡ªä¸»å†³å®šæˆ–è¯¢é—®
- åœºæ™¯ 4ï¼ˆAC-04ï¼‰ï¼šBob @Alice "èƒ½ç»™æˆ‘ç‚¹å°éº¦å—" â†’ Alice è‡ªä¸»å†³å®šæ˜¯å¦è½¬èµ 
- åœºæ™¯ 5ï¼ˆAC-05ï¼‰ï¼šäººç±» @Alice "å»å†œç”°å·¥ä½œ" â†’ Alice åªå›å¤æ–‡æœ¬ï¼Œä¸è°ƒç”¨å·¥å…·
- åœºæ™¯ 6ï¼ˆAC-06ï¼‰ï¼šè½¬èµ æˆåŠŸ â†’ æ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯æ”¶åˆ° `resource_transferred` äº‹ä»¶
- åœºæ™¯ 7ï¼ˆAC-07ï¼‰ï¼šautonomy_loop è§¦å‘ â†’ Agent å¯èƒ½å†³ç­– transfer_resource
- åœºæ™¯ 8ï¼ˆAC-08ï¼‰ï¼šå‰ç«¯äº¤æ˜“é¢æ¿æ‰‹åŠ¨è½¬èµ  â†’ æˆåŠŸ â†’ é¡µé¢æ›´æ–°
- åœºæ™¯ 9ï¼ˆAC-09ï¼‰ï¼šå‰ç«¯æ”¶åˆ° resource_transferred äº‹ä»¶ â†’ è½¬èµ å†å²å®æ—¶æ›´æ–°
- åœºæ™¯ 10ï¼ˆAC-10ï¼‰ï¼šç¡®è®¤ä»£ç ä¸­æœ‰ TODO æ³¨é‡Šæ ‡è®° function calling é™çº§å‡è®¾

### å…³é”®è·¯å¾„

```
M5.1-1ï¼ˆTool æ¡†æ¶ï¼‰â†’ M5.1-2ï¼ˆrunner é›†æˆï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚
M5.1-4ï¼ˆè¡¥å¹¿æ’­ï¼‰â†’ M5.1-3ï¼ˆautonomy æ‰©å±•ï¼‰                â”‚
       â†“                                                  â”œâ†’ M5.1-9ï¼ˆé›†æˆéªŒè¯ï¼‰
M5.1-5ï¼ˆAPI éªŒè¯ï¼‰                                        â”‚
                                                          â”‚
M5.1-6ï¼ˆReact Routerï¼‰â”€â”€â”                                â”‚
M5.1-7ï¼ˆç±»å‹ + APIï¼‰â”€â”€â”€â”€â”¼â†’ M5.1-8ï¼ˆTradePageï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ€é•¿è·¯å¾„ï¼šM5.1-1 â†’ M5.1-2 â†’ M5.1-9

å¹¶è¡Œæœºä¼šï¼š
- M5.1-1 å’Œ M5.1-4 æ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå¯åŠ¨
- M5.1-6 å’Œ M5.1-7 æ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå¯åŠ¨
- å‰ç«¯çº¿ï¼ˆM5.1-6/7/8ï¼‰ä¸åç«¯ Tool Use çº¿ï¼ˆM5.1-1/2ï¼‰å¯å¹¶è¡Œ

### M5.1 éªŒæ”¶æ ‡å‡†

å¯¹åº” IR ä¸­ AC-M5.1-01 ~ AC-M5.1-10ï¼ŒæŒ‰ Phase åˆ†ç»„ï¼š

**Phase 1ï¼ˆåç«¯ Tool Use + è½¬èµ å®Œå–„ï¼ŒM5.1-1 ~ M5.1-5ï¼‰**
- [ ] Tool æ¡†æ¶å¯æ³¨å†Œ/æ‰§è¡Œå·¥å…·ï¼Œtransfer_resource å·¥å…·å·²æ³¨å†Œ
- [ ] agent_runner æ”¯æŒ function callingï¼ŒLLM å¯è°ƒç”¨å·¥å…·
- [ ] å·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ LLM æ”¶åˆ°é”™è¯¯ä¿¡æ¯å¹¶ç”Ÿæˆè‡ªç„¶è¯­è¨€è§£é‡Š
- [ ] transfer_resource æˆåŠŸåå¹¿æ’­ resource_transferred äº‹ä»¶
- [ ] autonomy_loop æ”¯æŒ transfer_resource å†³ç­–

**Phase 2ï¼ˆå‰ç«¯ï¼ŒM5.1-6 ~ M5.1-8ï¼‰**
- [ ] React Router å¼•å…¥ï¼Œ/ å’Œ /trade è·¯ç”±æ­£å¸¸å·¥ä½œ
- [ ] types.ts æ”¯æŒ resource_transferred äº‹ä»¶ç±»å‹
- [ ] api.ts transferResource() å‡½æ•°å¯ç”¨
- [ ] TradePage è½¬èµ è¡¨å• + å†å² + èµ„æºæ¦‚è§ˆæ­£å¸¸å·¥ä½œ

**Phase 3ï¼ˆé›†æˆéªŒè¯ï¼ŒM5.1-9ï¼‰**
- [ ] 10 ä¸ª AC åœºæ™¯å…¨éƒ¨é€šè¿‡

---

## M5.2 â€” äº¤æ˜“å¸‚åœºï¼ˆæŒ‚å•/æ¥å•/æ’¤å•ï¼‰ï¼ˆå¾…æ‹†åˆ†ï¼‰

### ç›®æ ‡

åœ¨ M5.1 èµ„æºè½¬èµ çš„åŸºç¡€ä¸Šï¼Œå»ºç«‹ä»¥ç‰©æ˜“ç‰©çš„äº¤æ˜“å¸‚åœºã€‚Agent å¯ä»¥æŒ‚å•å–å‡ºã€æ¥å•è´­ä¹°ï¼ˆæ”¯æŒéƒ¨åˆ†è´­ä¹°ï¼‰ã€æ’¤å•ã€‚åŒæ—¶æ‰©å±• autonomy_loop å’Œ Tool Use æ”¯æŒäº¤æ˜“æ“ä½œï¼Œè®© Agent èƒ½è‡ªä¸»äº¤æ˜“å’Œé€šè¿‡èŠå¤©äº¤æ˜“ã€‚

å¯¹åº” IRï¼š`01-éœ€æ±‚åŸå‹.md` Â§M5.2ï¼ˆUS-M5.2-1 ~ US-M5.2-7, F25 ~ F30, AC-M5.2-01 ~ AC-M5.2-20ï¼‰

### ç°æœ‰åŸºç¡€

- âœ… `AgentResource` è¡¨å·²æœ‰ï¼ˆagent_id, resource_type, quantityï¼‰â€” éœ€è¿ç§» quantity ä¸º Float + æ–°å¢ frozen_amount
- âœ… `city_service.py` â€” transfer_resourceã€_broadcast_city_eventã€_get_or_create_agent_resource å·²æœ‰
- âœ… `tool_registry.py` â€” Tool Use æ¡†æ¶å·²æœ‰ï¼Œtransfer_resource å·¥å…·å·²æ³¨å†Œï¼Œå¯ç›´æ¥å¤ç”¨æ³¨å†Œæ¨¡å¼
- âœ… `autonomy_service.py` â€” å·²æ”¯æŒ 8 ç§ actionï¼ˆcheckin/purchase/chat/rest/assign_building/unassign_building/eat/transfer_resourceï¼‰
- âœ… `TradePage.tsx` â€” å·²æœ‰è½¬èµ è¡¨å• + è½¬èµ å†å² + èµ„æºæ¦‚è§ˆï¼Œå¯æ‰©å±•äº¤æ˜“å¸‚åœºåŒºå—
- âœ… `types.ts` â€” WsSystemEvent å·²æœ‰ resource_transferred äº‹ä»¶ç±»å‹
- âœ… `api.ts` â€” å·²æœ‰ transferResource() å‡½æ•°ï¼Œå¯å¤ç”¨ fetch æ¨¡å¼
- âŒ MarketOrder / TradeLog è¡¨ â€” éœ€æ–°å»º
- âŒ market_service.py â€” éœ€æ–°å»º
- âŒ äº¤æ˜“å¸‚åœº API è·¯ç”± â€” éœ€æ–°å»º
- âŒ å‰ç«¯äº¤æ˜“å¸‚åœºåŒºå— â€” éœ€æ–°å»º
- âŒ autonomy_loop ä¸æ”¯æŒ create_order / accept_order â€” éœ€æ‰©å±•
- âŒ Tool Use æ—  create_market_order / accept_market_order å·¥å…· â€” éœ€æ³¨å†Œ

### ä»»åŠ¡åˆ†è§£

å››æ¡çº¿ï¼šæ•°æ®å±‚ï¼ˆM5.2-1ï¼‰â†’ åç«¯æœåŠ¡ + APIï¼ˆM5.2-2 ~ M5.2-4ï¼‰â†’ å‰ç«¯ UIï¼ˆM5.2-5ï¼‰â†’ é›†æˆéªŒè¯ï¼ˆM5.2-6ï¼‰ã€‚

#### æ•°æ®å±‚

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.2-1 | æ•°æ®æ¨¡å‹è¿ç§» + æ–°è¡¨ | åç«¯ | â€” | F25, F26, F27 å‰ç½® | pending |

**M5.2-1 æ•°æ®æ¨¡å‹è¿ç§» + æ–°è¡¨**

- AgentResource è¡¨è¿ç§»ï¼šquantity ä» Integer æ”¹ä¸º Floatï¼Œæ–°å¢ frozen_amountï¼ˆFloat, é»˜è®¤ 0ï¼‰
- æ–°å»º MarketOrder è¡¨ï¼šid, seller_id(FK agents.id), sell_resource(String), sell_amount(Float), sell_remaining(Float), want_resource(String), unit_price(Float), status(String, é»˜è®¤ 'open'), created_at(DateTime), updated_at(DateTime)
- æ–°å»º TradeLog è¡¨ï¼šid, order_id(FK market_orders.id), buyer_id(FK agents.id), sell_resource(String), buy_amount(Float), want_resource(String), pay_amount(Float), created_at(DateTime)
- è¿ç§»å‡½æ•°ï¼šæ£€æµ‹å¹¶æ‰§è¡Œ ALTER TABLEï¼ˆSQLite å…¼å®¹æ–¹å¼ï¼‰
- ç°æœ‰ transfer_resource / daily_production ç­‰æ¶‰åŠ quantity çš„ä»£ç éœ€å…¼å®¹ Floatï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰æ•´æ•°å‡è®¾ï¼‰

#### åç«¯æœåŠ¡ + API

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.2-2 | äº¤æ˜“å¸‚åœºæœåŠ¡ï¼ˆmarket_service.pyï¼‰ | åç«¯ | M5.2-1 | F25, F26, F27 | pending |
| M5.2-3 | äº¤æ˜“å¸‚åœº REST API | åç«¯ | M5.2-2 | F25, F26, F27 | pending |
| M5.2-4 | autonomy_loop + Tool Use æ‰©å±• | åç«¯ | M5.2-2 | F29, F30 | pending |

**M5.2-2 äº¤æ˜“å¸‚åœºæœåŠ¡ï¼ˆmarket_service.pyï¼‰**

æ–°å»º `server/app/services/market_service.py`ï¼š

- `create_order(seller_id, sell_resource, sell_amount, want_resource, unit_price, db)` â€” æŒ‚å•
  - æ ¡éªŒï¼šsell_amount >= 0.01, unit_price > 0
  - æ£€æŸ¥å–å®¶å¯ç”¨ä½™é¢ï¼ˆquantity - frozen_amount >= sell_amountï¼‰
  - å†»ç»“èµ„æºï¼šfrozen_amount += sell_amount
  - åˆ›å»º MarketOrderï¼ˆstatus=openï¼‰
  - å¹¿æ’­ order_created äº‹ä»¶
  - è¿”å› order ä¿¡æ¯

- `accept_order(order_id, buyer_id, buy_amount, db)` â€” æ¥å•ï¼ˆæ”¯æŒéƒ¨åˆ†è´­ä¹°ï¼‰
  - æ ¡éªŒï¼šbuy_amount >= 0.01, buy_amount <= sell_remaining
  - è®¡ç®— pay_amount = buy_amount Ã— unit_priceï¼Œæ ¡éªŒ pay_amount >= 0.01
  - æ ¡éªŒä¹°å®¶å¯¹ä»·èµ„æºå¯ç”¨ä½™é¢ >= pay_amount
  - æ ¡éªŒ buyer_id != seller_id
  - æ‰§è¡Œäº¤æ¢ï¼šå–å®¶ frozen_amount -= buy_amountï¼Œä¹°å®¶èµ„æº += buy_amountï¼›ä¹°å®¶å¯¹ä»·èµ„æº -= pay_amountï¼Œå–å®¶å¯¹ä»·èµ„æº += pay_amount
  - æ›´æ–° sell_remainingï¼Œæ›´æ–°çŠ¶æ€ï¼ˆpartial / fulfilledï¼‰
  - è®°å½• TradeLog
  - å¹¿æ’­ order_traded äº‹ä»¶
  - è¿”å›äº¤æ˜“ç»“æœ

- `cancel_order(order_id, seller_id, db)` â€” æ’¤å•
  - æ ¡éªŒï¼šå–å•å­˜åœ¨ã€seller_id åŒ¹é…ã€çŠ¶æ€ä¸º open æˆ– partial
  - é€€å›å†»ç»“èµ„æºï¼šfrozen_amount -= sell_remaining
  - çŠ¶æ€æ”¹ä¸º cancelled
  - å¹¿æ’­ order_cancelled äº‹ä»¶
  - è¿”å›ç»“æœ

- `get_orders(status, resource, db)` â€” æŸ¥è¯¢æŒ‚å•åˆ—è¡¨
- `get_trade_logs(limit, db)` â€” æŸ¥è¯¢æˆäº¤å†å²

**M5.2-3 äº¤æ˜“å¸‚åœº REST API**

æ–°å»º `server/app/api/market.py`ï¼Œæ³¨å†Œåˆ° main.pyï¼š

- `POST /api/market/orders` â€” åˆ›å»ºæŒ‚å•
- `GET /api/market/orders` â€” æŸ¥è¯¢æŒ‚å•åˆ—è¡¨ï¼ˆæ”¯æŒ status ç­›é€‰ï¼‰
- `POST /api/market/orders/{order_id}/accept` â€” æ¥å•è´­ä¹°
- `POST /api/market/orders/{order_id}/cancel` â€” æ’¤å•
- `GET /api/market/trades` â€” æŸ¥è¯¢æˆäº¤å†å²

**M5.2-4 autonomy_loop + Tool Use æ‰©å±•**

autonomy_service.py ä¿®æ”¹ï¼š
- SYSTEM_PROMPT æ–°å¢ç¬¬ 9ã€10 ç§è¡Œä¸ºï¼šcreate_orderï¼ˆæŒ‚å•ï¼‰ã€accept_orderï¼ˆæ¥å•ï¼‰
- build_world_snapshot() æ–°å¢å¸‚åœºæŒ‚å•æ‘˜è¦ï¼ˆopen/partial çŠ¶æ€çš„å–å•åˆ—è¡¨ï¼‰
- execute_decisions() æ–°å¢ create_order / accept_order åˆ†æ”¯

tool_registry.py ä¿®æ”¹ï¼š
- æ³¨å†Œ `create_market_order` å·¥å…·ï¼ˆå‚æ•°ï¼šsell_resource, sell_amount, want_resource, unit_priceï¼‰
- æ³¨å†Œ `accept_market_order` å·¥å…·ï¼ˆå‚æ•°ï¼šorder_id, buy_amountï¼‰
- handler è°ƒç”¨ market_service å¯¹åº”å‡½æ•°ï¼Œagent_id ä» context è‡ªåŠ¨å¡«å……

#### å‰ç«¯ UI

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.2-5 | äº¤æ˜“å¸‚åœºå‰ç«¯ | å‰ç«¯ | M5.2-3 | F28 | pending |

**M5.2-5 äº¤æ˜“å¸‚åœºå‰ç«¯**

æ‰©å±• `web/src/pages/TradePage.tsx`ï¼š

- types.ts æ‰©å±•ï¼š
  - WsSystemEvent.event æ–°å¢ `order_created` / `order_traded` / `order_cancelled`
  - æ–°å¢ MarketOrderã€TradeLog ç±»å‹

- api.ts æ‰©å±•ï¼š
  - `getMarketOrders(status?)` â€” æŸ¥è¯¢æŒ‚å•
  - `createMarketOrder(sellerId, sellResource, sellAmount, wantResource, unitPrice)` â€” åˆ›å»ºæŒ‚å•
  - `acceptMarketOrder(orderId, buyerId, buyAmount)` â€” æ¥å•
  - `cancelMarketOrder(orderId, sellerId)` â€” æ’¤å•
  - `getTradeHistory(limit?)` â€” æŸ¥è¯¢æˆäº¤å†å²

- TradePage æ–°å¢"äº¤æ˜“å¸‚åœº"åŒºå—ï¼ˆä¸ç°æœ‰è½¬èµ åŒºå—å¹¶åˆ—ï¼‰ï¼š
  - æŒ‚å•åˆ—è¡¨ï¼šå–å®¶ã€å–å‡ºèµ„æºã€å‰©ä½™/æ€»é‡ï¼ˆè¿›åº¦æ¡ï¼‰ã€æƒ³è¦èµ„æºã€å•ä»·ã€æ“ä½œæŒ‰é’®
  - åˆ›å»ºæŒ‚å•è¡¨å•
  - ä¹°å…¥è¡¨å•/å¼¹çª—ï¼ˆè¾“å…¥è´­ä¹°æ•°é‡ï¼Œæ˜¾ç¤ºéœ€æ”¯ä»˜å¯¹ä»·ï¼‰
  - æˆäº¤å†å²åˆ—è¡¨
  - WebSocket ç›‘å¬ order_created/order_traded/order_cancelled äº‹ä»¶å®æ—¶åˆ·æ–°

#### é›†æˆéªŒè¯

| ID | ä»»åŠ¡ | ç»ˆç«¯ | ä¾èµ– | è¦†ç›– IR | çŠ¶æ€ |
|----|------|------|------|---------|------|
| M5.2-6 | M5.2 ç«¯åˆ°ç«¯éªŒè¯ï¼ˆSTï¼‰ | é›†æˆ | M5.2-4, M5.2-5 | AC-M5.2-01 ~ AC-M5.2-20 | pending |

**M5.2-6 ç«¯åˆ°ç«¯éªŒè¯**

æ–°å»º `server/e2e_m5_2.py`ï¼Œè¦†ç›– 20 ä¸ª AC åœºæ™¯ï¼š

- ST-1: æŒ‚å•æˆåŠŸ + èµ„æºå†»ç»“éªŒè¯ï¼ˆAC-01ï¼‰
- ST-2: å¯ç”¨ä½™é¢ä¸è¶³æŒ‚å•å¤±è´¥ï¼ˆAC-02ï¼‰
- ST-3: å…¨é‡è´­ä¹° + èµ„æºäº¤æ¢éªŒè¯ï¼ˆAC-03ï¼‰
- ST-4: éƒ¨åˆ†è´­ä¹° + å–å•çŠ¶æ€ partialï¼ˆAC-04ï¼‰
- ST-5: æœ€å°äº¤æ˜“å•ä½æ ¡éªŒï¼ˆAC-05ï¼‰
- ST-6: ä¹°å®¶å¯¹ä»·èµ„æºä¸è¶³ï¼ˆAC-06ï¼‰
- ST-7: ä¸èƒ½è´­ä¹°è‡ªå·±çš„å–å•ï¼ˆAC-07ï¼‰
- ST-8: è´­ä¹°é‡è¶…å‡ºå‰©ä½™ï¼ˆAC-08ï¼‰
- ST-9: æ’¤å•ï¼ˆopenï¼‰+ å†»ç»“é€€å›ï¼ˆAC-09ï¼‰
- ST-10: æ’¤å•ï¼ˆpartialï¼‰+ éƒ¨åˆ†é€€å›ï¼ˆAC-10ï¼‰
- ST-11: fulfilled/cancelled ä¸å¯æ’¤ï¼ˆAC-11ï¼‰
- ST-12: éå–å®¶ä¸å¯æ’¤ï¼ˆAC-12ï¼‰
- ST-13: å¹¶å‘è´­ä¹°ä¸€è‡´æ€§ï¼ˆAC-13ï¼‰
- ST-14~16: WebSocket äº‹ä»¶æ¨é€ï¼ˆAC-14/15/16ï¼‰
- ST-17~18: autonomy_loop create_order / accept_orderï¼ˆAC-17/18ï¼Œå¯ mock LLM è¿”å›å›ºå®šå†³ç­–ï¼‰
- ST-19: Tool Use èŠå¤©æŒ‚å•ï¼ˆAC-19ï¼Œéœ€çœŸå® LLMï¼‰
- ST-20: å‰ç«¯é¢æ¿åŠ è½½éªŒè¯ï¼ˆAC-20ï¼ŒHTTP æ£€æŸ¥ API è¿”å›ï¼‰

### å…³é”®è·¯å¾„

```
M5.2-1ï¼ˆæ•°æ®è¿ç§»ï¼‰â†’ M5.2-2ï¼ˆmarket_serviceï¼‰â†’ M5.2-3ï¼ˆREST APIï¼‰â”€â”€â”
                                                â†“                    â”‚
                                          M5.2-4ï¼ˆautonomy + Tool Useï¼‰â”‚
                                                                     â”œâ†’ M5.2-6ï¼ˆSTï¼‰
                                          M5.2-5ï¼ˆå‰ç«¯ï¼‰â†â”€â”€ M5.2-3 â”€â”€â”˜
```

æœ€é•¿è·¯å¾„ï¼šM5.2-1 â†’ M5.2-2 â†’ M5.2-3 â†’ M5.2-6

å¹¶è¡Œæœºä¼šï¼š
- M5.2-4ï¼ˆautonomy + Tool Useï¼‰å’Œ M5.2-5ï¼ˆå‰ç«¯ï¼‰å¯åœ¨ M5.2-3 å®Œæˆåå¹¶è¡Œ
- M5.2-5 çš„ types.ts / api.ts æ‰©å±•å¯åœ¨ M5.2-2 æœŸé—´æå‰å¼€å§‹ï¼ˆæ¥å£å¥‘çº¦å…ˆå®šï¼‰

### M5.2 éªŒæ”¶æ ‡å‡†

å¯¹åº” IR ä¸­ AC-M5.2-01 ~ AC-M5.2-20ï¼ŒæŒ‰ Phase åˆ†ç»„ï¼š

**Phase 1ï¼ˆæ•°æ®å±‚ + åç«¯æœåŠ¡ + APIï¼ŒM5.2-1 ~ M5.2-3ï¼‰**
- [ ] æ•°æ®è¿ç§»æˆåŠŸï¼šAgentResource.quantity ä¸º Floatï¼Œfrozen_amount å­—æ®µå­˜åœ¨ï¼ŒMarketOrder/TradeLog è¡¨å­˜åœ¨
- [ ] æŒ‚å•ï¼šèµ„æºå†»ç»“æ­£ç¡®ï¼Œå–å•çŠ¶æ€ open
- [ ] æ¥å•ï¼šå…¨é‡/éƒ¨åˆ†è´­ä¹°èµ„æºäº¤æ¢æ­£ç¡®ï¼ŒçŠ¶æ€ partial/fulfilled
- [ ] æ’¤å•ï¼šå†»ç»“é€€å›æ­£ç¡®ï¼ŒçŠ¶æ€ cancelled
- [ ] è¾¹ç•Œæ ¡éªŒï¼šæœ€å°å•ä½ã€ä½™é¢ä¸è¶³ã€è‡ªä¹°ã€è¶…é‡ã€éå–å®¶æ’¤å•
- [ ] å¹¶å‘å®‰å…¨ï¼šä¸è¶…å–

**Phase 2ï¼ˆautonomy + Tool Use + å‰ç«¯ï¼ŒM5.2-4 ~ M5.2-5ï¼‰**
- [ ] autonomy_loop æ”¯æŒ create_order / accept_order å†³ç­–
- [ ] Tool Use æ³¨å†Œ create_market_order / accept_market_order å·¥å…·
- [ ] å‰ç«¯äº¤æ˜“å¸‚åœºåŒºå—ï¼šæŒ‚å•åˆ—è¡¨ã€åˆ›å»ºæŒ‚å•ã€ä¹°å…¥ã€æ’¤å•ã€æˆäº¤å†å²
- [ ] WebSocket å®æ—¶æ¨é€ order_created/order_traded/order_cancelled

**Phase 3ï¼ˆé›†æˆéªŒè¯ï¼ŒM5.2-6ï¼‰**
- [ ] 20 ä¸ª AC åœºæ™¯ ST å…¨éƒ¨é€šè¿‡

---

## å…³é”®å†³ç­–æ±‡æ€»

| å†³ç­– | ç»“è®º | æ¥æº |
|------|------|------|
| Agent å›å¤æ¶æ„ | æ–¹æ¡ˆGï¼ˆOpenClaw SDK + å°è£…å±‚ï¼‰2:1 æŠ•ç¥¨ | [Agentæ¶æ„æ–¹æ¡ˆ](è®¨è®ºç»†èŠ‚/Agentæ¶æ„æ–¹æ¡ˆ.md) |
| å”¤é†’æœºåˆ¶ | ä¸‰çº§å”¤é†’ï¼ˆ@å¿…å”¤ + å°æ¨¡å‹é€‰äºº + å®šæ—¶ï¼‰ | [å”¤é†’æœºåˆ¶](è®¨è®ºç»†èŠ‚/å”¤é†’æœºåˆ¶.md) |
| äººæ ¼ç³»ç»Ÿ | è‡ªç„¶è¯­è¨€ + JSON å…ƒæ•°æ®æ··åˆ | [Agentäººæ ¼ç³»ç»Ÿ](è®¨è®ºç»†èŠ‚/Agentäººæ ¼ç³»ç»Ÿ.md) |
| ç»æµç³»ç»Ÿ | ä¿¡ç”¨ç‚¹ + æ¸¸æˆå¸åŒè´§å¸ | [ç»æµç³»ç»Ÿ](è®¨è®ºç»†èŠ‚/ç»æµç³»ç»Ÿ.md) |
| è®°å¿†æ•°æ®åº“ | SQLite + LanceDB æ··åˆ | PRD 2:1 æŠ•ç¥¨ |
| äººç±»ç”¨æˆ·èº«ä»½ | Human Agent (id=0) | è¯„å®¡æ¾„æ¸… |
| å‰ç«¯ UI | Discord/Slack é£æ ¼ï¼ŒDeveloper è‡ªç”±å‘æŒ¥ | è¯„å®¡æ¾„æ¸… |
| ç»æµæ£€æŸ¥ | ä¸¤æ­¥åˆ†ç¦»ï¼šé€‰äººé¢„æ£€æŸ¥ï¼ˆåªè¯»ï¼‰+ å‘é€æ‰£å‡ï¼ˆå†™å…¥ï¼‰ | QA åå‘ä¸²è®² |
