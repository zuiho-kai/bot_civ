# R5 脑暴纪要 — M6.3 议题 5：调度架构（规则前置 + Glance/Think + 事件风暴防护）

> 日期：2026-02-21
> 阶段：M6.3 阶段 0 五方脑暴
> 参与：Architect / Tech Lead / QA Lead / Developer / Human Proxy PM
> 轮次：2 轮（第 1 轮各自方案 + 第 2 轮分歧聚焦）

---

## 议题 5：autonomy_loop 调度架构重构

### 背景

议题 4 拍板取消固定 tick，改为 Agent 自定闹钟 + Attention Gate（Glance/Think 两阶段）。原计划的"议题 5 纯适配层"已不适用，autonomy_loop 需要从"固定 tick 遍历所有 Agent"重写为"事件驱动 + 闹钟队列 + Glance/Think 两阶段"。

### 讨论的 6 个子议题

1. 调用链拓扑（规则引擎 vs Glance vs wakeup 的职责边界）
2. Glance 实现策略（规则 vs LLM vs 分阶段）
3. 事件分类（硬触发 / 硬忽略 / 模糊区）
4. 事件优先级排序
5. 事件风暴防护
6. 可观测性 MVP 指标

### 第 1 轮共识（5/5 一致）

1. **调用链拓扑**：社交事件走 wakeup_service 快通道（直接入 Think 队列头部），非社交事件走 Event Filter 规则引擎分流。两条路径职责正交不重叠
2. **事件三类处理**：硬触发（mentioned_in_chat / daily_settle / unpaid_wage）直接 Think；硬忽略（自己触发 / 冷却期重复）直接丢弃；模糊区（market_price / new_job_posted / resource_below / building_completed）需 Glance 判断
3. **Glance 分阶段**：Phase 1 规则 Glance（纯规则 YES/NO，零 LLM 成本），Phase 2 升级 LLM Glance
4. **事件风暴三层防护**：L1 debounce 同类 5min 合并 → L2 优先级队列 Think≤5 超出排队不丢弃 urgent 插队 → L3 熔断降级队列超阈值收紧 Glance
5. **Think 并发上限 5**
6. **MVP 分期**：Phase 1 规则引擎+规则 Glance+Think 队列+next_check_in+埋点；Phase 2 LLM Glance+wake_conditions 精细化+强制 Think 保底
7. **工程约束**：Think 队列放内存重启从 DB 重建；wakeup 分流点在 chat.py 入口层；next_check 防御（类型+行为）；假阴性率目标生存类 0% 整体≤2%；wakeup P99≤30s；社交保底唤醒上限 30min

### 第 1 轮分歧

**分歧 A：事件优先级排序**

| 方案 | 提出者 | 内容 |
|------|--------|------|
| 方案 1：双层方案 | Architect | 系统层（生存危机 > 被@ > daily_settle）+ 调度层（社交 > 协作 > 环境 > 经济 > 定时），两层职责清晰 |
| 方案 2：极简方案 | Developer | P0（被@/daily_settle/resource_below 立即）+ P1（其余全部排队不细分），一个布尔判断 |
| 方案 3：双维度方案 | PM | 紧急度（生存 > 社交 > 经济 > 环境 > 定时）+ 响应时效（被@/生存→冷却豁免），两维交叉 |

**分歧 B：可观测性 MVP 指标数量**

| 方案 | 提出者 | 数量 |
|------|--------|------|
| 交集 3 项 | 五方共识 | Think 队列深度/等待时长、端到端响应延迟、熔断触发次数 |
| 6 项 | TL + Architect | 交集 + 规则层拦截率 + Think 调用次数/天 + Glance YES/NO 比率 |
| 8 项 | QA | 6 项 + 假阴性率 + 事件丢弃/超时次数 |
| 4 项 | Developer | 最精简，很多可从其他指标反推 |

### 第 2 轮（分歧聚焦）

第 2 轮只针对两个分歧点展开讨论，各方进一步阐述理由但未完全收敛，提交用户拍板。

### 用户拍板

**分歧 A：选方案 1（Architect 双层方案，工程简化版）**

用户理由：
1. **单层 P0/P1 会产生结构性偏差** — P1 内部无排序，高峰期变成先到先服务的随机系统，产生调度噪声（经济决策延迟不稳定、协作经常排队、行为风格不可预测）。这不是复杂度问题，而是系统性偏置问题
2. **PM 双维度在 MVP 阶段过度抽象** — 冷却豁免等于再叠一层状态机，没有真实运行数据无法验证收益。冷却豁免可由系统层兜底覆盖
3. **双层方案把问题分成两个正交空间** — 系统层（Bug 防线，规则极少）+ 调度层（体验排序，一个 priority 数字 + heap），工程代价极低，可扩展、不随机、不过度抽象、不依赖 LLM

**分歧 B：选 6 项（TL + Architect 方案）**

用户理由：
1. **4 项看不到过滤层是否失控** — 规则层拦截率从 60% 掉到 20% 时完全不知道，token 爆炸才发现过滤失效
2. **8 项中假阴性率在 MVP 无法准确测量** — 没有 ground truth、没有离线回放、没有人工标注，现在埋只是假指标。事件丢弃/超时可从队列深度和延迟推算
3. **6 项是信息闭环的最小集合** — 能回答：是否拥塞？是否过度调用？是否过滤失效？是否发生保护？

### 已拍板共识项

**DC-28：调用链拓扑 — 规则前置 + 社交/非社交分流**
- 背景：事件源多样（聊天/市场/闹钟/系统），需要统一入口分流
- 决策：社交事件→wakeup_service（快通道，直接入 Think 队列头部）；非社交事件→Event Filter（规则引擎）→硬触发直接 Think / 硬忽略丢弃 / 模糊区→Glance→Think

**DC-29：Glance 分阶段实现**
- 背景：LLM Glance 有成本，MVP 阶段模糊区事件有限，可先用规则覆盖
- 决策：Phase 1 规则 Glance（纯规则 YES/NO，零 LLM）；Phase 2 升级 LLM Glance（返回 should_think + urgency 1-5 + reason）

**DC-30：事件分类 — 三类处理**
- 背景：不是所有事件都值得 Think，需要分层过滤
- 决策：硬触发（mentioned_in_chat/daily_settle/unpaid_wage）；硬忽略（自己触发/冷却期重复）；模糊区（market_price/new_job_posted/resource_below/building_completed）

**DC-31：事件优先级 — 双层方案（工程简化版）**
- 背景：多事件同时触发时 Think 队列需要排序
- 决策：系统层（生存危机 > 被@ > daily_settle，不可丢失）；调度层（社交 > 协作 > 环境 > 经济 > 定时，priority 数字 heap 排序）。不引入多维冷却模型

**DC-32：MVP 分期**
- 背景：完整调度架构复杂度高，需要分期交付
- 决策：Phase 1 规则引擎+规则 Glance+Think 并发队列(≤5)+next_check_in+6 项埋点；Phase 2 LLM Glance+wake_conditions 精细化+强制 Think 保底+高级可观测性

**DC-33：事件风暴三层防护**
- 背景：资源刷新+多人对话+价格波动可能同时产生大量事件
- 决策：L1 debounce 同类 5min 合并；L2 优先级队列 Think≤5 超出排队不丢弃 urgent 插队；L3 熔断降级队列超阈值收紧 Glance

**DC-34：可观测性 MVP 6 项指标**
- 背景：事件驱动架构需要可观测性验证调度效果
- 决策：Think 队列深度、Think 平均等待时长、端到端响应延迟、规则层拦截率、Think 调用次数/天、熔断触发次数

**DC-35：关键工程约束**
- 背景：五方讨论中产出的工程边界条件
- 决策：Think 队列放内存重启从 DB 重建；wakeup 分流点在 chat.py 入口层；next_check 防御（类型+行为）；假阴性率目标生存类 0% 整体≤2%；wakeup P99≤30s；社交保底唤醒上限 30min
