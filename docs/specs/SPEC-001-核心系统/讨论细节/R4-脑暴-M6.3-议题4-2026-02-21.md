# R4 脑暴纪要 — M6.3 议题 4：tick 缩短 + 意图识别触发

> 日期：2026-02-21
> 阶段：M6.3 阶段 0 五方脑暴
> 参与：Architect / Tech Lead / QA Lead / Developer / Human Proxy PM
> 外部输入：GPT-4o / Claude Opus（用户主动咨询）

---

## 议题 4：tick 缩短 + 意图识别触发（P6）

### 背景

当前系统每 1 小时 batch tick 一次所有 Agent（每天 24 次决策机会）。Agent 对世界变化反应迟钝——有人在聊天群喊"卖小麦"，最多要等 1 小时才能响应。IR 草稿提出：
- 缩短 tick 间隔（1h → 15min）
- 新增意图识别：聊天中涉及经济行为时，立即触发相关 Agent 单独决策

### 议题 1-3 已拍板约束
- 每天只能工作一次（DC-15）
- 副业递增消耗限制 3-4 次/天
- 0 点统一换日结算
- 聊天群发言免费，游戏内正式发言消耗 energy -1

### 第 1 轮各角色观点

- **Architect**：15 分钟 tick 成本增长 4 倍（480→1920 次/天），大部分是无效 rest。建议 30 分钟折中。意图触发只唤醒相关 Agent（有资源的 seller + 有需求的 buyer）。snapshot 缓存 5 分钟复用。
- **Tech Lead**：LLM 成本增加 4 倍但有效行为没增加。建议分层 tick（高优 15min / 普通 1h）或行为队列（一次规划多个 action）。tick_single_agent 实现复杂度中等（约 100 行代码）。snapshot 构建约 80ms（10 Agent）。
- **QA Lead**：96 次/天测试状态空间爆炸。daily_* 函数隔离是关键风险（如果误放到 tick 循环里，Agent 每 15 分钟衰减一次会饿死）。意图识别准确率目标 ≥90%，trade_intent 召回率 ≥95%。
- **Developer**：建议混合方案（定时 1h + 事件触发）。tick_single_agent 需要完整 snapshot（Agent 需要看到其他人的状态）。冷却时间可配置。daily_* 用独立 cron 表达式与 tick 分离。
- **Human Proxy PM**：符合"Agent 行为响应实时世界状态"愿景。成本控制用免费模型。100 条/日免费发言合理（每 14.4 分钟 1 条，与 tick 频率匹配）。

### 第 1 轮共识（5/5 一致）

1. 15 分钟 tick 成本过高，大部分是无效 rest
2. 意图识别方向正确，复用 wakeup-model 做意图分类
3. JSON 解析失败 fallback 为 chat
4. 宁可误触发不要漏触发（trade_intent 误判为 chat 比反过来更严重）
5. snapshot 缓存 5 分钟复用
6. 冷却时间可配置

### 第 2 轮融合

**分歧 1：tick 间隔**
- 方案 C（定时 1h + 事件触发）：PM、Developer、QA 支持（3/5）
- 方案 D（15 分钟 + rest 不调 LLM）：Architect、Tech Lead 支持（2/5）
- 用户拍板：**选方案 D（15 分钟 tick）**

**分歧 2：冷却时间** — 已收敛
- 5/5 一致：统一 5 分钟 + 触发队列

**分歧 3：rest 优化** — 已收敛后被推翻
- 第 2 轮 5/5 一致倾向"属性安全时自动 rest 不调 LLM"
- 用户质疑：属性安全不等于没事做（可能要交易、打工、社交）
- 修正轮 4/5 一致：**放弃自动 rest 跳过 LLM**，让 LLM 自己决策
- 成本控制靠：免费模型 + snapshot 缓存 + prompt 引导

### 外部输入：GPT-4o + Claude Opus 观点

用户将问题带到外部大模型咨询，获得以下关键洞察：

**核心认知纠正**：
> "你现在让 LLM 去确认'没事发生'。这个确认本来不应该用 LLM。"
> "每 15 分钟强制做一次完整 LLM 决策 = 假设人类每 15 分钟都会做一次完整理性规划。这不符合真实行为模式。"
> "那不是公民，那是 cron job。"

**方案 1：两阶段决策（Attention Gate + Deliberation）**
- 阶段 1 — Glance（轻量扫一眼）：用极短 prompt + snapshot diff，让 Agent 快速判断"需要重新规划吗？YES/NO"。token 极少，成本约完整决策的 1/10~1/20
- 阶段 2 — Think（完整决策）：只有 Glance 返回 YES 时才跑完整 snapshot + 决策
- 预期：Glance 过滤掉 60-70% 无效调用

**方案 2：Agent 自己定闹钟（Agent-Declared Schedule）**
- LLM 决策后返回 `next_check_in_minutes`（下次醒来时间）+ `wake_conditions`（唤醒条件列表）
- 例如："2 小时后叫我，除非有人喊我、或者出现矿工招聘、或者小麦价格跌到 8 以下"
- wake_conditions 用预定义类型（价格阈值、招聘出现、被 @、库存变化等），Agent 选择并填参数
- 系统只是"忠实的闹钟 + 通知服务"

**方案 3：组合架构**
```
Agent 做完一次完整决策
  → 返回 action + next_check_in + wake_conditions
  → Agent 进入"睡眠"

等待唤醒（两种路径）：
  路径 A：到了 next_check_in 时间
  路径 B：某个 wake_condition 被系统事件匹配到

被唤醒后：
  → 跑 Glance（轻量 LLM，问"要不要重新想？"）
  → NO → 继续睡，重置 next_check_in
  → YES → 跑完整 Think 决策
  → 返回新的 action + next_check_in + wake_conditions
```

**保底机制**：最大睡眠时间 2 小时，防止 Agent "睡死"

**预期效果**：
- 完整 LLM 调用从 1920 次/天降到 200~500 次/天
- Glance 调用非常便宜
- 有重大经济波动时自动高频
- 完全不限制自主性
- 没有硬编码"什么时候 rest"

### 补充评审：Attention Gate + 自定闹钟方案

外部输入（GPT/Opus）提出的方案提交五方评审，结果如下：

**评审结果（3:2 分歧）**：

| 角色 | 立场 | M6.3 能装下？ | 核心观点 |
|------|------|---------------|----------|
| Architect | 支持 | 能，分 P6.1/P6.2 | 新增 3 个模块（attention_scheduler / glance_service / wake_condition_matcher），wake_conditions 初始 15 种优先做 5 个核心 |
| Tech Lead | 支持 | 能但建议分期 | 复杂度约 450 行核心代码，比简单 tick 复杂 4 倍，但收益显著（成本降 70-80%）。建议 M6.3 P1 简单方案 → P2 升级 |
| QA Lead | 有条件支持 | 装不下 | 测试场景爆炸（20 Agent × 10 wake_conditions × 5 事件 = 1000 组合），建议 M6.4 |
| Developer | 有条件支持 | 装不下 | 改 5 个文件 + 3 个函数 + 2 个字段，M6.3 已有 7 个 Phase |
| PM | 强烈支持 | 能 | 范式升级，完美体现"LLM 自主感知"核心愿景 |

**五方共识（5/5 一致）**：
1. 方案方向正确，是范式升级而非优化
2. wake_conditions 用预定义类型（枚举 + 参数），不是自由文本
3. Glance 误判 fallback：解析失败 → 默认 YES（跑完整决策，宁可多调用不要漏）
4. Agent 输出格式错误 fallback：默认 next_check_in=60, wake_conditions=["mentioned_in_chat"]
5. next_check_in 硬限制上限 120 分钟，防止睡死
6. 保底机制：连续 3 次 Glance NO 后强制跑一次完整 Think

**分歧**：是否 M6.3 做（PM/Architect 支持）还是延后 M6.4（TL/QA/Dev 建议）

**用户拍板：M6.3 做。** 与议题 1-3 零冲突，唯一注意点是 daily_settle（0 点换日）事件需接入 wake_condition 触发。

### 反思（DEV-50）

本议题暴露了脑暴流程的锚定效应问题：所有人被 IR 草稿"tick 从 1h 改 15min"锚定，4 轮讨论都在"间隔选多少"框架内优化，无人质疑"定时 tick 本身是否正确"。最终由外部输入（GPT/Opus）点破。

已落盘流程改进：debate-workflow.md 新增"第 1 轮必须包含前提挑战"卡点（DEV-50）。

### 已拍板共识项

**DC-19（v2）：取消固定 tick，改为 Agent 自定闹钟 + Attention Gate**
- 背景：固定 15 分钟 tick = 假设人类每 15 分钟做一次完整理性规划，不符合真实行为模式。让 LLM 确认"没事发生"本身就是浪费
- 决策：Agent 每次决策后返回 `next_check_in_minutes`（5~120 分钟）+ `wake_conditions`（预定义类型列表）。系统按时间或事件匹配唤醒 Agent。唤醒后先跑 Glance（轻量 LLM，YES/NO），YES 才跑完整 Think 决策
- 废弃原 DC-19（15 分钟固定 tick）

**DC-20：意图识别触发机制（保留）**
- 背景：聊天中涉及经济行为时，等下一个定时 tick 太慢
- 决策：复用 wakeup-model 做 4 种意图分类（chat / trade_intent / hire_intent / negotiate），非 chat 意图作为 wake_condition 触发路径之一。JSON 解析失败 fallback 为 chat

**DC-21：统一 5 分钟冷却 + 触发队列（保留）**
- 背景：防止同一 Agent 被频繁触发
- 决策：同一 Agent 5 分钟内只触发 1 次。冷却期间的触发请求进队列，冷却结束后立即执行最新一条。冷却时间可配置

**DC-22（v2）：Glance 做轻量预判，替代硬编码 rest 跳过**
- 背景：原 DC-22 拍板"不做 rest 跳过"，但外部输入指出问题不是"跳不跳"而是"谁来判断"。硬编码规则限制自主性，但让完整 LLM 确认"没事"是浪费
- 决策：用 Glance（轻量 LLM，约 200 tokens）做预判。Glance 只问"需要重新规划吗？YES/NO"。NO → 继续睡；YES → 跑完整 Think。Glance 误判 fallback：解析失败默认 YES
- 废弃原 DC-22（不做 rest 跳过）

**DC-23：snapshot 缓存 5 分钟复用（保留）**
- 背景：唤醒 + 意图触发会增加 snapshot 构建频率
- 决策：全局信息（市场挂单、建筑列表、招聘信息）缓存 5 分钟，Glance/Think 时复用

**DC-24：免费发言额度 100 条/日（保留）**
- 背景：Agent 更活跃后发言需求增加。聊天群发言免费（不调 LLM），游戏内正式发言消耗 energy -1
- 决策：每 Agent 每日 100 条免费发言

**DC-25：wake_conditions 初始类型清单**
- 背景：Agent 自定闹钟需要预定义可订阅的事件类型
- 决策：M6.3 实现以下 8 种核心类型：
  1. `mentioned_in_chat` — 被 @ 或名字出现在消息中
  2. `market_price_below(resource, threshold)` — 资源价格低于阈值
  3. `market_price_above(resource, threshold)` — 资源价格高于阈值
  4. `new_job_posted` — 有新招聘信息
  5. `building_completed(building_id)` — 自己的建筑完工
  6. `resource_below(resource, threshold)` — 个人资源低于阈值
  7. `unpaid_wage` — 工资未到账
  8. `daily_settle` — 0 点换日结算完成（全员唤醒）

**DC-26：Glance prompt 设计**
- 背景：Glance 需要让 Agent 快速判断"世界有没有值得我思考的变化"
- 决策：不记录完整世界状态，只展示"自上次决策以来的变化"：
  - 属性变化（health/energy/satiety/mood 增减）
  - 新增市场挂单（前 3 个）
  - 新增招聘（前 3 个）
  - 聊天摘要（最近 5 条）
  - 库存变化（增减超过 5 的资源）
- Glance prompt 约 200 tokens，只问"需要重新规划吗？YES/NO"
- Agent 表新增 `last_decision_snapshot`（JSON）记录上次决策时的关键指标，用于构建 diff

**DC-27：fallback 与保底机制**
- 背景：LLM 输出不可控，需要兜底
- 决策：
  - Agent 输出格式错误（缺 next_check_in 或 wake_conditions）→ 默认 60 分钟 + `["mentioned_in_chat"]`
  - next_check_in 超出范围（<5 或 >120）→ clamp 到 [5, 120]
  - wake_conditions 包含未知类型 → 过滤掉未知，保留已知
  - Glance 返回非 YES/NO → 默认 YES（跑完整决策）
  - 连续 3 次 Glance NO → 强制跑一次完整 Think
  - 保底最大睡眠 2 小时（即使 Agent 没设 wake_conditions）

### 待脑暴：议题 5 — autonomy_loop 调度架构重构

议题 4 拍板 Attention Gate + 自定闹钟后，原计划的"议题 5 纯适配层"已不适用。autonomy_loop 需要从"固定 tick 遍历所有 Agent"重写为"事件驱动 + 闹钟队列 + Glance/Think 两阶段"。以下问题需要五方脑暴：

1. **三个新模块的职责边界和接口**：attention_scheduler（闹钟队列管理）/ glance_service（轻量预判）/ wake_condition_matcher（事件匹配引擎）各自负责什么？与现有 autonomy_service / scheduler 的关系是重构还是新建？
2. **Glance 用哪个模型**：复用现有 wakeup-model（已有意图分类能力）？还是单独配 glance-model？成本差异、延迟差异、准确率影响？
3. **wake_conditions 数量**：DC-25 拍板 8 种，但 Architect 建议 15 种、Developer 建议先做 3 种。8 种是否合适？`market_price_above` 和 `resource_below` 在 M6.3 经济初期是否用得上？
4. **LLM 输出格式扩展**：Agent 决策从 `[{action, params, reason}]` 变成 `[{action, params, reason, next_check_in_minutes, wake_conditions}]`，影响 prompt 设计和所有 action handler 的解析逻辑，需要定义新的输出 schema
