# R2 脑暴纪要 — M6.3 议题 2：副业系统 + 建筑配方改造

> 日期：2026-02-21
> 阶段：M6.3 阶段 0 五方脑暴
> 参与：Architect / Tech Lead / QA Lead / Developer / Human Proxy PM

---

## 议题 2：副业系统（P2）+ 建筑配方改造（P3）

### 背景

当前系统建材（wood/stone）无来源，只能靠 dev API 注入。Agent 无法自主获取建材，经济循环转不起来。IR 草稿提出：
- P2：副业系统（gather 采集 + process 加工），消耗递增逼 Agent 转向建筑
- P3：建筑配方改造（farm/mill 用新物资），新增 sawmill（锯木厂）

### 议题 1 已拍板约束
- 采集类 action 不设体力门槛（或极低 ≥5），作为自救通道
- fruit 采集量给大
- energy 直接启用

### 各角色观点

- **Architect**（有条件支持）：模块划分合理，新建 side_job_service.py。采集概率表用常量字典配置化。建议手工加工效率降低（3 wood→1 plank），拉大与 sawmill 的差距。关注 production_tick 是否支持输入消耗型建筑。
  论据：手工 50% 效率 vs sawmill 66.7% 差距不够明显，应改为 33.3% vs 66.7%。

- **Tech Lead**（有条件支持）：技术可行。发现 fruit 25%×2~3 不够"给大"，建议提高到 40% 或数量 3~5。副业消耗递增速率可能太快（第 3 次 25 体力）。建议 gather 改为不消耗体力或极低消耗，符合自救通道定位。
  论据：采集本身消耗精力，如果采不到 fruit 补精力会卡死。

- **QA Lead**（有条件支持）：AC 覆盖不足，缺少随机分布验证、消耗递增溢出保护、破坏性变更迁移方案。需要补充统计学验证 AC 和原子操作保证。
  论据：第 100 次副业消耗 510 体力，溢出风险；farm max_workers 改小后存量工人处理未定义。

- **Developer**（有条件支持）：实现复杂度可控。建议 gather 产出量固定化（每次 1 单位，类型随机）减少测试复杂度。process 不递增消耗。farm 只改成本不改 max_workers，避免存量迁移。
  论据：双重随机（类型+数量）增加测试复杂度；max_workers 改动是破坏性变更。

- **Human Proxy PM**（支持）：方向完全正确，直击"建材无来源"痛点。从零到第一个 farm 约 4~5 天，路径长度可接受。关注 LLM 能否理解多步规划（采集→攒资源→建造）。建议 world_snapshot 显示"距离建造 X 还差什么"。
  论据：20 Agent 规模下资源竞争合理，先建 farm 的人有先发优势，后来者可以应聘打工，经济分化自然涌现。

### ⚠️ 少数派/附加条件

1. **Developer 独立观点**：gather 产出量固定为 1 单位（不随机数量），只随机类型。其他四方未明确支持。
2. **Developer 独立观点**：farm 不改 max_workers，只改建造成本。Architect/Tech Lead 倾向"不追溯存量但新建用新值"。
3. **Architect 独立观点**：手工加工改为 3 wood→1 plank（降低效率拉大差距）。其他四方未讨论。
4. **Tech Lead 独立观点**：gather 改为不消耗体力（只消耗精力），与议题 1"采集不设体力门槛"对齐。

### 结论

5/5 支持或有条件支持。全员认可副业系统方向和模块划分，分歧集中在数值平衡和破坏性变更处理。

### 共识项

1. 副业系统新建 side_job_service.py，不塞 city_service（5/5 一致）
2. _get_or_create_agent_resource 提升为公共函数，避免循环依赖（3/5 明确提出，无人反对）
3. 采集概率表用常量字典配置化，风格与 BUILDING_RECIPES 一致（5/5 一致）
4. sawmill 先用 if 分支实现，不过度抽象（4/5，Developer/Tech Lead/Architect 明确）
5. 配方改造只影响新建建筑，不追溯存量（多数倾向，QA 要求明确迁移策略）
6. fruit 采集量需要调大，当前 25%×2~3 不够"给大"（3/5 明确提出）
7. 验收标准需要大幅补充（QA 提出 8 条补充 AC）
8. world_snapshot 需要显示副业计数和建筑配方需求（Human Proxy PM 提出）
9. 完整生产链无循环依赖（Architect 验证）

### 分歧项（已拍板）

**DC-6：gather 是否消耗体力**
- 结果：**方案 A（IR 草稿）+ 修正议题 1 约束**
- 消耗体力+精力，递增（保持 IR 草稿设计）
- 撤回议题 1"采集不设体力门槛"结论，改为：体力 < 20 时无法采集，但其他 Agent 可通过赠送食物/资源帮助恢复
- 设计意图：体力耗尽 = 需要社交求助，逼出协作行为（施舍、雇佣、交易），团体互助才是生存之道

**DC-7：apple 采集概率和数量**
- 结果：**方案 D 微调（低概率大丰收）**
- 15% 概率，5~10 个，期望 1.125/次
- 采到一次够分给好几个人，促进社交分享
- 附带改名：fruit → apple，stamina → health（健康值）

**DC-8：farm max_workers 是否改为 1**
- 结果：**方案 A（改为 1）**
- 没上线无存量数据，直接改
- 单 farm 产能有限，想规模化就得建多个或雇人

**DC-9：手工加工效率**
- 结果：**手工 4 wood→1 plank（25%），sawmill 2 wood→1 plank（50%）**
- sawmill 产能：30 wood→15 plank/人/日，max_workers=2
- 手工效率极低，只是应急手段

**DC-10：side_job_count 重置方式**
- 结果：**方案 A（0 点统一换日结算）**
- 借鉴 Civ 换日概念，一个定时任务（daily_settlement）0 点触发
- 按顺序处理：四维衰减/恢复 → side_job_count 重置 → 建筑产出 → 工资结算 → 聊天额度重置 → 不满度结算

**DC-11：process 是否递增消耗**
- 结果：**方案 A（共享 side_job_count 递增）**
- process 与 gather 共享递增，初期效率最差，后期基本不会再手工加工

### 附带新增决策

| 项目 | 决策 |
|------|------|
| stamina 改名 | → health（健康值） |
| fruit 改名 | → apple |
| 新增 lumber_camp（伐木场） | stone 10 + plank 5，10 人日，max_workers=2，15 wood/人/日 |
| 工期单位 | 统一为人日（man-day），多人建造可加速，小数向上取整 |
| 换日结算 | 0 点一个定时任务统一处理所有每日逻辑 |
| 技能熟练度系统 | → M7 遗留（学徒→匠人→大师，影响产能） |

### 更新后采集概率表

| 物资 | 概率 | 数量 | 期望/次 |
|------|------|------|---------|
| wood | 40% | 2~4 | 1.2 |
| stone | 30% | 1~3 | 0.6 |
| apple | 15% | 5~10 | 1.125 |
| grain | 15% | 1~2 | 0.225 |

### 更新后建筑参数表

| 建筑 | 配方 | 工期（人日） | max_workers | 产出 |
|------|------|-------------|-------------|------|
| farm | grain 5 + plank 3 | 3 | 1 | 10 wheat/人/日 |
| mill | stone 8 + plank 5 | 5 | 2 | 5 wheat→3 flour/人/日 |
| sawmill | stone 10 | 4 | 2 | 30 wood→15 plank/人/日 |
| lumber_camp | stone 10 + plank 5 | 10 | 2 | 15 wood/人/日（无输入） |

### 更新后完整生产链

```
副业采集 → wood / stone / apple / grain
                        ↓
lumber_camp → 15 wood/人/日（规模化伐木）
                        ↓
手工: 4 wood → 1 plank（应急，25%效率）
sawmill: 2 wood → 1 plank, 15 plank/人/日（规模化，50%效率）
                        ↓
grain + plank → farm → 10 wheat/人/日
stone + plank → mill → 5 wheat → 3 flour/人/日
                        ↓
eat_flour: 饱腹+30, 心情+10, health+10, energy+5
eat_apple: energy+15, 心情+15, 饱腹+10, health+5
```
