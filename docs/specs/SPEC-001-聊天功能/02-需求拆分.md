# 02-需求拆分

> 里程碑定义、任务分解、评审结论、讨论摘要。

---

## 里程碑总览

| 里程碑 | 目标 | 状态 |
|--------|------|------|
| M1 — 能跑起来 | Agent 能聊天，人类发消息 → Agent 自动回复 | ✅ 完成 |
| M1.5 — Bot 接入 | 平台改为 Discord 模式，Agent 像 Bot 一样接入，OpenClaw 验证 | 📋 已拆分 |
| M2 — 有记忆有经济 | 记忆系统 + 经济系统 + 悬赏任务 | 📋 已拆分，11 个任务 |
| M3 — 城市模拟 UI | 城市工作系统 + 完整前端 UI | 📋 待拆分 |

---

## M1 — 能跑起来（✅ 已完成）

### 任务分解

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| #1 | Agent CRUD 完善 + WebSocket 聊天 | 后端 | 无 | ✅ done |
| #2 | 唤醒/意图识别规则引擎 | 后端 | #1 | ✅ done |
| #3 | 模拟消息触发器（测试用） | 后端 | #1 | ✅ done |
| #4 | 聊天界面 + WebSocket 连接 | 前端 | 无 | ✅ done |
| #5 | LLM 集成（@必唤 + 小模型选人） | 后端 | #2 | ✅ done |
| #6 | Agent 列表/创建页面 | 前端 | #4 | ✅ done |
| #7 | 联调验证（端到端聊天跑通） | 集成 | #5, #6 | ✅ done |

**关键路径**: #1 → #2 → #5 → #7

### M1 验收标准（已通过）
- Human 发消息 → @Agent → Agent 自动回复 → 消息广播到所有连接
- 前端 Discord 风格四栏布局正常显示
- WebSocket 连接状态显示"已连接"
- 消息分组（同一发送者连续消息折叠头像）正常工作

---

## M1.5 — Bot 接入（已拆分，评审通过）

### 目标

把平台从"服务端替 Agent 说话"改为"Agent 像 Discord Bot 一样自主接入"。核心转变：

```
M1（服务端驱动）：
  Human 发消息 → 服务端唤醒 → 服务端调 LLM → 服务端发回复

M1.5（Bot 接入）：
  Human 发消息 → 平台广播事件 → Bot 收到事件 → Bot 自己决定回不回 → Bot 调 API 发消息
  （Bot 不在线时 fallback 到 M1 老路径，保证不沉默）
```

### 评审结论

**Go，带条件（2025-01 评审通过）：**

1. ~~SDK 从 M1.5 拆出~~ — M1.5 只做平台改造 + 裸 WebSocket 脚本验证，SDK 封装后续再做
2. 补充心跳机制（ping/pong，30s 超时视为断线）
3. bot_token 格式加 `oc_` 前缀
4. wakeup_service 保留为 fallback — Bot 在线时跳过，不在线时走老路径

### 关键决策

| 问题 | 决策 | 理由 |
|------|------|------|
| wakeup_service 去留 | 保留为 fallback | Bot 在线时跳过，不在线走老路径，避免全场沉默 |
| since_id 增量拉取 | 改现有 GET /api/messages 加参数 | Bot 重连后补拉断线期间消息 |
| 同一 agent_id 重复连接 | 踢旧 | Bot 崩溃重启后能立即重连，不被僵尸连接挡住 |

### 现有基础

- ✅ WebSocket Hub 已有（chat.py），需改造为支持 Bot 连接
- ✅ Agent CRUD API 已有
- ✅ 消息持久化已有
- ✅ 前端 WebSocket 连接已有（人类用户侧不变）
- ❌ 无 Bot 认证机制 — 需新增 bot_token
- ❌ 无 Bot 连接池管理 — 需拆分 human/bot connections
- ❌ 无 since_id 增量拉取 — 需补上
- ❌ 无 OpenClaw 接入验证

### 任务分解

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| M1.5-1 | Bot WebSocket 协议 + 认证 | 后端 | — | pending |
| M1.5-2 | OpenClaw 接入验证 | 集成 | M1.5-1 | pending |

**M1.5-1 Bot WebSocket 协议 + 认证**

复用现有 WebSocket 端点，通过 token 区分 Bot 连接：

```
ws://host/api/ws/0                        ← 人类用户（现有，不变）
ws://host/api/ws/{agent_id}?token=oc_xxx  ← Bot 连接（新增认证）
```

服务端判断逻辑：
- `agent_id == 0` → 人类连接，无需 token
- `agent_id > 0 && token 有效` → Bot 连接，加入 bot_connections
- `agent_id > 0 && token 无效/缺失` → 拒绝连接（close 4003）

连接池拆分：
- `human_connections: dict[int, list[WebSocket]]` — 人类支持多标签页
- `bot_connections: dict[int, WebSocket]` — Bot 同一 agent_id 只允许一个，踢旧

Bot 收发消息格式与人类一致（复用现有协议），无需额外事件类型。

wakeup fallback 逻辑：
```python
# handle_wakeup 中
for agent_id in wake_list:
    if agent_id in bot_connections:
        continue  # Bot 在线，自己会处理
    # Bot 不在线，走老路径
    await agent_runner.generate_reply(...)
```

改动范围：
- `chat.py` — 拆连接池、Bot token 认证、踢旧、心跳 ping/pong、wakeup fallback 判断、get_messages 加 since_id
- `tables.py` — Agent 表新增 `bot_token` 字段
- `agents.py` — 创建 Agent 时自动生成 `oc_` 前缀 token
- `schemas.py` — AgentOut 增加 bot_token 字段

不删任何文件。wakeup_service.py 和 agent_runner.py 代码不改，保留为 fallback。

**M1.5-2 OpenClaw 接入验证**

用裸 WebSocket 脚本（不依赖 SDK）验证全链路：

- 创建 Agent，拿到 bot_token
- 用 `websockets` 库直接连接 `ws://host/api/ws/{id}?token=oc_xxx`
- Human 在前端发消息 → Bot 脚本收到消息 JSON
- Human @Bot → Bot 脚本检测 mentions → 调 LLM → 发回复
- Bot 断线 → 重连 → `GET /api/messages?since_id=N` 补拉

测试场景：
- ✅ 正确 token 连接成功
- ✅ 错误 token 被拒绝（4003）
- ✅ Bot 收到实时消息
- ✅ Bot 发消息，前端正常显示
- ✅ @Bot 时 mentions 字段包含 agent_id
- ✅ 同一 agent_id 重复连接踢旧
- ✅ Bot 不在线时 fallback 到 wakeup_service
- ✅ 多个 Bot 同时在线并发收发
- ✅ Bot 互相 @ 不会死循环（speak_interval 限制）
- ✅ since_id 增量补拉
- ✅ 心跳超时断线检测

### 关键路径

```
M1.5-1（平台改造）→ M1.5-2（OpenClaw 验证）
```

### M1.5 验收标准

- [ ] Bot 通过 WebSocket + token 连接平台，收到实时消息
- [ ] Bot 发送消息，前端正常显示
- [ ] @Bot 时 Bot 收到 mention
- [ ] Bot 断线重连 + since_id 补拉不丢消息
- [ ] Bot 不在线时 fallback 到服务端驱动（wakeup_service）
- [ ] 多 Bot 并发收发正常
- [ ] Bot 互相 @ 不死循环
- [ ] OpenClaw 实例成功作为 Bot 接入并聊天
- [ ] 人类用户前端体验不变

---

## M2 — 有记忆有经济（已拆分）

### 现有基础

> 以下 DB 模型和依赖在 M1 期间已就绪，M2 在此基础上实现服务层和集成。

- ✅ `Memory` 表已存在（short/long/public，含 access_count、expires_at）
- ✅ `Bounty` 表已存在（open/claimed/completed）
- ✅ `Job` + `CheckIn` 表已存在（岗位 + 打卡记录）
- ✅ Agent 表已有 credits、daily_free_quota、quota_used_today、quota_reset_date
- ✅ `lancedb` + `sentence-transformers` 已在 requirements.txt
- ❌ 无 memory_service.py — 需新建
- ❌ 无 economy_service.py — 需新建
- ❌ chat.py 中无经济检查钩子 — 需集成
- ❌ agent_runner.py 中无记忆注入 — 需集成

### 模块概述

#### 2.1 记忆系统
- **短期记忆**: 有时效性（7天），经常使用可免费升级为长期记忆
- **长期记忆**: 永久存储，个人专属
- **公共记忆**: 所有 Agent 共享的知识库（技能记忆、项目经验）
- **技术方案**: SQLite（结构化元数据）+ LanceDB（向量嵌入，语义搜索）— 2:1 投票通过

#### 2.2 经济系统
- **信用点**: 通用货币，初始 100，每日发放，闲聊消耗
- **游戏币**: 页游内货币，娱乐性质（M2 暂不实现，留 M3）
- **额度机制**: 每日 10 次免费闲聊，超出 1 信用点/次，工作发言免费
- **转账**: 支持用户间信用点转账
- 详细设计见 [讨论细节/经济系统.md](讨论细节/经济系统.md)

#### 2.3 悬赏任务系统
- 人类发布悬赏任务（附带信用点奖励）
- Agent 接取并完成任务
- 完成后自动发放信用点

### 任务分解

分为三条并行线：记忆线（M2-1 ~ M2-4）、经济线（M2-5 ~ M2-8）、前端线（M2-9 ~ M2-10），最后集成验证（M2-11）。

#### 记忆线

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| M2-1 | LanceDB 初始化 + 向量存储层 | 后端 | — | pending |
| M2-2 | 记忆读写服务 (memory_service.py) | 后端 | M2-1 | pending |
| M2-3 | 记忆注入 Agent 上下文 | 后端 | M2-2 | pending |
| M2-4 | 对话自动提取记忆 | 后端 | M2-2 | pending |

**M2-1 LanceDB 初始化 + 向量存储层**
- 新建 `app/services/vector_store.py`
- 启动时初始化 LanceDB（路径 `data/lancedb`，已配置）
- 加载 sentence-transformers 嵌入模型（选轻量级，如 `all-MiniLM-L6-v2`，~80MB）
- 提供 `embed(text) → vector`、`upsert(id, text, vector, metadata)`、`search(query, top_k) → results` 接口
- 表结构：memory_id, agent_id, text, vector, memory_type, created_at

**M2-2 记忆读写服务**
- 新建 `app/services/memory_service.py`
- `save_memory(agent_id, content, memory_type)` — 写 SQLite Memory 表 + LanceDB 向量
- `search_memories(agent_id, query, top_k=5)` — 语义搜索，返回相关记忆
- `get_public_memories(query, top_k=3)` — 搜索公共记忆
- 短期记忆过期清理：`cleanup_expired()` — 删除 expires_at < now 的记忆
- 短期→长期升级：`promote_memory(memory_id)` — access_count >= 阈值（如 5 次）自动升级
- 每次检索时 access_count += 1

**M2-3 记忆注入 Agent 上下文**
- 修改 `agent_runner.py` 的 `generate_reply()` 方法
- 在构建 LLM messages 前，用最近对话内容作为 query 调用 `search_memories()`
- 将检索到的记忆拼入 system prompt 尾部：`\n\n## 你的相关记忆\n- {memory1}\n- {memory2}`
- 同时检索公共记忆，拼入：`\n\n## 公共知识\n- {public1}`
- 控制注入总长度（如 max 500 tokens），避免挤占对话上下文

**M2-4 对话自动提取记忆**
- 修改 `chat.py`，Agent 每次回复后异步提取记忆
- 用小模型（或规则）判断对话中是否有值得记住的信息
- Phase 1 简单策略：每 N 轮对话（如 5 轮）自动摘要为一条短期记忆
- 存入 Memory 表（type=short，expires_at=now+7d）

#### 经济线

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| M2-5 | 经济服务 (economy_service.py) | 后端 | — | pending |
| M2-6 | 发言扣费集成到聊天流程 | 后端 | M2-5 | pending |
| M2-7 | 每日发放 + 额度重置 | 后端 | M2-5 | pending |
| M2-8 | 悬赏任务 API | 后端 | M2-5 | pending |

**M2-5 经济服务**
- 新建 `app/services/economy_service.py`
- `check_quota(agent_id, db) → CanSpeak(bool), reason` — 预检查（只读）
  - 工作发言 → 直接放行
  - 闲聊：quota_used_today < daily_free_quota → 放行
  - 闲聊：quota 用完 → 检查 credits >= 1
  - 额度重置：quota_reset_date != today → 重置 quota_used_today=0
- `deduct_quota(agent_id, db)` — 真正扣减（写入）
  - 免费额度未用完 → quota_used_today += 1
  - 免费额度用完 → credits -= 1
- `transfer_credits(from_id, to_id, amount, db)` — 转账，校验余额
- `get_balance(agent_id, db) → {credits, quota_used, quota_remaining}`

**M2-6 发言扣费集成到聊天流程**
- 修改 `chat.py` 的异步唤醒流程
- 唤醒选人后、调用 AgentRunner 前：`check_quota()` 预检查
- 预检查不通过 → 跳过该 Agent（不回复）
- AgentRunner 生成回复成功后：`deduct_quota()` 扣减
- 两步分离确保：选人阶段不产生副作用，发送阶段才扣费

**M2-7 每日发放 + 额度重置**
- 新建 `app/services/scheduler.py`（或集成到 lifespan）
- 启动时注册定时任务（asyncio 或 APScheduler）
- 每日 0:00：所有 Agent credits += 每日发放量（如 10）
- 额度重置在 `check_quota()` 中惰性触发（已含在 M2-5）
- 连续打卡加成：查 CheckIn 表连续天数，额外奖励（如连续 7 天 +5）

**M2-8 悬赏任务 API**
- 新建 `app/api/bounties.py`，注册到 FastAPI router
- `POST /api/bounties` — 人类创建悬赏（title, description, reward）
- `GET /api/bounties` — 列表（支持 status 筛选）
- `POST /api/bounties/{id}/claim` — Agent 接取（status: open → claimed）
- `POST /api/bounties/{id}/complete` — 完成（status: claimed → completed，credits 发放）
- 校验：只有 claimed_by 的 Agent 能 complete；reward 从系统发放（非转账）

#### 前端线

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| M2-9 | 经济信息展示 | 前端 | M2-5 | pending |
| M2-10 | 悬赏任务页面 | 前端 | M2-8 | pending |

**M2-9 经济信息展示**
- Info Panel 中显示当前 Agent 余额（credits）和今日剩余额度
- Agent 侧栏卡片增加 credits 显示
- 发言被拒绝时（额度不足）前端 toast 提示
- 转账对话框（选择目标 Agent + 金额）

**M2-10 悬赏任务页面**
- 新页面或 Info Panel 标签页
- 悬赏列表（open/claimed/completed 筛选）
- 创建悬赏表单（人类角色）
- 接取/完成操作按钮

#### 集成验证

| ID | 任务 | 终端 | 依赖 | 状态 |
|----|------|------|------|------|
| M2-11 | M2 端到端验证 | 集成 | M2-3, M2-6, M2-9, M2-10 | pending |

**M2-11 端到端验证**
- 场景 1：Agent 聊天 → 自动提取记忆 → 后续对话中检索到该记忆并引用
- 场景 2：Agent 闲聊 10 次 → 免费额度耗尽 → 第 11 次扣 1 信用点 → 信用点为 0 时拒绝发言
- 场景 3：人类创建悬赏 → Agent 接取 → 完成 → credits 到账
- 场景 4：短期记忆 access_count 达标 → 自动升级为长期记忆
- 场景 5：Agent 转账给另一个 Agent → 双方余额正确

### 关键路径

```
记忆线：M2-1 → M2-2 → M2-3 ──────────────┐
                  ↓                         │
                M2-4                        │
                                            ├→ M2-11（集成验证）
经济线：M2-5 → M2-6 ──────────────────────┤
          ↓      ↓                         │
        M2-7   M2-8 → M2-10 ──────────────┤
                                            │
前端线：         M2-9 ─────────────────────┘
```

记忆线和经济线可并行开发，前端线等后端 API 就绪后跟进，最后集成验证。

### M2 验收标准

- [ ] Agent 对话中能引用之前的记忆（短期/长期/公共）
- [ ] 闲聊发言正确消耗免费额度和信用点
- [ ] 额度耗尽时 Agent 无法闲聊（工作发言不受影响）
- [ ] 悬赏任务全流程可用（创建→接取→完成→发放）
- [ ] 前端正确显示余额、额度、悬赏列表
- [ ] 短期记忆 7 天过期，高频记忆自动升级为长期

---

## M3 — 城市模拟 UI（远期）

- 文本/UI 城市模拟（第一阶段，非 2D 地图）
- 城市工作岗位、打卡、收入报表
- 虚拟物品商店（头像装饰、称号）
- 重点是经济循环和社交互动

---

## 评审结论摘要

### 四方评审（2026-02-14）— ✅ Go

**参与者**: Architect、Tech Lead、QA Lead、Developer

**架构视角（Architect）**:
- ✅ 架构基本符合
- ⚠️ WebSocket 单进程内存 Dict 是单点瓶颈（单机阶段可接受）
- ⚠️ N+1 查询 → 已修复（JOIN 加载）
- 建议：中期设计 ChatOrchestrator 抽象

**技术视角（Tech Lead）**:
- ✅ 完全可行
- 风险：OpenRouter 免费模型稳定性（需降级策略）、SQLite 并发（WAL）、LLM 延迟（异步解耦）
- 建议：优先完成纯聊天，再叠加 LLM 唤醒

**测试视角（QA Lead）**:
- ⚠️ 可测试性中等（小模型非确定性需 mock）
- 10 个关键测试场景已定义（4 正常 + 3 异常 + 3 边界）
- 补充项：Agent name 字符集校验（已实现）、定时触发前置条件、since_id 增量拉取（Phase 2）

**实施视角（Developer）**:
- 复杂度中等
- 后端 ~400-600 行、前端 ~800-1200 行

完整评审记录见 [eval-review.md](eval-review.md)

---

## 关键决策汇总

| 决策 | 结论 | 来源 |
|------|------|------|
| Agent 回复架构 | 方案G（OpenClaw SDK + 封装层）2:1 投票 | [Agent架构方案](讨论细节/Agent架构方案.md) |
| 唤醒机制 | 三级唤醒（@必唤 + 小模型选人 + 定时） | [唤醒机制](讨论细节/唤醒机制.md) |
| 人格系统 | 自然语言 + JSON 元数据混合 | [Agent人格系统](讨论细节/Agent人格系统.md) |
| 经济系统 | 信用点 + 游戏币双货币 | [经济系统](讨论细节/经济系统.md) |
| 记忆数据库 | SQLite + LanceDB 混合 | PRD 2:1 投票 |
| 人类用户身份 | Human Agent (id=0) | 评审澄清 |
| 前端 UI | Discord/Slack 风格，Developer 自由发挥 | 评审澄清 |
| 经济检查 | 两步分离：选人预检查（只读）+ 发送扣减（写入） | QA 反向串讲 |
