# 唤醒机制最终方案 — 辩论 + 用户决策详细记录

**日期**：2025-02-14
**议题**：唤醒规则引擎细节 + 防止Agent对话死循环 + 随机聊天是否有价值
**参与者**：辩论者A、辩论者B、辩论者C、架构师、用户
**流程**：三方辩论 → 投票僵局 → 用户基于实战经验直接决策

---

## 背景和需求

用户有maibot实战经验，发现两个模型对上嘴后短期记忆激活值高导致死循环。需要设计一套唤醒机制，既能让Agent自然互动，又要防止无意义的对话循环。

核心问题：
1. 如何决定哪个Agent应该回复消息？
2. 如何防止两个Agent陷入死循环对话？
3. 随机闲聊是否有价值？

---

## 讨论过程

### 第一轮：三方立场陈述

**辩论者A（衰减计数器方案）**：
- 核心思路：使用 0.9^n 概率衰减机制
- 每次同一对Agent连续对话，回复概率按指数衰减
- 优点：简单直观，数学上可证明收敛
- 缺点：可能打断有价值的深度对话

**辩论者B（话题摘要+转移方案）**：
- 核心思路：小模型检测重复话题，主动转移话题
- 维护对话摘要，检测语义重复度
- 优点：保留有价值对话，只阻止无意义循环
- 缺点：需要额外的小模型调用，增加成本

**辩论者C（全局调度器方案）**：
- 核心思路：中央调度器硬性规则控制
- 设定硬性规则：同一对Agent连续对话不超过3轮
- 优点：规则明确，可预测性强
- 缺点：可能过于僵硬，缺乏灵活性

### 第二轮：投票结果

投票：1:1:1 交叉投票，无多数
- A投给B（认可话题检测的价值）
- B投给C（认可硬性规则的可靠性）
- C投给A（认可概率衰减的简洁性）

三方陷入僵局，都在向对方方案靠拢，但没有明确多数。

---

## 用户否决辩论方案

用户基于maibot实战经验，否决了所有辩论方案：

**否决理由**：
- 所有方案都是"调参方案"，本质上都在试图通过参数控制对话频率
- maibot经验表明：调参方案效果不好，容易出现边界情况
- 真正的问题不是"如何控制循环"，而是"为什么要让Agent随机闲聊"

**用户核心观点**：
> 发言机会珍贵，不应该让Agent乱水群

---

## 最终方案（用户决策）

### 核心原则
**发言机会珍贵，不乱水群**

### 三级唤醒机制

**1. @提及 → 直接唤醒（必定）**
- 用户或其他Agent明确@某个Agent时，该Agent必定被唤醒
- 这是最高优先级的唤醒方式

**2. 消息触发 → 小模型基于上下文选择唤醒谁（可选0个）**
- 当有新消息时，小模型分析上下文
- 小模型可以选择唤醒0个、1个或多个Agent
- 关键：**可以选择0个**，即不唤醒任何人

**3. 定时触发 → 初期1小时一次，小模型决定是否主动说话**
- 初期设定为1小时一次定时检查
- 小模型决定是否需要某个Agent主动发言
- 避免群聊长时间沉默

### 补充规则

**人类发言特殊处理**：
- 人类发言 = 工作发言，不受额度限制
- 人类发言只能由1个Agent回复（小模型选人）
- 避免多个Agent同时回复人类，造成混乱

**闲聊@提及特殊处理**：
- 被@者不一定回复（小模型判断）
- 如果是无意义的闲聊@，小模型可以选择不唤醒
- 进一步减少无价值对话

---

## 下一步行动

1. 实现小模型选人逻辑（基于上下文分析）
2. 实现定时触发机制（初期1小时）
3. 实现@提及的强制唤醒
4. 在经济系统中实现闲聊额度限制（免费10次，超出1点/次）
5. 后续根据实际运行情况调整定时触发频率

---

## 关键决策点

- ✅ 放弃所有"调参控制循环"方案
- ✅ 采用"小模型智能选人"方案
- ✅ 确立"发言机会珍贵"原则
- ✅ 人类发言只能1个Agent回复
- ✅ 定时触发初期1小时一次
