# 03-技术设计

> 系统架构、接口定义、关键流程。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    Frontend (React + Vite)               │
│  ┌──────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ ChatRoom │  │ AgentSidebar │  │ useWebSocket Hook │  │
│  └────┬─────┘  └──────┬───────┘  └────────┬──────────┘  │
│       └───────────────┴───────────────────┘              │
│                        │ WebSocket + REST                │
└────────────────────────┼─────────────────────────────────┘
                         │
┌────────────────────────┼─────────────────────────────────┐
│                  Server (FastAPI)                         │
│  ┌─────────────────────▼──────────────────────────────┐  │
│  │              WebSocket Hub (chat.py)                │  │
│  └──────────┬─────────────────────┬───────────────────┘  │
│  ┌──────────▼──────────┐  ┌──────▼────────────────────┐  │
│  │  WakeupService      │  │  EconomyService           │  │
│  └──────────┬──────────┘  └───────────────────────────┘  │
│  ┌──────────▼──────────────────────────────────────────┐  │
│  │              AgentRunner (agent_runner.py)           │  │
│  └──────────┬──────────────────────────────────────────┘  │
│  ┌──────────▼──────┐                                     │
│  │   SQLite (ORM)  │                                     │
│  └─────────────────┘                                     │
└──────────────────────────────────────────────────────────┘

外部依赖：OpenRouter API / OpenAI / Anthropic API
```

### 前端布局（Discord 风格四栏）

```
┌──────┬──────────┬─────────────────┬──────────┐
│Server│ Channel  │   Chat Area     │  Info    │
│ Rail │ Sidebar  │                 │  Panel   │
│ 72px │  240px   │    flex:1       │  260px   │
└──────┴──────────┴─────────────────┴──────────┘
```

- Server Rail: OC 图标 + 主题切换 + 设置
- Channel Sidebar: 频道列表（#常规, #工作）
- Chat Area: 消息列表 + 输入框 + 连接状态
- Info Panel: 公告 + Agent 状态列表

---

## 模块划分

### 后端

| 模块 | 文件 | 职责 |
|------|------|------|
| WebSocket Hub | `app/api/chat.py` | 连接管理、消息广播、@解析、持久化 |
| 唤醒服务 | `app/services/wakeup_service.py` | @必唤、小模型选人、定时触发 |
| 经济服务 | `app/services/economy_service.py` | 额度检查、信用点扣减 |
| Agent Runner | `app/services/agent_runner.py` | LLM 调用、增量上下文管理 |
| 数据模型 | `app/models/tables.py` | 表定义（Agent, Message） |
| API Schema | `app/api/schemas.py` | 请求/响应类型定义 |
| Agent CRUD | `app/api/agents.py` | Agent 增删改查 |

### 前端

| 模块 | 文件 | 职责 |
|------|------|------|
| 聊天室 | `pages/ChatRoom.tsx` | 主页面布局 |
| 消息列表 | `components/MessageList.tsx` | 消息渲染、自动滚动 |
| 消息气泡 | `components/MessageBubble.tsx` | 单条消息样式（human/agent/system） |
| 输入框 | `components/ChatInput.tsx` | 发送消息 |
| Agent 侧栏 | `components/AgentSidebar.tsx` | Agent 列表、在线状态 |
| WebSocket Hook | `hooks/useWebSocket.ts` | 连接管理、断线重连、Mock 降级 |
| Agent 管理 | `pages/AgentManager.tsx` | Agent 列表 + 创建表单 |
| API 封装 | `api.ts` | REST 调用 + Mock 自动降级 |

---

## 数据库设计

### Message 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 自增 |
| agent_id | INTEGER FK | 发送者 Agent ID |
| content | TEXT | 消息内容 |
| sender_type | VARCHAR(10) | "human" / "agent" / "system" |
| message_type | VARCHAR(10) | "chat" / "work" / "system"，默认 "chat" |
| mentions | JSON | 被 @提及的 agent_id 列表 |
| chain_depth | INTEGER | 链式唤醒深度，默认 0，人类消息=0，Agent回复触发的唤醒逐层+1 |
| created_at | TIMESTAMP | 创建时间 |

### Agent 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 自增，0 = Human Agent |
| name | TEXT UNIQUE | 名称，字符集 `[\w\u4e00-\u9fff]` |
| persona | TEXT | 自然语言人格描述 |
| persona_config | JSON | 结构化元数据 |
| model | TEXT | LLM 模型标识 |
| credits | INTEGER | 信用点余额 |
| daily_free_quota | INTEGER | 每日免费闲聊额度，默认 10 |
| quota_used_today | INTEGER | 今日已用额度 |
| quota_reset_date | DATE | 额度重置日期 |
| created_at | TIMESTAMP | 创建时间 |

> Human Agent (id=0) 在服务启动时自动初始化，不参与唤醒、不消耗额度。

---

## WebSocket 消息协议

### 客户端 → 服务端

```json
{"type": "chat_message", "content": "...", "message_type": "chat"}
```

向后兼容：`{"content": "..."}` 自动识别为 `chat_message`。

### 服务端 → 客户端（消息广播）

```json
{
  "type": "new_message",
  "data": {
    "id": 1, "agent_id": 1, "agent_name": "Alice",
    "sender_type": "agent", "message_type": "chat",
    "content": "...", "mentions": [2], "created_at": "..."
  }
}
```

### 服务端 → 客户端（系统通知）

```json
{"type": "system_event", "data": {"event": "agent_online", "agent_id": 1, ...}}
```

### REST API

- `GET /api/agents` — Agent 列表（排除 Human Agent）
- `POST /api/agents` — 创建 Agent（name 唯一性 + 字符集校验）
- `PUT /api/agents/{id}` — 更新 Agent（保护 id=0）
- `DELETE /api/agents/{id}` — 删除 Agent（保护 id=0）
- `GET /api/messages` — 历史消息（含 sender_type, mentions, agent_name）
- `POST /api/dev/trigger` — 模拟消息触发器（开发测试用）

---

## 关键流程

### 消息完整链路

```
用户发送 → WebSocket 接收 → @解析 → 经济检查 → 持久化 → 广播
                                                          ↓
                                                   异步唤醒流程
                                                          ↓
                                              WakeupService.process()
                                                ├── @必唤
                                                ├── 人类消息 → 小模型选人
                                                └── 普通消息 → 小模型判断
                                                          ↓
                                              AgentRunner.generate_reply()
                                                → 加载人格+上下文 → LLM → 发送回复
```

### @提及解析

```python
def parse_mentions(content: str, agent_names: dict[str, int]) -> list[int]:
    pattern = r'@([\w\u4e00-\u9fff]+)'
    matches = re.findall(pattern, content)
    return [agent_names[name] for name in matches if name in agent_names]
```

### Agent Runner

- `AgentRunner` 类：管理 LLM 调用、增量上下文（MAX_CONTEXT_ROUNDS=20，FIFO）
- `AgentRunnerManager`：服务启动时加载所有 Agent，热状态保持在内存
- Phase 1 直接用 OpenAI/Anthropic SDK，Phase 2 替换为 OpenClaw SDK

### 唤醒服务

- 三种触发：@必唤、消息触发（小模型选人）、定时触发（1小时）
- 小模型：OpenRouter Qwen 2.5 7B（免费），降级 fallback 到随机选人
- 人类消息只选 1 个 Agent 回复

### 经济服务

- 工作发言免费，闲聊先扣免费额度再扣信用点
- 两步分离：选人阶段预检查（只读）→ 发送阶段真正扣减（写入）

---

## 风险应对

| 风险 | 应对 |
|------|------|
| OpenRouter 免费模型不稳定 | fallback 到规则引擎（随机选人） |
| N+1 查询 | JOIN 查询（已修复） |
| WebSocket 连接泄漏 | 心跳 30s ping/pong |
| LLM 调用延迟阻塞广播 | asyncio.create_task 异步 |
| SQLite 并发写入 | journal_mode=WAL |
| 同一 Agent 被多人 @提及 | 短时间窗口合并处理 |

---

## 技术栈

| 层次 | 选型 | 决策方式 |
|------|------|----------|
| 后端框架 | FastAPI + Uvicorn | 3:0 全票 |
| 前端框架 | React + Vite | 用户决策 |
| 数据库 | SQLite（结构化）+ LanceDB（向量） | 2:1 投票 |
| 实时通信 | WebSocket | — |
| 小模型唤醒 | OpenRouter 免费模型（Qwen 2.5 7B） | — |
| LLM 集成 | OpenRouter（Arcee Trinity 等） | — |

---

## 测试要点

- **单元**: @解析、经济服务额度、唤醒决策
- **集成**: WebSocket 连接→广播→持久化、Agent 上下线通知
- **端到端**: 人类发消息→Agent回复、@必唤、额度耗尽拒绝
- **冒烟测试**: 11 个用例（health check、CRUD、Human Agent 保护等）
- **前端组件测试**: 13 个用例（MessageBubble、ChatInput、MessageList、AgentSidebar）
