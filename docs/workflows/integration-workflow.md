# 工作流 4：前后端联调流程（混合模式）

## 流程概览

```
=== 第一轮：独立开发（双终端） ===
前端终端：实施 web/ 目录任务，启动 Vite 验证前端功能
后端终端：实施 server/ 目录任务，启动 FastAPI 验证 API 接口
接口契约：以 docs/api-contract.md 为边界，各自确保单侧正常
    ↓
=== 第二轮：冒烟测试（单终端） ===
在任意终端（建议后端终端）:
    1. 启动后端服务（background）
    2. 启动前端服务（background）
    3. 快速验证核心流程是否跑通
    4. 记录发现的问题列表
    ↓
=== 第三轮：深度调试（按问题复杂度分流） ===

【简单问题 - 责任方明确】→ 单终端直接修复
例如：
  - 前端按钮点击没反应 → 明显前端问题 → 前端终端修复
  - 后端 API 404 → 明显后端问题 → 后端终端修复
    ↓
    在对应终端修改代码 → 热重载验证 → 完成

【复杂问题 - 跨层定位困难】→ 使用 Agent Team 联调
例如：
  - WebSocket 连接成功但消息收不到
  - 数据发送了但前端没更新
  - 权限验证失败但不确定哪一侧问题
    ↓
    创建 agent 团队（需提前启用 CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS）:

    """
    创建联调团队调试 [具体问题描述]：

    - 后端调试者：
      1. 检查 server/ 侧相关逻辑
      2. 添加日志验证数据流转
      3. 检查服务端状态（连接列表、数据库等）

    - 前端调试者：
      1. 检查 web/ 侧相关逻辑
      2. 检查浏览器控制台和网络请求
      3. 验证客户端状态（WebSocket 连接、组件状态等）

    - 协调者：
      1. 收集前后端调试日志
      2. 对比时间线定位断点
      3. 判断根因在哪一侧
      4. 分配修复任务给对应 agent
      5. 验证修复后端到端流程
      6. 更新 api-contract.md（如涉及接口变更）
      7. 更新 claude-progress.txt 记录问题和解决方案

    要求：
    - 前后端 agent 各自独立调试，互不干扰
    - 发现问题后汇报到共享任务列表
    - 协调者综合判断后做最终决策
    - 完成后必须清理团队资源
    """
    ↓
=== 第四轮：回归验证（单终端） ===
修复后在单终端验证完整流程
    ↓
📝 [记录员] 更新 claude-progress.txt
📝 [记录员] 踩坑写入 docs/runbooks/error-book.md
```

## Agent Team 使用规范（实验性功能）

### 何时使用 Agent Team

**适用场景**：
1. **跨层大功能**：需要前后端密切协作的功能（如完整的用户认证流程）
2. **竞争性假设调试**：Bug 原因不明，需多假设并行验证
3. **协作讨论自动化**：让 3 个 agent 自动执行讨论流程
4. **代码审查**：需要多角度（安全/性能/测试）同时审查

**不适用场景**：
1. 前后端职责清晰的独立任务 → 用双终端
2. 简单问题责任方明确 → 单终端直接修复
3. 顺序依赖强的链式任务 → 用 Subagents（Task 工具）

### 前置条件

在 `.claude/settings.local.json` 中添加：

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### 最佳实践

- ✅ **任务拆分清晰**：每个 agent 负责独立的文件集（避免同时编辑同一文件）
- ✅ **有状态资源单一管理**：端口、数据库文件、文件锁等只由一个角色负责启停，其他角色只调用不启动
- ✅ **启动前先检查**：启动服务前先 `curl localhost:PORT/health`，能通就不重复启动
- ✅ **提前批准权限**：在 settings.json 预批准常用操作（减少人工干预）
- ✅ **监控进度**：定期检查共享任务列表（Ctrl+T）
- ✅ **及时引导**：发现 agent 跑偏立即纠正（Shift+Up/Down 选中 + 发消息）
- ✅ **完成后清理**：清理团队 + `taskkill` 残留进程（避免遗留端口占用）
- ✅ **踩坑必记**：联调中遇到的问题写入 [错题本](../runbooks/error-book.md)，不写进度文件

### 已知限制

- ⚠️ 实验性功能，可能不稳定
- ⚠️ Token 成本高（多个 agent 同时运行）
- ⚠️ 文件冲突风险（需严格划分文件归属）
- ⚠️ 无法用 /resume 恢复 in-process 模式的队友
- ⚠️ 每个会话只能有一个团队
- ⚠️ 不支持嵌套（队友无法再派生自己的团队）

### 成本对比

| 模式 | Token 成本 | 协调成本 | 适用场景 |
|------|-----------|---------|---------|
| 双终端手动模式 | 中等 | 高 | 日常开发 |
| Agent Team | 高 | 低（自动化） | 疑难调试 |
| 单终端 | 低 | 高 | 简单任务 |

**推荐策略**：混合使用 - 日常开发用双终端，疑难调试用 Agent Team

## 双终端分工规则

- **后端终端**: 只改 `server/` 目录，负责 API、数据库、Agent 逻辑、LLM 集成
- **前端终端**: 只改 `web/` 目录，负责 React UI、WebSocket 客户端、页面交互
- **接口契约**: `docs/api-contract.md` 是前后端协作边界，改接口需要同步更新
- **共享文件**: `docs/`、`CLAUDE.md`、`claude-progress.txt` 两边都可以读，但写入时注意不要冲突
