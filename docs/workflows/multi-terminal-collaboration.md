# 多终端协作流程（五方评审结论 2026-02-20）

> 类比：Opus = SE/Senior 写 SR，Sonnet = 年轻员工/外包写 AR + 实施

## 任务分流规则（入口门禁）

| 条件 | 路径 | 示例 |
|------|------|------|
| ≤3文件 + 单模块 + 逻辑自明 | Opus 一条龙（SR+AR+代码） | P1.1（3文件150行） |
| ≥4文件 或 跨模块 或 涉及 DB/API 契约变更 | Opus 写 SR → Sonnet 写 AR + 实施 | P1.2（9文件跨前后端+DB） |

补充判断维度：文件数 + 模块耦合度 + 风险等级。4-8 文件看耦合度。

## SR 详细度标准（Opus 产出）

- **保留**：功能目标、接口契约（函数签名）、数据模型变更、关键约束、依赖关系、安全规则、配置项、测试用例列表、不改动文件表、参考文件表
- **可选**：消除歧义的伪代码（删掉后 Sonnet 仍能写对 → 该删）
- **禁止**：完整函数体（>10行）、具体 SQL、完整组件代码、方法内部注释
- **验证**：Sonnet 读完 SR 后还需做 ≥50% 设计决策 → SR 合格

## AR 标准（Sonnet 产出）

- 文件级改动清单（哪些文件，改什么）
- 函数签名 + 完整实现代码
- 测试用例设计
- 风险点识别
- 自检：不看 SR 能否直接编码？不能 = AR 不完整

## 并发策略

- 改同文件的 Phase 必须串行（如 P1.1 → P1.2 都改 autonomy_service.py）
- 独立模块的 Phase 可与其他 Phase 的设计阶段并行
- Phase 内 Task 串行（有依赖链）

## 分支策略

一 Phase 一分支（`feature/m6-p1.1`），ST 通过后 merge main，下一个 Phase 从最新 main 拉分支。

## 人类参与点（最小化）

| 卡点 | 必须/可选 | 说明 |
|------|----------|------|
| SR 确认 | 必须 | 防方向错误 |
| AR 确认 | 大任务必须，小任务可跳过 | 防 Sonnet 理解偏差 |
| ST 失败归因 | Sonnet 连续失败 2 次才介入 | 不让它盲目重试 |
| 代码冲突解决 | 必须 | 改同文件时人类决定优先级 |

## 流水线时间线（示例）

```
P1.1: Opus 一条龙 → merge main
                ↘ (并行) Opus 写 P1.2 SR
P1.2: 人类确认 SR → Sonnet AR+实施 → merge main
                ↘ (并行) Opus 写 Phase2 SR
Phase2: ...
```

## Sonnet 踩坑预警

- 模糊 SR → Sonnet 不会主动质疑，会自行脑补（危险）
- 多文件协调 → 容易漏改/改错依赖，AR 必须列文件清单
- 错误恢复弱 → 连续失败 2 次人类介入，不让盲目重试
- 文件冲突 → 需要重新理解上下文，冲突文件必须等前序 Phase 完成
